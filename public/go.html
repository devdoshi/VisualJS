<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" Content-Type="text/javascript; charset=utf-8" content="initial-scale=1.0, width=device-width, height=device-height, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta charset="UTF-8" />
<link rel="stylesheet" href="https://cdn.usebootstrap.com/bootstrap/4.1.3/css/bootstrap.min.css"></link>
<linkold rel="stylesheet" href="/js_libs/bootstrap4.1.3.css"></linkold>

<style>
#visualization {
width: 100%;
height: 50%;
border: 1px solid lightgray;
}
</style>




<script>

async function addToIpfs(sometext) {
    //debugger
    let ret = await ipfs.add(sometext)
    return ret
}
async function getIpfsHash(sometext) {
//debugger
    if (ipfs) {
        let ret = await ipfs.add(sometext)

        return ret.path
    } else {
        let resulthash = await postToYazzReturnJson(
            "/get_commit_hash_id",
            {text: sometext}
        )
        return resulthash.ipfsHash
    }
}


var saveCodeViaWebWorker = null
var worker = null;
var ipfs = null
var web3loaded = false
var disableAutoSave = false;
var pageInitialised = false
var executeOnPageLoad = null




async function onPageInitialized(doCode) {
    executeOnPageLoad = doCode
    if (pageInitialised) {
        await executeOnPageLoad()
        executeOnPageLoad = null
    }

//debugger
    let blob = new Blob([
        document.querySelector('#web_worker_1').textContent
    ], { type: "text/javascript" })

// Note: window.webkitURL.createObjectURL() in Chrome 10+.
    worker = new Worker(window.URL.createObjectURL(blob));
    worker.onmessage = function(e) {
        console.log("Received: " + e.data);
    }


    saveCodeViaWebWorker = async function(code, options) {
        worker.postMessage(
            {
                hostPort:       $HOSTPORT,
                host:           $HOST,
                code:           code,
                options:        options
            }
        );
    }
}





var visJsloaded = false
var useVisJs = async function() {
    if (!visJsloaded) {
        //debugger
        let loadVisJsScript = document.createElement('script');
        loadVisJsScript.src = "/js_libs/vis-timeline-graph2d.min.css";

        document.head.appendChild(loadVisJsScript);
        loadVisJsScript.onload = function () {
            try {
            } catch (error) {
            }
            visJsloaded = true
        };
    }
}





var ipfsServerloaded = false
var useIpfsServer = async function() {
    if (!ipfsServerloaded) {
        let promise = new Promise(async function(returnfn) {
            //debugger
            let loadIpfsServerScript = document.createElement('script');
            loadIpfsServerScript.src = "/js_libs/js_ipfs_server.js";

            document.head.appendChild(loadIpfsServerScript);
            loadIpfsServerScript.onload = function () {
                try {
                } catch (error) {
                    debugger
                }
                ipfsServerloaded = true
                returnfn()
            };
        })
        let ret = await promise
        return ret
    }
}






var visCssloaded = false
var useVisCss = async function() {
if (!visCssloaded) {
//debugger
let loadVisCssScript = document.createElement('script');
loadVisCssScript.src = "/js_libs/vis-timeline-graph2d.min.js";

document.head.appendChild(loadVisCssScript);
loadVisCssScript.onload = function () {
try {
} catch (error) {
}
visCssloaded = true
};
}
}



var useWeb3 = async function() {

if (!web3loaded) {
//debugger
let loadWeb3LibScript = document.createElement('script');
loadWeb3LibScript.src = "/js_libs/web3.min.js";

document.head.appendChild(loadWeb3LibScript);
loadWeb3LibScript.onload = function () {
//debugger
try {
window.ethereum.request({method: "eth_requestAccounts"});

web3 = new Web3(window.ethereum);


(async function () {

//await switchBlockchainNetwork('1')   //eth mainnet
//await switchBlockchainNetwork('97')   //binance testnet
//await switchBlockchainNetwork('80001')   //polygon testnet
await switchBlockchainNetwork(window.currentBlockchain)   //polygon testnet

})()


} catch (error) {

}
web3loaded = true
};
}
}

var ideToolsloaded = false
var useIdeTools = async function() {
if (!ideToolsloaded) {
//debugger
let promise = new Promise(returnfn => {
let loadIdeToolsLibScript = document.createElement('script');
loadIdeToolsLibScript.src = "/js_libs/idetools.js";
document.head.appendChild(loadIdeToolsLibScript);
loadIdeToolsLibScript.onload = function () {
try {
} catch (error) {
}
ideToolsloaded = true
returnfn()
};
})
let ret = await promise
}
}



var diffJsloaded = false
var useDiffJs = async function() {
if (!diffJsloaded) {
//debugger
let promise = new Promise(returnfn => {
let loadDiffJsScript = document.createElement('script');
loadDiffJsScript.src = "/js_libs/diff.js";
document.head.appendChild(loadDiffJsScript);
loadDiffJsScript.onload = function () {
try {
} catch (error) {
}
diffJsloaded = true
returnfn()
};
})
let ret = await promise
}
}







var d3loaded = false
var useD3 = async function() {
if (!d3loaded) {
//debugger
let promise = new Promise(returnfn => {
let loadD3LibScript = document.createElement('script');
loadD3LibScript.src = "/js_libs/d3.js";
document.head.appendChild(loadD3LibScript);
loadD3LibScript.onload = function () {
try {
} catch (error) {
}
d3loaded = true
returnfn()
};
})
let ret = await promise
}
}



let signMessageTemplate =   "Hi there from Yazz. Sign this message " +
"to prove you have access to this wallet " +
"and we'll log you in. This won't cost " +
"you any Ether." +
"\n\n" +
"To stop hackers using your wallet, here's " +
"a unique message ID they can't guess: "

var chartsJsloaded = false
var useChartsJs = async function() {

if (!chartsJsloaded) {
//debugger
let promise = new Promise(returnfn => {
let loadChartsJsLibScript = document.createElement('script');
loadChartsJsLibScript.src = "/js_libs/charts.js";

document.head.appendChild(loadChartsJsLibScript);
loadChartsJsLibScript.onload = function () {
//debugger
try {


} catch (error) {

}
chartsJsloaded = true
returnfn()
};

})


let ret = await promise

}
}







var estraverseloaded = false
var useEstraverse = async function() {

if (!estraverseloaded) {
//debugger
let promise = new Promise(returnfn => {
let loadEstraverseScript = document.createElement('script');
loadEstraverseScript.src = "/js_libs/estraverse1.7.1.js";

document.head.appendChild(loadEstraverseScript);
loadEstraverseScript.onload = function () {
//debugger
try {
} catch (error) {
}
estraverseloaded = true
returnfn()
};
})


let ret = await promise

}
}






var esCodeGenLoaded = false
var useEsCodeGen = async function() {
if (!esCodeGenLoaded) {
//debugger
let promise = new Promise(returnfn => {
let loadEsCodeGenScript = document.createElement('script');
loadEsCodeGenScript.src = "/js_libs/escodegen.js";

document.head.appendChild(loadEsCodeGenScript);
loadEsCodeGenScript.onload = function () {
//debugger
try {
} catch (error) {
}
esCodeGenLoaded = true
returnfn()
};
})


let ret = await promise

}
}









var tabulatorJsLoaded = false
var useTabulatorJs = async function() {

if (!tabulatorJsLoaded) {
//debugger
let promise = new Promise(returnfn => {
let loadTabulatorJsLibScript = document.createElement('script');
loadTabulatorJsLibScript.src = "/js_libs/tabulator.js";

document.head.appendChild(loadTabulatorJsLibScript);
loadTabulatorJsLibScript.onload = function () {
//debugger
try {


} catch (error) {

}
tabulatorJsLoaded = true
returnfn()
};

})


let ret = await promise

}
}


function filterBlockchainParams(blockchainDetails) {
return {
chainId: blockchainDetails.chainId,
chainName: blockchainDetails.chainName,
rpcUrls: blockchainDetails.rpcUrls,
blockExplorerUrls: blockchainDetails.blockExplorerUrls,
nativeCurrency: blockchainDetails.nativeCurrency
}
}
window.currentBlockchain = "1"
window.blockchainIds = {
'0': 'kardia',
'1': {chainId: '0x1',chainName:'Ethereum - Mainnet',rpcUrls:['https://mainnet.infura.io/v3/'],blockExplorerUrls:['https://etherscan.io'],nativeCurrency: {symbol:'ETH',decimals: 18}},
'4': {chainId: '0x4',chainName:'Ethereum - Rinkby test net',rpcUrls:['https://rinkeby.infura.io/v3/'],blockExplorerUrls:['https://rinkeby.etherscan.io'],nativeCurrency: {symbol:'ETH',decimals: 18}, faucet: "https://rinkebyfaucet.com/"},
'8': 'ubiq',
'10': 'optimism',
'19': 'songbird',
'20': 'elastos',
'25': 'cronos',
'30': {
chainId: '0x1e',
chainName:'rsk - mainnet',
rpcUrls:["https://public-node.rsk.co"],
blockExplorerUrls:['https://explorer.rsk.co'],
nativeCurrency: {symbol:'RBTC',decimals: 18}
},
'31': {
chainId: '0x1f',
chainName:'rsk - testnet',
rpcUrls:["https://public-node.testnet.rsk.co"],
blockExplorerUrls:['https://explorer.testnet.rsk.co'],
nativeCurrency: {symbol:'RBTC',decimals: 18},
faucet: "https://faucet.rsk.co",
preMinedUrl: "https://explorer.testnet.rsk.co/address/",
postMinedUrl: ""
},
'40': {chainId: '0x28',chainName:'telos - mainnet',rpcUrls:['https://mainnet.telos.net/evm'],blockExplorerUrls:['https://teloscan.io'],nativeCurrency: {symbol:'TLOS',decimals: 18},
faucet: "https://app.telos.net/testnet/developers"},
'41': {
chainId: '0x29',
chainName:'telos - testnet',
rpcUrls:["https://testnet.telos.net/evm"],
blockExplorerUrls:['https://testnet.teloscan.io'],
nativeCurrency: {symbol:'TLOS',decimals: 18},
faucet: "https://app.telos.net/testnet/developers"
},
'52': 'csc',
'55': 'zyx',
'56': 'binance',
'57': 'syscoin',
'60': 'gochain',
'61': 'ethclassic',
'66': 'okexchain',
'70': 'hoo',
'82': 'meter',
'88': 'tomochain',
'97': {chainId: '0x61',chainName:'Binance Smart Chain - Testnet',rpcUrls:['https://data-seed-prebsc-1-s1.binance.org:8545'],blockExplorerUrls:['https://testnet.bscscan.com'],nativeCurrency: {symbol:'BNB',decimals: 18}},
'100': 'xdai',
'106': 'velas',
'108': 'thundercore',
'122': 'fuse',
'128': 'heco',
'137': 'polygon',
'200': 'xdaiarb',
'246': 'energyweb',
'250': {chainId: '0xFA',chainName: 'Fantom Opera Mainnet',rpcUrls:['https://rpc.ftm.tools/'],blockExplorerUrls:['https://ftmscan.com'],nativeCurrency: {symbol:'FTM',decimals: 18}},
'269': 'hpb',
'288': 'boba',
'321': 'kucoin',
'336': 'shiden',
'361': 'theta',
'592': 'astar',
'820': 'callisto',
'888': 'wanchain',
'1088': 'metis',
'1284': 'moonbeam',
'1285': 'moonriver',
'2020': 'ronin',
'4689': 'iotex',
'5050': 'xlc',
'5551': 'nahmii',
'8217': 'klaytn',
'10000': 'smartbch',
'32659': 'fusion',
'42161': 'arbitrum',
'421611': {
chainId: '0x66EEB',
chainName:'arbitrum - testnet',
rpcUrls:["https://rinkeby.arbitrum.io/rpc"],
blockExplorerUrls:['https://rinkeby-explorer.arbitrum.io/#/'],
nativeCurrency: {symbol:'ETH',decimals: 18},
faucet: "https://docs.theanthill.io/how-to/getting-bnb-on-binance-smart-chain-bsc-testnet"
},
'42220': 'celo',
'42262': 'oasis',
'43114': 'avalanche',
'71394': 'godwoken',
'80001': {chainId: '0x80001',chainName:'Mumbai Testnet',rpcUrls:['https://rpc-mumbai.maticvigil.com'],blockExplorerUrls:['https://polygonscan.com'],nativeCurrency: {symbol:'MATIC',decimals: 18},
faucet: "https://faucet.polygon.technology"},
'333999': 'polis',
'1313161554': 'aurora',
'1666600000': 'harmony',
'11297108109': 'palm',
'836542336838601': 'curio'
}
async function switchBlockchainNetwork(blockchainId) {

const provider = window.ethereum;
if(!provider){
console.log("Metamask is not installed, please install!");
}
let chainId = await provider.request({ method: "eth_chainId" });
if (chainId === window.blockchainIds[blockchainId].chainId) {
console.log("Bravo!, you are on the correct network");
} else {
console.log("oulalal, switch to the correct network")
}

try {
await provider.request({
method: "wallet_switchEthereumChain",
params: [{ chainId: window.blockchainIds[blockchainId].chainId}],
});
console.log("You have succefully switched to Binance Test network")
} catch (switchError) {
// This error code indicates that the chain has not been added to MetaMask.
if (switchError.code === 4902) {
console.log("This network is not available in your metamask, please add it")
}
console.log("Failed to switch to the network")
try {
await provider.request({
method: 'wallet_addEthereumChain',
params: [
filterBlockchainParams(window.blockchainIds[blockchainId])
]
});
} catch (addError) {
console.log(addError);
return false
}
}
return true

}



var testObject = null; // Use this to test elements at debug time
/*use_local_sqlite_start*/let localAppshareApp = false/*use_local_sqlite_end*/
/*edit_app_share_app_start*/let editAppShareApp = null/*edit_app_share_app_end*/








var yz = {

    insertCodeString: function(code,st, vall ,optionalEnd) {
        var endIndicator = ")"
        if (optionalEnd) {
            endIndicator = optionalEnd
        }
        var findd = st + "("
        var startIndexOfComment = code.toString().indexOf("/*")
        var startIndexOfFn = code.toString().indexOf("{")

        if (startIndexOfFn != -1) {
            if (startIndexOfComment == -1) {
                code = code.toString().substring(0,startIndexOfFn + 1) + "\n/*\n*/\n" +
                    code.toString().substring(startIndexOfFn + 1)
                startIndexOfComment = code.toString().indexOf("/*")
            }
            code = code.toString().substring(0,startIndexOfComment + 3) +
                "" + st + "(" + JSON.stringify(vall,null,2).replace(new RegExp("\\*\\/", 'g'), "*\\/") + endIndicator + "\n" +
                code.toString().substring(startIndexOfComment + 3)

        }

        return code

    },






    deleteCodeString: function(code,st ,optionalEnd) {
        var endIndicator = ")"
        if (optionalEnd) {
            endIndicator = optionalEnd
        }
        var findd = st + "("
        var codeStart = code.toString().indexOf(findd)
        if (codeStart != -1) {
            var codeEnd = codeStart + code.toString().substring(codeStart).indexOf(endIndicator)

            code = code.toString().substring(0,codeStart) +
                code.toString().substring(codeEnd + 1 + endIndicator.length)

            return code
        }
        return code
    },



    getValueOfCodeString: function(code, st,optionalEnd) {
        var endIndicator = ")"
        if (optionalEnd) {
            endIndicator = optionalEnd
        }
        var toFind = st + "("
        if (code.toString().indexOf(toFind) != -1) {
            var codeStart = code.toString().indexOf(toFind) + toFind.length
            var codeEnd = codeStart + code.toString().substring(codeStart).indexOf(endIndicator)

            code = code.toString().substring(codeStart, codeEnd)
            var val = eval( "(" + code.toString() + ")")
            return val

        }
        return null
    }
}











/* -----------------------------------------------------------------------
GLOBALS
----------------------------------
There seems to be alot of specialised, but global communication in the
app editors. So instead of having global variables all over the place
we have decided to just have one global object
 ----------------------------------------------------------------------- */
var GLOBALS = {
    //
    // This is used to jump from editing an app to editing a UI control and back again
    //
    editingAppBaseComponentId:                  null,   // Type (BCI) of the currently edited component
    editingAppCodeId:                           null,   // Commit ID for the currently edited component
    lastEditingAppBaseComponentId:              null,   // if we jump to edit another component save this
    lastEditingAppCodeId:                       null,   // if we jump to edit another component save this

    //
    // This is used when we have edited a UI control and want to jump back to the app and update the control
    // that was edited in the app
    //
    originalFormIdOfEditedUiControl:            null,
    originalNameOfEditedUiControl:              null,
    originalBaseComponentIdOfEditedUiControl:   null,
    originalCodeIdOfEditedUiControl:            null,
    finalBaseComponentIdOfEditedUiControl:      null,
    finalCodeIdOfEditedUiControl:               null,

    //
    // This is a map from the UI control name to the corresponding Vue object
    // for the controls in an edited app
    //
    // so {aaa: -> Vue object, mycontrolname: -> vue object}
    //
    designModeUiControlNameReturnsVueInstance: {},

    //
    // Which controls are used only in the currently edited app.
    // This is used so that we know what controls to embed if we
    // export the app as HTML
    //
    loadedControlsMapInCurrentlyEditedApp: new Object(),




    //
    // This points to the Vue objects for the components in an app
    //
    runtimeUiControlNameReturnsVueInstance: {},





    //
    // A list of loaded libs for an app
    //
    libLoaded: new Object(),



    //
    // If the Yazz server is current online with internet access
    //
    online: false,

    //
    // If this app is loaded as a HTML page and possibly without a Yazz server running
    // DO NOT change this line as it is dynamically replaced by code
    //
    isStaticHtmlPageApp: false,



    //
    // current base_component_id of the app being run
    // This can confuse people as when editing an app the "base_component_id" is
    // set to "homepage" as that is the main app being run. The editor is run on
    // top of that
    //
    base_component_id_of_main_runtime_component: null,




    //
    // properties on UI components where the output of one property is linked to
    // the input of another property
    //
    linkedProperties: new Object(),




    //
    // This contains the engines that allows components to be decorated at
    // run time, which means that their source code can be minimal. Originally
    // this allowed us to take the large .yazz Application files which were
    // often 300-400k in size, and shrink them to a few k. This is possible
    // because most of that code was Javascript engine code. By taking this
    // engine code out of the components also allows us to more easily swap
    // out Vue.js for something else in the future as well, if needed. Right
    // now (as of March 2023) we have to move things to an engine model
    // because otherwise we end up with duplication of edits in the engine
    // and the example apps
    //
    runtimePipelines: new Object(),

//zzz

    getPipelineCodeFromServer: async function(fileName) {
        let resultsCode = await postToYazzReturnJson(
            "/get_pipeline_code",
            {
                pipelineFileName:  fileName
            })

        return resultsCode.value
    }
    ,




    /*
    ________________________________________
    |                                      |
    |       getPipelineCodeToCopy                  |
    |                                      |
    |______________________________________|
    Function description
    __________
    | PARAMS |______________________________________________________________
    |
    |     args
    |     ----
    |________________________________________________________________________ */
    getPipelineCodeToCopy: async function(args) {
        let codeToCopy = null
        if (GLOBALS.runtimePipelines[args.pipelineName]) {
            codeToCopy = GLOBALS.runtimePipelines[args.pipelineName].code
        } else {
            if (args.pipelineName == "APP") {

                GLOBALS.runtimePipelines[args.pipelineName] = {}
                GLOBALS.runtimePipelines[args.pipelineName].code = await GLOBALS.getPipelineCodeFromServer("runtimePipelineYazzApp.js")
                GLOBALS.runtimePipelines[args.pipelineName].json = eval("(" + GLOBALS.runtimePipelines[args.pipelineName].code + ")")
            }

            codeToCopy = GLOBALS.runtimePipelines[args.pipelineName].code
        }

        let stt = args.fromMarker
        let editorCodeToCopyStart = codeToCopy.indexOf(stt)
        if (editorCodeToCopyStart == -1){
            throw "Can't find start"
        }
        editorCodeToCopyStart += stt.length
        let editorCodeToCopyEnd = codeToCopy.indexOf(args.toMarker)
        let editorCodeToCopy = codeToCopy.substring(editorCodeToCopyStart, editorCodeToCopyEnd)

        return editorCodeToCopy
    }
    ,





    //----------------------------------------------------
    // CODE CACHES
    //----------------------------------------------------

    getCommitIdForBaseComponentId: function (baseComponentId) {
        if (baseComponentId) {
            return GLOBALS.baseComponentIdReturnsCommitId[ baseComponentId ]
        }
    }
    ,


    getCodeForComponent: function(args) {
        let codeId = args.codeId
        if (!codeId) {
            if (args.baseComponentId) {
                codeId = GLOBALS.baseComponentIdReturnsCommitId[args.baseComponentId]
            }
        }


        if (codeId) {
            if (GLOBALS.codeCache[codeId]) {
                return GLOBALS.codeCache[codeId].code
            }
        }
        throw "getCodeForComponent: Can't find code for {" + JSON.stringify(args,null,2) + "}"
        return null
    }
    ,



    getLibsForCommit: function(args) {
        return []
        if (args.codeId) {
            if (GLOBALS.codeCache[args.codeId]) {
                return GLOBALS.codeCache[args.codeId].libs
            }
        }
    }
    ,


    getControlPropertyDefns: function(args) {
        if (args.baseComponentId) {
            return GLOBALS.codeCache[GLOBALS.getCommitIdForBaseComponentId(args.baseComponentId)].properties
        }
    }
    ,




    isComponentTypeCached: function(baseComponentId) {
        if (baseComponentId) {
            if (GLOBALS.getCommitIdForBaseComponentId(baseComponentId)) {
                return true
            }
        }
        return false
    }
    ,




    isComponentLoaded: function(args) {
        let codeId = null
        if (args.codeId) {
            codeId = args.codeId
        } else if (args.baseComponentId) {
            codeId = GLOBALS.baseComponentIdReturnsCommitId[args.baseComponentId]
        }
        if (codeId) {
            if (GLOBALS.codeCache[codeId]) {
                if (GLOBALS.codeCache[codeId].uiComponentLoaded) {
                    return true
                }
            }
        }
        return false
    }
    ,

    setComponentLoaded: function(args) {
        let previousCodeId          = null
        let previousCachedCode      = null
        let previousBaseComponentId = null
        let codeId                  = null

        if (args.codeId) {
            codeId = args.codeId
        } else if (args.baseComponentId) {
            codeId = GLOBALS.baseComponentIdReturnsCommitId[args.baseComponentId]
        }

        if (codeId) {
            previousCachedCode = GLOBALS.codeCache[  codeId  ]
            if (previousCachedCode) {
                previousBaseComponentId = GLOBALS.codeCache[  codeId  ].base_component_id
                if (previousBaseComponentId) {
                    previousCodeId = GLOBALS.baseComponentIdReturnsCommitId[  previousBaseComponentId  ]
                    if (previousCodeId) {
                        if (GLOBALS.codeCache[previousCodeId]) {
                            GLOBALS.codeCache[previousCodeId].uiComponentLoaded = false
                        }
                    }
                }
            }
        }


        if (codeId) {
            if (GLOBALS.codeCache[codeId]) {
                if (GLOBALS.codeCache[codeId].uiComponentLoaded) {
                    return true
                }
            }
        }
        return false
    }
    ,





    getTypeForCommitId: function(codeId) {
        return GLOBALS.codeCache[codeId].base_component_id
    }
    ,




    getDbToUse: function(args) {
        let useDb =  null
        let codeId = args.codeId
        if (!codeId ) {
            codeId = GLOBALS.getCommitIdForBaseComponentId(args.baseComponentId)
        }
        if (!codeId ) {
             return args.baseComponentId
        }

        if (codeId)
        {
            if (!GLOBALS.codeCache[codeId]) {
                return useDb
            }

            if (GLOBALS.codeCache[codeId].use_db) {
                useDb =  GLOBALS.codeCache[codeId].use_db
            } else {
                useDb = GLOBALS.getTypeForCommitId(args.codeId)
                let codeFor = GLOBALS.getCodeForComponent({codeId: args.codeId})
                let useOtherDb = yz.getValueOfCodeString(codeFor, "use_db")
                if (useOtherDb) {
                    useDb = useOtherDb
                }
                GLOBALS.codeCache[codeId].use_db = useDb
            }
        }
        return useDb
    }
    ,






    getAllLoadedTypeNames: function() {
        return Object.keys(GLOBALS.baseComponentIdReturnsCommitId)
    }
    ,


    cacheThisComponentCode: function(args) {
        let baseComponentId = yz.getValueOfCodeString(args.code, "base_component_id")

        GLOBALS.baseComponentIdReturnsCommitId[baseComponentId] = args.codeId


        //
        // Add the components code
        //
        GLOBALS.codeCache[   args.codeId  ] = {
            code:               args.code,
            code_id:            args.codeId,
            component_type:     "SYSTEM",
            base_component_id:  baseComponentId
        }

        let properties = yz.getValueOfCodeString(args.code, "properties",")//properties")
        if (isValidObject(properties)) {
            GLOBALS.codeCache[   args.codeId  ].properties   = properties
        } else {
            GLOBALS.codeCache[   args.codeId  ].properties   = []
        }
    }
    ,

    pointBaseComponentIdAtCode: function(args) {
        GLOBALS.baseComponentIdReturnsCommitId[  args.baseComponentId  ] = args.codeId
    }
    ,



    //
    // This contains the source code for a particular commit ID
    //
    // eg:    value: {
    //                    "async fn {... code here ... }"
    //                    }
    //  codeCache["QmVyCWHKJuc5am1jK1y4RrsBv7cEeztmMtWSKdt2YcUkMZ"]  =
    //  {
    //      code:               mm.editor_text,
    //      component_type:     "SYSTEM",
    //      libs:               [],
    //      code_id:            mm.code_id,
    //      base_component_id:  baseCompIdFromSrcCode
    //  }
    //
    codeCache: new Object(),


    //
    // maps the base component ID to the commit ID
    // "Qm0x43FFE338..2F1" < - points to a commit ID
    //
    baseComponentIdReturnsCommitId: new Object(),
}












var localSqliteDb    = null
var networkIntranetIpAddress    = null


var file_upload_uuid = null
var base_component_id = null
var queuedResponses = new Object()
var queuedBrowserResponseSeqNum = 0
var componentCallsListArgsSent = new Object()
var uiDebuggerOn = false
var saveCodeToFile = null

var isWin = null

var executionCode       = new Object()
var currentTimelineLogPoint = 0
var maxTimelineLogPoint = 0
var startTimelineTop    = 0
var executionTimeline   = []
var executionTimelineMapTimeToLine   = {}
var globalWatchList   = {}

</script>

<script>
//SQLITE
</script>

<script>
let sqlitedata = ''
</script>


<script>
//***ADD_SCRIPT
</script>



<script>

/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/jsondiffpatch@0.4.1/dist/jsondiffpatch.umd.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("./empty")):"function"==typeof define&&define.amd?define(["exports","./empty"],e):e(t.jsondiffpatch={},t.chalk)}(this,function(t,e){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e;var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},i=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),o=function t(e,n,r){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,n);if(void 0===i){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,r)}if("value"in i)return i.value;var a=i.get;return void 0!==a?a.call(r):void 0},a=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},s=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},f=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],r=!0,i=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);r=!0);}catch(t){i=!0,o=t}finally{try{!r&&s.return&&s.return()}finally{if(i)throw o}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),l=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},h=function(){function t(e){r(this,t),this.selfOptions=e||{},this.pipes={}}return i(t,[{key:"options",value:function(t){return t&&(this.selfOptions=t),this.selfOptions}},{key:"pipe",value:function(t,e){var n=e;if("string"==typeof t){if(void 0===n)return this.pipes[t];this.pipes[t]=n}if(t&&t.name){if(n=t,n.processor===this)return n;this.pipes[n.name]=n}return n.processor=this,n}},{key:"process",value:function(t,e){var n=t;n.options=this.options();for(var r=e||t.pipe||"default",i=void 0,o=void 0;r;)void 0!==n.nextAfterChildren&&(n.next=n.nextAfterChildren,n.nextAfterChildren=null),"string"==typeof r&&(r=this.pipe(r)),r.process(n),o=n,i=r,r=null,n&&n.next&&(n=n.next,r=o.nextPipe||n.pipe||i);return n.hasResult?n.result:void 0}}]),t}(),u=function(){function t(e){r(this,t),this.name=e,this.filters=[]}return i(t,[{key:"process",value:function(t){if(!this.processor)throw new Error("add this pipe to a processor before using it");for(var e=this.debug,r=this.filters.length,i=t,o=0;o<r;o++){var a=this.filters[o];if(e&&this.log("filter: "+a.filterName),a(i),"object"===(void 0===i?"undefined":n(i))&&i.exiting){i.exiting=!1;break}}!i.next&&this.resultCheck&&this.resultCheck(i)}},{key:"log",value:function(t){console.log("[jsondiffpatch] "+this.name+" pipe, "+t)}},{key:"append",value:function(){var t;return(t=this.filters).push.apply(t,arguments),this}},{key:"prepend",value:function(){var t;return(t=this.filters).unshift.apply(t,arguments),this}},{key:"indexOf",value:function(t){if(!t)throw new Error("a filter name is required");for(var e=0;e<this.filters.length;e++){if(this.filters[e].filterName===t)return e}throw new Error("filter not found: "+t)}},{key:"list",value:function(){return this.filters.map(function(t){return t.filterName})}},{key:"after",value:function(t){var e=this.indexOf(t),n=Array.prototype.slice.call(arguments,1);if(!n.length)throw new Error("a filter is required");return n.unshift(e+1,0),Array.prototype.splice.apply(this.filters,n),this}},{key:"before",value:function(t){var e=this.indexOf(t),n=Array.prototype.slice.call(arguments,1);if(!n.length)throw new Error("a filter is required");return n.unshift(e,0),Array.prototype.splice.apply(this.filters,n),this}},{key:"replace",value:function(t){var e=this.indexOf(t),n=Array.prototype.slice.call(arguments,1);if(!n.length)throw new Error("a filter is required");return n.unshift(e,1),Array.prototype.splice.apply(this.filters,n),this}},{key:"remove",value:function(t){var e=this.indexOf(t);return this.filters.splice(e,1),this}},{key:"clear",value:function(){return this.filters.length=0,this}},{key:"shouldHaveResult",value:function(t){if(!1!==t){if(!this.resultCheck){var e=this;return this.resultCheck=function(t){if(!t.hasResult){console.log(t);var n=new Error(e.name+" failed");throw n.noResult=!0,n}},this}}else this.resultCheck=null}}]),t}(),c=function(){function t(){r(this,t)}return i(t,[{key:"setResult",value:function(t){return this.result=t,this.hasResult=!0,this}},{key:"exit",value:function(){return this.exiting=!0,this}},{key:"switchTo",value:function(t,e){return"string"==typeof t||t instanceof u?this.nextPipe=t:(this.next=t,e&&(this.nextPipe=e)),this}},{key:"push",value:function(t,e){return t.parent=this,void 0!==e&&(t.childName=e),t.root=this.root||this,t.options=t.options||this.options,this.children?(this.children[this.children.length-1].next=t,this.children.push(t)):(this.children=[t],this.nextAfterChildren=this.next||null,this.next=t),t.next=this,this}}]),t}(),d="function"==typeof Array.isArray?Array.isArray:function(t){return t instanceof Array};function p(t){if("object"!==(void 0===t?"undefined":n(t)))return t;if(null===t)return null;if(d(t))return t.map(p);if(t instanceof Date)return new Date(t.getTime());if(t instanceof RegExp)return e=/^\/(.*)\/([gimyu]*)$/.exec(t.toString()),new RegExp(e[1],e[2]);var e,r={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(r[i]=p(t[i]));return r}var v=function(t){function e(t,n){r(this,e);var i=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.left=t,i.right=n,i.pipe="diff",i}return a(e,c),i(e,[{key:"setResult",value:function(t){if(this.options.cloneDiffValues&&"object"===(void 0===t?"undefined":n(t))){var e="function"==typeof this.options.cloneDiffValues?this.options.cloneDiffValues:p;"object"===n(t[0])&&(t[0]=e(t[0])),"object"===n(t[1])&&(t[1]=e(t[1]))}return c.prototype.setResult.apply(this,arguments)}}]),e}(),g=function(t){function e(t,n){r(this,e);var i=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.left=t,i.delta=n,i.pipe="patch",i}return a(e,c),e}(),y=function(t){function e(t){r(this,e);var n=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.delta=t,n.pipe="reverse",n}return a(e,c),e}(),m="function"==typeof Array.isArray?Array.isArray:function(t){return t instanceof Array},_=function(t){if(t.left!==t.right)if(void 0!==t.left)if(void 0!==t.right){if("function"==typeof t.left||"function"==typeof t.right)throw new Error("functions are not supported");t.leftType=null===t.left?"null":n(t.left),t.rightType=null===t.right?"null":n(t.right),t.leftType===t.rightType&&"boolean"!==t.leftType&&"number"!==t.leftType?("object"===t.leftType&&(t.leftIsArray=m(t.left)),"object"===t.rightType&&(t.rightIsArray=m(t.right)),t.leftIsArray===t.rightIsArray?t.left instanceof RegExp&&(t.right instanceof RegExp?t.setResult([t.left.toString(),t.right.toString()]).exit():t.setResult([t.left,t.right]).exit()):t.setResult([t.left,t.right]).exit()):t.setResult([t.left,t.right]).exit()}else t.setResult([t.left,0,0]).exit();else{if("function"==typeof t.right)throw new Error("functions are not supported");t.setResult([t.right]).exit()}else t.setResult(void 0).exit()};_.filterName="trivial";var b=function(t){if(void 0!==t.delta){if(t.nested=!m(t.delta),!t.nested)if(1!==t.delta.length)if(2!==t.delta.length)3===t.delta.length&&0===t.delta[2]&&t.setResult(void 0).exit();else{if(t.left instanceof RegExp){var e=/^\/(.*)\/([gimyu]+)$/.exec(t.delta[1]);if(e)return void t.setResult(new RegExp(e[1],e[2])).exit()}t.setResult(t.delta[1]).exit()}else t.setResult(t.delta[0]).exit()}else t.setResult(t.left).exit()};b.filterName="trivial";var x=function(t){void 0!==t.delta?(t.nested=!m(t.delta),t.nested||(1!==t.delta.length?2!==t.delta.length?3===t.delta.length&&0===t.delta[2]&&t.setResult([t.delta[0]]).exit():t.setResult([t.delta[1],t.delta[0]]).exit():t.setResult([t.delta[0],0,0]).exit())):t.setResult(t.delta).exit()};function w(t){if(t&&t.children){for(var e=t.children.length,n=void 0,r=t.result,i=0;i<e;i++)void 0!==(n=t.children[i]).result&&((r=r||{})[n.childName]=n.result);r&&t.leftIsArray&&(r._t="a"),t.setResult(r).exit()}}function k(t){if(!t.leftIsArray&&"object"===t.leftType){var e=void 0,n=void 0,r=t.options.propertyFilter;for(e in t.left)Object.prototype.hasOwnProperty.call(t.left,e)&&(r&&!r(e,t)||(n=new v(t.left[e],t.right[e]),t.push(n,e)));for(e in t.right)Object.prototype.hasOwnProperty.call(t.right,e)&&(r&&!r(e,t)||void 0===t.left[e]&&(n=new v(void 0,t.right[e]),t.push(n,e)));t.children&&0!==t.children.length?t.exit():t.setResult(void 0).exit()}}x.filterName="trivial",w.filterName="collectChildren",k.filterName="objects";var j=function(t){if(t.nested&&!t.delta._t){var e=void 0,n=void 0;for(e in t.delta)n=new g(t.left[e],t.delta[e]),t.push(n,e);t.exit()}};j.filterName="objects";var A=function(t){if(t&&t.children&&!t.delta._t){for(var e=t.children.length,n=void 0,r=0;r<e;r++)n=t.children[r],Object.prototype.hasOwnProperty.call(t.left,n.childName)&&void 0===n.result?delete t.left[n.childName]:t.left[n.childName]!==n.result&&(t.left[n.childName]=n.result);t.setResult(t.left).exit()}};A.filterName="collectChildren";var O=function(t){if(t.nested&&!t.delta._t){var e=void 0,n=void 0;for(e in t.delta)n=new y(t.delta[e]),t.push(n,e);t.exit()}};function M(t){if(t&&t.children&&!t.delta._t){for(var e=t.children.length,n=void 0,r={},i=0;i<e;i++)r[(n=t.children[i]).childName]!==n.result&&(r[n.childName]=n.result);t.setResult(r).exit()}}O.filterName="objects",M.filterName="collectChildren";var R=function(t,e,n,r){return t[n]===e[r]},C=function(t,e,n,r){var i=r||{},o=function(t,e,n,r){for(var i=e.length,o=n.length,a={sequence:[],indices1:[],indices2:[]};0!==i&&0!==o;)t.match(e,n,i-1,o-1,r)?(a.sequence.unshift(e[i-1]),a.indices1.unshift(i-1),a.indices2.unshift(o-1),--i,--o):t[i][o-1]>t[i-1][o]?--o:--i;return a}(function(t,e,n,r){var i=t.length,o=e.length,a=void 0,s=void 0,f=[i+1];for(a=0;a<i+1;a++)for(f[a]=[o+1],s=0;s<o+1;s++)f[a][s]=0;for(f.match=n,a=1;a<i+1;a++)for(s=1;s<o+1;s++)n(t,e,a-1,s-1,r)?f[a][s]=f[a-1][s-1]+1:f[a][s]=Math.max(f[a-1][s],f[a][s-1]);return f}(t,e,n||R,i),t,e,i);return"string"==typeof t&&"string"==typeof e&&(o.sequence=o.sequence.join("")),o},E="function"==typeof Array.isArray?Array.isArray:function(t){return t instanceof Array},P="function"==typeof Array.prototype.indexOf?function(t,e){return t.indexOf(e)}:function(t,e){for(var n=t.length,r=0;r<n;r++)if(t[r]===e)return r;return-1};function D(t,e,r,i,o){var a=t[r],s=e[i];if(a===s)return!0;if("object"!==(void 0===a?"undefined":n(a))||"object"!==(void 0===s?"undefined":n(s)))return!1;var f=o.objectHash;if(!f)return o.matchByPosition&&r===i;var l=void 0,h=void 0;return"number"==typeof r?(o.hashCache1=o.hashCache1||[],void 0===(l=o.hashCache1[r])&&(o.hashCache1[r]=l=f(a,r))):l=f(a),void 0!==l&&("number"==typeof i?(o.hashCache2=o.hashCache2||[],void 0===(h=o.hashCache2[i])&&(o.hashCache2[i]=h=f(s,i))):h=f(s),void 0!==h&&l===h)}var T=function(t){if(t.leftIsArray){var e={objectHash:t.options&&t.options.objectHash,matchByPosition:t.options&&t.options.matchByPosition},n=0,r=0,i=void 0,o=void 0,a=void 0,s=t.left,f=t.right,l=s.length,h=f.length,u=void 0;for(l>0&&h>0&&!e.objectHash&&"boolean"!=typeof e.matchByPosition&&(e.matchByPosition=!function(t,e,n,r){for(var i=0;i<n;i++)for(var o=t[i],a=0;a<r;a++){var s=e[a];if(i!==a&&o===s)return!0}}(s,f,l,h));n<l&&n<h&&D(s,f,n,n,e);)i=n,u=new v(t.left[i],t.right[i]),t.push(u,i),n++;for(;r+n<l&&r+n<h&&D(s,f,l-1-r,h-1-r,e);)o=l-1-r,a=h-1-r,u=new v(t.left[o],t.right[a]),t.push(u,a),r++;var c=void 0;if(n+r!==l)if(n+r!==h){delete e.hashCache1,delete e.hashCache2;var d=s.slice(n,l-r),p=f.slice(n,h-r),g=C(d,p,D,e),y=[];for(c=c||{_t:"a"},i=n;i<l-r;i++)P(g.indices1,i-n)<0&&(c["_"+i]=[s[i],0,0],y.push(i));var m=!0;t.options&&t.options.arrays&&!1===t.options.arrays.detectMove&&(m=!1);var _=!1;t.options&&t.options.arrays&&t.options.arrays.includeValueOnMove&&(_=!0);var b=y.length;for(i=n;i<h-r;i++){var x=P(g.indices2,i-n);if(x<0){var w=!1;if(m&&b>0)for(var k=0;k<b;k++)if(D(d,p,(o=y[k])-n,i-n,e)){c["_"+o].splice(1,2,i,3),_||(c["_"+o][0]=""),a=i,u=new v(t.left[o],t.right[a]),t.push(u,a),y.splice(k,1),w=!0;break}w||(c[i]=[f[i]])}else o=g.indices1[x]+n,a=g.indices2[x]+n,u=new v(t.left[o],t.right[a]),t.push(u,a)}t.setResult(c).exit()}else{for(c=c||{_t:"a"},i=n;i<l-r;i++)c["_"+i]=[s[i],0,0];t.setResult(c).exit()}else{if(l===h)return void t.setResult(void 0).exit();for(c=c||{_t:"a"},i=n;i<h-r;i++)c[i]=[f[i]];t.setResult(c).exit()}}};T.filterName="arrays";var N=function(t,e){return t-e},I=function(t){return function(e,n){return e[t]-n[t]}},S=function(t){if(t.nested&&"a"===t.delta._t){var e=void 0,n=void 0,r=t.delta,i=t.left,o=[],a=[],s=[];for(e in r)if("_t"!==e)if("_"===e[0]){if(0!==r[e][2]&&3!==r[e][2])throw new Error("only removal or move can be applied at original array indices, invalid diff type: "+r[e][2]);o.push(parseInt(e.slice(1),10))}else 1===r[e].length?a.push({index:parseInt(e,10),value:r[e][0]}):s.push({index:parseInt(e,10),delta:r[e]});for(e=(o=o.sort(N)).length-1;e>=0;e--){var f=r["_"+(n=o[e])],l=i.splice(n,1)[0];3===f[2]&&a.push({index:f[1],value:l})}var h=(a=a.sort(I("index"))).length;for(e=0;e<h;e++){var u=a[e];i.splice(u.index,0,u.value)}var c=s.length,d=void 0;if(c>0)for(e=0;e<c;e++){var p=s[e];d=new g(t.left[p.index],p.delta),t.push(d,p.index)}t.children?t.exit():t.setResult(t.left).exit()}};S.filterName="arrays";var B=function(t){if(t&&t.children&&"a"===t.delta._t){for(var e=t.children.length,n=void 0,r=0;r<e;r++)n=t.children[r],t.left[n.childName]=n.result;t.setResult(t.left).exit()}};B.filterName="arraysCollectChildren";var F=function(t){if(t.nested){if("a"===t.delta._t){var e=void 0,n=void 0;for(e in t.delta)"_t"!==e&&(n=new y(t.delta[e]),t.push(n,e));t.exit()}}else 3===t.delta[2]&&(t.newName="_"+t.delta[1],t.setResult([t.delta[0],parseInt(t.childName.substr(1),10),3]).exit())};F.filterName="arrays";var L=function(t,e,n){if("string"==typeof e&&"_"===e[0])return parseInt(e.substr(1),10);if(E(n)&&0===n[2])return"_"+e;var r=+e;for(var i in t){var o=t[i];if(E(o))if(3===o[2]){var a=parseInt(i.substr(1),10),s=o[1];if(s===+e)return a;a<=r&&s>r?r++:a>=r&&s<r&&r--}else if(0===o[2]){parseInt(i.substr(1),10)<=r&&r++}else 1===o.length&&i<=r&&r--}return r};function V(t){if(t&&t.children&&"a"===t.delta._t){for(var e=t.children.length,n=void 0,r={_t:"a"},i=0;i<e;i++){var o=(n=t.children[i]).newName;void 0===o&&(o=L(t.delta,n.childName,n.result)),r[o]!==n.result&&(r[o]=n.result)}t.setResult(r).exit()}}V.filterName="arraysCollectChildren";var q=function(t){t.left instanceof Date?(t.right instanceof Date?t.left.getTime()!==t.right.getTime()?t.setResult([t.left,t.right]):t.setResult(void 0):t.setResult([t.left,t.right]),t.exit()):t.right instanceof Date&&t.setResult([t.left,t.right]).exit()};q.filterName="dates";var U,H=(function(t){function e(){this.Diff_Timeout=1,this.Diff_EditCost=4,this.Match_Threshold=.5,this.Match_Distance=1e3,this.Patch_DeleteThreshold=.5,this.Patch_Margin=4,this.Match_MaxBits=32}e.prototype.diff_main=function(t,e,n,r){void 0===r&&(r=this.Diff_Timeout<=0?Number.MAX_VALUE:(new Date).getTime()+1e3*this.Diff_Timeout);var i=r;if(null==t||null==e)throw new Error("Null input. (diff_main)");if(t==e)return t?[[0,t]]:[];void 0===n&&(n=!0);var o=n,a=this.diff_commonPrefix(t,e),s=t.substring(0,a);t=t.substring(a),e=e.substring(a),a=this.diff_commonSuffix(t,e);var f=t.substring(t.length-a);t=t.substring(0,t.length-a),e=e.substring(0,e.length-a);var l=this.diff_compute_(t,e,o,i);return s&&l.unshift([0,s]),f&&l.push([0,f]),this.diff_cleanupMerge(l),l},e.prototype.diff_compute_=function(t,e,n,r){var i;if(!t)return[[1,e]];if(!e)return[[-1,t]];var o=t.length>e.length?t:e,a=t.length>e.length?e:t,s=o.indexOf(a);if(-1!=s)return i=[[1,o.substring(0,s)],[0,a],[1,o.substring(s+a.length)]],t.length>e.length&&(i[0][0]=i[2][0]=-1),i;if(1==a.length)return[[-1,t],[1,e]];var f=this.diff_halfMatch_(t,e);if(f){var l=f[0],h=f[1],u=f[2],c=f[3],d=f[4],p=this.diff_main(l,u,n,r),v=this.diff_main(h,c,n,r);return p.concat([[0,d]],v)}return n&&t.length>100&&e.length>100?this.diff_lineMode_(t,e,r):this.diff_bisect_(t,e,r)},e.prototype.diff_lineMode_=function(t,e,n){t=(h=this.diff_linesToChars_(t,e)).chars1,e=h.chars2;var r=h.lineArray,i=this.diff_main(t,e,!1,n);this.diff_charsToLines_(i,r),this.diff_cleanupSemantic(i),i.push([0,""]);for(var o=0,a=0,s=0,f="",l="";o<i.length;){switch(i[o][0]){case 1:s++,l+=i[o][1];break;case-1:a++,f+=i[o][1];break;case 0:if(a>=1&&s>=1){i.splice(o-a-s,a+s),o=o-a-s;for(var h,u=(h=this.diff_main(f,l,!1,n)).length-1;u>=0;u--)i.splice(o,0,h[u]);o+=h.length}s=0,a=0,f="",l=""}o++}return i.pop(),i},e.prototype.diff_bisect_=function(t,e,n){for(var r=t.length,i=e.length,o=Math.ceil((r+i)/2),a=o,s=2*o,f=new Array(s),l=new Array(s),h=0;h<s;h++)f[h]=-1,l[h]=-1;f[a+1]=0,l[a+1]=0;for(var u=r-i,c=u%2!=0,d=0,p=0,v=0,g=0,y=0;y<o&&!((new Date).getTime()>n);y++){for(var m=-y+d;m<=y-p;m+=2){for(var _=a+m,b=(A=m==-y||m!=y&&f[_-1]<f[_+1]?f[_+1]:f[_-1]+1)-m;A<r&&b<i&&t.charAt(A)==e.charAt(b);)A++,b++;if(f[_]=A,A>r)p+=2;else if(b>i)d+=2;else if(c){if((k=a+u-m)>=0&&k<s&&-1!=l[k])if(A>=(w=r-l[k]))return this.diff_bisectSplit_(t,e,A,b,n)}}for(var x=-y+v;x<=y-g;x+=2){for(var w,k=a+x,j=(w=x==-y||x!=y&&l[k-1]<l[k+1]?l[k+1]:l[k-1]+1)-x;w<r&&j<i&&t.charAt(r-w-1)==e.charAt(i-j-1);)w++,j++;if(l[k]=w,w>r)g+=2;else if(j>i)v+=2;else if(!c){if((_=a+u-x)>=0&&_<s&&-1!=f[_]){var A;b=a+(A=f[_])-_;if(A>=(w=r-w))return this.diff_bisectSplit_(t,e,A,b,n)}}}}return[[-1,t],[1,e]]},e.prototype.diff_bisectSplit_=function(t,e,n,r,i){var o=t.substring(0,n),a=e.substring(0,r),s=t.substring(n),f=e.substring(r),l=this.diff_main(o,a,!1,i),h=this.diff_main(s,f,!1,i);return l.concat(h)},e.prototype.diff_linesToChars_=function(t,e){var n=[],r={};function i(t){for(var e="",i=0,o=-1,a=n.length;o<t.length-1;){-1==(o=t.indexOf("\n",i))&&(o=t.length-1);var s=t.substring(i,o+1);i=o+1,(r.hasOwnProperty?r.hasOwnProperty(s):void 0!==r[s])?e+=String.fromCharCode(r[s]):(e+=String.fromCharCode(a),r[s]=a,n[a++]=s)}return e}return n[0]="",{chars1:i(t),chars2:i(e),lineArray:n}},e.prototype.diff_charsToLines_=function(t,e){for(var n=0;n<t.length;n++){for(var r=t[n][1],i=[],o=0;o<r.length;o++)i[o]=e[r.charCodeAt(o)];t[n][1]=i.join("")}},e.prototype.diff_commonPrefix=function(t,e){if(!t||!e||t.charAt(0)!=e.charAt(0))return 0;for(var n=0,r=Math.min(t.length,e.length),i=r,o=0;n<i;)t.substring(o,i)==e.substring(o,i)?o=n=i:r=i,i=Math.floor((r-n)/2+n);return i},e.prototype.diff_commonSuffix=function(t,e){if(!t||!e||t.charAt(t.length-1)!=e.charAt(e.length-1))return 0;for(var n=0,r=Math.min(t.length,e.length),i=r,o=0;n<i;)t.substring(t.length-i,t.length-o)==e.substring(e.length-i,e.length-o)?o=n=i:r=i,i=Math.floor((r-n)/2+n);return i},e.prototype.diff_commonOverlap_=function(t,e){var n=t.length,r=e.length;if(0==n||0==r)return 0;n>r?t=t.substring(n-r):n<r&&(e=e.substring(0,n));var i=Math.min(n,r);if(t==e)return i;for(var o=0,a=1;;){var s=t.substring(i-a),f=e.indexOf(s);if(-1==f)return o;a+=f,0!=f&&t.substring(i-a)!=e.substring(0,a)||(o=a,a++)}},e.prototype.diff_halfMatch_=function(t,e){if(this.Diff_Timeout<=0)return null;var n=t.length>e.length?t:e,r=t.length>e.length?e:t;if(n.length<4||2*r.length<n.length)return null;var i=this;function o(t,e,n){for(var r,o,a,s,f=t.substring(n,n+Math.floor(t.length/4)),l=-1,h="";-1!=(l=e.indexOf(f,l+1));){var u=i.diff_commonPrefix(t.substring(n),e.substring(l)),c=i.diff_commonSuffix(t.substring(0,n),e.substring(0,l));h.length<c+u&&(h=e.substring(l-c,l)+e.substring(l,l+u),r=t.substring(0,n-c),o=t.substring(n+u),a=e.substring(0,l-c),s=e.substring(l+u))}return 2*h.length>=t.length?[r,o,a,s,h]:null}var a,s,f,l,h,u=o(n,r,Math.ceil(n.length/4)),c=o(n,r,Math.ceil(n.length/2));return u||c?(a=c?u&&u[4].length>c[4].length?u:c:u,t.length>e.length?(s=a[0],f=a[1],l=a[2],h=a[3]):(l=a[0],h=a[1],s=a[2],f=a[3]),[s,f,l,h,a[4]]):null},e.prototype.diff_cleanupSemantic=function(t){for(var e=!1,n=[],r=0,i=null,o=0,a=0,s=0,f=0,l=0;o<t.length;)0==t[o][0]?(n[r++]=o,a=f,s=l,f=0,l=0,i=t[o][1]):(1==t[o][0]?f+=t[o][1].length:l+=t[o][1].length,i&&i.length<=Math.max(a,s)&&i.length<=Math.max(f,l)&&(t.splice(n[r-1],0,[-1,i]),t[n[r-1]+1][0]=1,r--,o=--r>0?n[r-1]:-1,a=0,s=0,f=0,l=0,i=null,e=!0)),o++;for(e&&this.diff_cleanupMerge(t),this.diff_cleanupSemanticLossless(t),o=1;o<t.length;){if(-1==t[o-1][0]&&1==t[o][0]){var h=t[o-1][1],u=t[o][1],c=this.diff_commonOverlap_(h,u),d=this.diff_commonOverlap_(u,h);c>=d?(c>=h.length/2||c>=u.length/2)&&(t.splice(o,0,[0,u.substring(0,c)]),t[o-1][1]=h.substring(0,h.length-c),t[o+1][1]=u.substring(c),o++):(d>=h.length/2||d>=u.length/2)&&(t.splice(o,0,[0,h.substring(0,d)]),t[o-1][0]=1,t[o-1][1]=u.substring(0,u.length-d),t[o+1][0]=-1,t[o+1][1]=h.substring(d),o++),o++}o++}},e.prototype.diff_cleanupSemanticLossless=function(t){function n(t,n){if(!t||!n)return 6;var r=t.charAt(t.length-1),i=n.charAt(0),o=r.match(e.nonAlphaNumericRegex_),a=i.match(e.nonAlphaNumericRegex_),s=o&&r.match(e.whitespaceRegex_),f=a&&i.match(e.whitespaceRegex_),l=s&&r.match(e.linebreakRegex_),h=f&&i.match(e.linebreakRegex_),u=l&&t.match(e.blanklineEndRegex_),c=h&&n.match(e.blanklineStartRegex_);return u||c?5:l||h?4:o&&!s&&f?3:s||f?2:o||a?1:0}for(var r=1;r<t.length-1;){if(0==t[r-1][0]&&0==t[r+1][0]){var i=t[r-1][1],o=t[r][1],a=t[r+1][1],s=this.diff_commonSuffix(i,o);if(s){var f=o.substring(o.length-s);i=i.substring(0,i.length-s),o=f+o.substring(0,o.length-s),a=f+a}for(var l=i,h=o,u=a,c=n(i,o)+n(o,a);o.charAt(0)===a.charAt(0);){i+=o.charAt(0),o=o.substring(1)+a.charAt(0),a=a.substring(1);var d=n(i,o)+n(o,a);d>=c&&(c=d,l=i,h=o,u=a)}t[r-1][1]!=l&&(l?t[r-1][1]=l:(t.splice(r-1,1),r--),t[r][1]=h,u?t[r+1][1]=u:(t.splice(r+1,1),r--))}r++}},e.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/,e.whitespaceRegex_=/\s/,e.linebreakRegex_=/[\r\n]/,e.blanklineEndRegex_=/\n\r?\n$/,e.blanklineStartRegex_=/^\r?\n\r?\n/,e.prototype.diff_cleanupEfficiency=function(t){for(var e=!1,n=[],r=0,i=null,o=0,a=!1,s=!1,f=!1,l=!1;o<t.length;)0==t[o][0]?(t[o][1].length<this.Diff_EditCost&&(f||l)?(n[r++]=o,a=f,s=l,i=t[o][1]):(r=0,i=null),f=l=!1):(-1==t[o][0]?l=!0:f=!0,i&&(a&&s&&f&&l||i.length<this.Diff_EditCost/2&&a+s+f+l==3)&&(t.splice(n[r-1],0,[-1,i]),t[n[r-1]+1][0]=1,r--,i=null,a&&s?(f=l=!0,r=0):(o=--r>0?n[r-1]:-1,f=l=!1),e=!0)),o++;e&&this.diff_cleanupMerge(t)},e.prototype.diff_cleanupMerge=function(t){t.push([0,""]);for(var e,n=0,r=0,i=0,o="",a="";n<t.length;)switch(t[n][0]){case 1:i++,a+=t[n][1],n++;break;case-1:r++,o+=t[n][1],n++;break;case 0:r+i>1?(0!==r&&0!==i&&(0!==(e=this.diff_commonPrefix(a,o))&&(n-r-i>0&&0==t[n-r-i-1][0]?t[n-r-i-1][1]+=a.substring(0,e):(t.splice(0,0,[0,a.substring(0,e)]),n++),a=a.substring(e),o=o.substring(e)),0!==(e=this.diff_commonSuffix(a,o))&&(t[n][1]=a.substring(a.length-e)+t[n][1],a=a.substring(0,a.length-e),o=o.substring(0,o.length-e))),0===r?t.splice(n-i,r+i,[1,a]):0===i?t.splice(n-r,r+i,[-1,o]):t.splice(n-r-i,r+i,[-1,o],[1,a]),n=n-r-i+(r?1:0)+(i?1:0)+1):0!==n&&0==t[n-1][0]?(t[n-1][1]+=t[n][1],t.splice(n,1)):n++,i=0,r=0,o="",a=""}""===t[t.length-1][1]&&t.pop();var s=!1;for(n=1;n<t.length-1;)0==t[n-1][0]&&0==t[n+1][0]&&(t[n][1].substring(t[n][1].length-t[n-1][1].length)==t[n-1][1]?(t[n][1]=t[n-1][1]+t[n][1].substring(0,t[n][1].length-t[n-1][1].length),t[n+1][1]=t[n-1][1]+t[n+1][1],t.splice(n-1,1),s=!0):t[n][1].substring(0,t[n+1][1].length)==t[n+1][1]&&(t[n-1][1]+=t[n+1][1],t[n][1]=t[n][1].substring(t[n+1][1].length)+t[n+1][1],t.splice(n+1,1),s=!0)),n++;s&&this.diff_cleanupMerge(t)},e.prototype.diff_xIndex=function(t,e){var n,r=0,i=0,o=0,a=0;for(n=0;n<t.length&&(1!==t[n][0]&&(r+=t[n][1].length),-1!==t[n][0]&&(i+=t[n][1].length),!(r>e));n++)o=r,a=i;return t.length!=n&&-1===t[n][0]?a:a+(e-o)},e.prototype.diff_prettyHtml=function(t){for(var e=[],n=/&/g,r=/</g,i=/>/g,o=/\n/g,a=0;a<t.length;a++){var s=t[a][0],f=t[a][1].replace(n,"&amp;").replace(r,"&lt;").replace(i,"&gt;").replace(o,"&para;<br>");switch(s){case 1:e[a]='<ins style="background:#e6ffe6;">'+f+"</ins>";break;case-1:e[a]='<del style="background:#ffe6e6;">'+f+"</del>";break;case 0:e[a]="<span>"+f+"</span>"}}return e.join("")},e.prototype.diff_text1=function(t){for(var e=[],n=0;n<t.length;n++)1!==t[n][0]&&(e[n]=t[n][1]);return e.join("")},e.prototype.diff_text2=function(t){for(var e=[],n=0;n<t.length;n++)-1!==t[n][0]&&(e[n]=t[n][1]);return e.join("")},e.prototype.diff_levenshtein=function(t){for(var e=0,n=0,r=0,i=0;i<t.length;i++){var o=t[i][0],a=t[i][1];switch(o){case 1:n+=a.length;break;case-1:r+=a.length;break;case 0:e+=Math.max(n,r),n=0,r=0}}return e+=Math.max(n,r)},e.prototype.diff_toDelta=function(t){for(var e=[],n=0;n<t.length;n++)switch(t[n][0]){case 1:e[n]="+"+encodeURI(t[n][1]);break;case-1:e[n]="-"+t[n][1].length;break;case 0:e[n]="="+t[n][1].length}return e.join("\t").replace(/%20/g," ")},e.prototype.diff_fromDelta=function(t,e){for(var n=[],r=0,i=0,o=e.split(/\t/g),a=0;a<o.length;a++){var s=o[a].substring(1);switch(o[a].charAt(0)){case"+":try{n[r++]=[1,decodeURI(s)]}catch(t){throw new Error("Illegal escape in diff_fromDelta: "+s)}break;case"-":case"=":var f=parseInt(s,10);if(isNaN(f)||f<0)throw new Error("Invalid number in diff_fromDelta: "+s);var l=t.substring(i,i+=f);"="==o[a].charAt(0)?n[r++]=[0,l]:n[r++]=[-1,l];break;default:if(o[a])throw new Error("Invalid diff operation in diff_fromDelta: "+o[a])}}if(i!=t.length)throw new Error("Delta length ("+i+") does not equal source text length ("+t.length+").");return n},e.prototype.match_main=function(t,e,n){if(null==t||null==e||null==n)throw new Error("Null input. (match_main)");return n=Math.max(0,Math.min(n,t.length)),t==e?0:t.length?t.substring(n,n+e.length)==e?n:this.match_bitap_(t,e,n):-1},e.prototype.match_bitap_=function(t,e,n){if(e.length>this.Match_MaxBits)throw new Error("Pattern too long for this browser.");var r=this.match_alphabet_(e),i=this;function o(t,r){var o=t/e.length,a=Math.abs(n-r);return i.Match_Distance?o+a/i.Match_Distance:a?1:o}var a=this.Match_Threshold,s=t.indexOf(e,n);-1!=s&&(a=Math.min(o(0,s),a),-1!=(s=t.lastIndexOf(e,n+e.length))&&(a=Math.min(o(0,s),a)));var f,l,h=1<<e.length-1;s=-1;for(var u,c=e.length+t.length,d=0;d<e.length;d++){for(f=0,l=c;f<l;)o(d,n+l)<=a?f=l:c=l,l=Math.floor((c-f)/2+f);c=l;var p=Math.max(1,n-l+1),v=Math.min(n+l,t.length)+e.length,g=Array(v+2);g[v+1]=(1<<d)-1;for(var y=v;y>=p;y--){var m=r[t.charAt(y-1)];if(g[y]=0===d?(g[y+1]<<1|1)&m:(g[y+1]<<1|1)&m|(u[y+1]|u[y])<<1|1|u[y+1],g[y]&h){var _=o(d,y-1);if(_<=a){if(a=_,!((s=y-1)>n))break;p=Math.max(1,2*n-s)}}}if(o(d+1,n)>a)break;u=g}return s},e.prototype.match_alphabet_=function(t){for(var e={},n=0;n<t.length;n++)e[t.charAt(n)]=0;for(n=0;n<t.length;n++)e[t.charAt(n)]|=1<<t.length-n-1;return e},e.prototype.patch_addContext_=function(t,e){if(0!=e.length){for(var n=e.substring(t.start2,t.start2+t.length1),r=0;e.indexOf(n)!=e.lastIndexOf(n)&&n.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)r+=this.Patch_Margin,n=e.substring(t.start2-r,t.start2+t.length1+r);r+=this.Patch_Margin;var i=e.substring(t.start2-r,t.start2);i&&t.diffs.unshift([0,i]);var o=e.substring(t.start2+t.length1,t.start2+t.length1+r);o&&t.diffs.push([0,o]),t.start1-=i.length,t.start2-=i.length,t.length1+=i.length+o.length,t.length2+=i.length+o.length}},e.prototype.patch_make=function(t,n,r){var i,o;if("string"==typeof t&&"string"==typeof n&&void 0===r)i=t,(o=this.diff_main(i,n,!0)).length>2&&(this.diff_cleanupSemantic(o),this.diff_cleanupEfficiency(o));else if(t&&"object"==typeof t&&void 0===n&&void 0===r)o=t,i=this.diff_text1(o);else if("string"==typeof t&&n&&"object"==typeof n&&void 0===r)i=t,o=n;else{if("string"!=typeof t||"string"!=typeof n||!r||"object"!=typeof r)throw new Error("Unknown call format to patch_make.");i=t,o=r}if(0===o.length)return[];for(var a=[],s=new e.patch_obj,f=0,l=0,h=0,u=i,c=i,d=0;d<o.length;d++){var p=o[d][0],v=o[d][1];switch(f||0===p||(s.start1=l,s.start2=h),p){case 1:s.diffs[f++]=o[d],s.length2+=v.length,c=c.substring(0,h)+v+c.substring(h);break;case-1:s.length1+=v.length,s.diffs[f++]=o[d],c=c.substring(0,h)+c.substring(h+v.length);break;case 0:v.length<=2*this.Patch_Margin&&f&&o.length!=d+1?(s.diffs[f++]=o[d],s.length1+=v.length,s.length2+=v.length):v.length>=2*this.Patch_Margin&&f&&(this.patch_addContext_(s,u),a.push(s),s=new e.patch_obj,f=0,u=c,l=h)}1!==p&&(l+=v.length),-1!==p&&(h+=v.length)}return f&&(this.patch_addContext_(s,u),a.push(s)),a},e.prototype.patch_deepCopy=function(t){for(var n=[],r=0;r<t.length;r++){var i=t[r],o=new e.patch_obj;o.diffs=[];for(var a=0;a<i.diffs.length;a++)o.diffs[a]=i.diffs[a].slice();o.start1=i.start1,o.start2=i.start2,o.length1=i.length1,o.length2=i.length2,n[r]=o}return n},e.prototype.patch_apply=function(t,e){if(0==t.length)return[e,[]];t=this.patch_deepCopy(t);var n=this.patch_addPadding(t);e=n+e+n,this.patch_splitMax(t);for(var r=0,i=[],o=0;o<t.length;o++){var a,s,f=t[o].start2+r,l=this.diff_text1(t[o].diffs),h=-1;if(l.length>this.Match_MaxBits?-1!=(a=this.match_main(e,l.substring(0,this.Match_MaxBits),f))&&(-1==(h=this.match_main(e,l.substring(l.length-this.Match_MaxBits),f+l.length-this.Match_MaxBits))||a>=h)&&(a=-1):a=this.match_main(e,l,f),-1==a)i[o]=!1,r-=t[o].length2-t[o].length1;else if(i[o]=!0,r=a-f,l==(s=-1==h?e.substring(a,a+l.length):e.substring(a,h+this.Match_MaxBits)))e=e.substring(0,a)+this.diff_text2(t[o].diffs)+e.substring(a+l.length);else{var u=this.diff_main(l,s,!1);if(l.length>this.Match_MaxBits&&this.diff_levenshtein(u)/l.length>this.Patch_DeleteThreshold)i[o]=!1;else{this.diff_cleanupSemanticLossless(u);for(var c,d=0,p=0;p<t[o].diffs.length;p++){var v=t[o].diffs[p];0!==v[0]&&(c=this.diff_xIndex(u,d)),1===v[0]?e=e.substring(0,a+c)+v[1]+e.substring(a+c):-1===v[0]&&(e=e.substring(0,a+c)+e.substring(a+this.diff_xIndex(u,d+v[1].length))),-1!==v[0]&&(d+=v[1].length)}}}}return[e=e.substring(n.length,e.length-n.length),i]},e.prototype.patch_addPadding=function(t){for(var e=this.Patch_Margin,n="",r=1;r<=e;r++)n+=String.fromCharCode(r);for(r=0;r<t.length;r++)t[r].start1+=e,t[r].start2+=e;var i=t[0],o=i.diffs;if(0==o.length||0!=o[0][0])o.unshift([0,n]),i.start1-=e,i.start2-=e,i.length1+=e,i.length2+=e;else if(e>o[0][1].length){var a=e-o[0][1].length;o[0][1]=n.substring(o[0][1].length)+o[0][1],i.start1-=a,i.start2-=a,i.length1+=a,i.length2+=a}if(0==(o=(i=t[t.length-1]).diffs).length||0!=o[o.length-1][0])o.push([0,n]),i.length1+=e,i.length2+=e;else if(e>o[o.length-1][1].length){a=e-o[o.length-1][1].length;o[o.length-1][1]+=n.substring(0,a),i.length1+=a,i.length2+=a}return n},e.prototype.patch_splitMax=function(t){for(var n=this.Match_MaxBits,r=0;r<t.length;r++)if(!(t[r].length1<=n)){var i=t[r];t.splice(r--,1);for(var o=i.start1,a=i.start2,s="";0!==i.diffs.length;){var f=new e.patch_obj,l=!0;for(f.start1=o-s.length,f.start2=a-s.length,""!==s&&(f.length1=f.length2=s.length,f.diffs.push([0,s]));0!==i.diffs.length&&f.length1<n-this.Patch_Margin;){var h=i.diffs[0][0],u=i.diffs[0][1];1===h?(f.length2+=u.length,a+=u.length,f.diffs.push(i.diffs.shift()),l=!1):-1===h&&1==f.diffs.length&&0==f.diffs[0][0]&&u.length>2*n?(f.length1+=u.length,o+=u.length,l=!1,f.diffs.push([h,u]),i.diffs.shift()):(u=u.substring(0,n-f.length1-this.Patch_Margin),f.length1+=u.length,o+=u.length,0===h?(f.length2+=u.length,a+=u.length):l=!1,f.diffs.push([h,u]),u==i.diffs[0][1]?i.diffs.shift():i.diffs[0][1]=i.diffs[0][1].substring(u.length))}s=(s=this.diff_text2(f.diffs)).substring(s.length-this.Patch_Margin);var c=this.diff_text1(i.diffs).substring(0,this.Patch_Margin);""!==c&&(f.length1+=c.length,f.length2+=c.length,0!==f.diffs.length&&0===f.diffs[f.diffs.length-1][0]?f.diffs[f.diffs.length-1][1]+=c:f.diffs.push([0,c])),l||t.splice(++r,0,f)}}},e.prototype.patch_toText=function(t){for(var e=[],n=0;n<t.length;n++)e[n]=t[n];return e.join("")},e.prototype.patch_fromText=function(t){var n=[];if(!t)return n;for(var r=t.split("\n"),i=0,o=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;i<r.length;){var a=r[i].match(o);if(!a)throw new Error("Invalid patch string: "+r[i]);var s=new e.patch_obj;for(n.push(s),s.start1=parseInt(a[1],10),""===a[2]?(s.start1--,s.length1=1):"0"==a[2]?s.length1=0:(s.start1--,s.length1=parseInt(a[2],10)),s.start2=parseInt(a[3],10),""===a[4]?(s.start2--,s.length2=1):"0"==a[4]?s.length2=0:(s.start2--,s.length2=parseInt(a[4],10)),i++;i<r.length;){var f=r[i].charAt(0);try{var l=decodeURI(r[i].substring(1))}catch(t){throw new Error("Illegal escape in patch_fromText: "+l)}if("-"==f)s.diffs.push([-1,l]);else if("+"==f)s.diffs.push([1,l]);else if(" "==f)s.diffs.push([0,l]);else{if("@"==f)break;if(""!==f)throw new Error('Invalid patch mode "'+f+'" in: '+l)}i++}}return n},e.patch_obj=function(){this.diffs=[],this.start1=null,this.start2=null,this.length1=0,this.length2=0},e.patch_obj.prototype.toString=function(){for(var t,e=["@@ -"+(0===this.length1?this.start1+",0":1==this.length1?this.start1+1:this.start1+1+","+this.length1)+" +"+(0===this.length2?this.start2+",0":1==this.length2?this.start2+1:this.start2+1+","+this.length2)+" @@\n"],n=0;n<this.diffs.length;n++){switch(this.diffs[n][0]){case 1:t="+";break;case-1:t="-";break;case 0:t=" "}e[n+1]=t+encodeURI(this.diffs[n][1])+"\n"}return e.join("").replace(/%20/g," ")},t.exports=e,t.exports.diff_match_patch=e,t.exports.DIFF_DELETE=-1,t.exports.DIFF_INSERT=1,t.exports.DIFF_EQUAL=0}(U={exports:{}},U.exports),U.exports),z=null,$=function(t){if(!z){var e=void 0;if("undefined"!=typeof diff_match_patch)e="function"==typeof diff_match_patch?new diff_match_patch:new diff_match_patch.diff_match_patch;else if(H)try{e=H&&new H}catch(t){e=null}if(!e){if(!t)return null;var n=new Error("text diff_match_patch library not found");throw n.diff_match_patch_not_found=!0,n}z={diff:function(t,n){return e.patch_toText(e.patch_make(t,n))},patch:function(t,n){for(var r=e.patch_apply(e.patch_fromText(n),t),i=0;i<r[1].length;i++){if(!r[1][i])new Error("text patch failed").textPatchFailed=!0}return r[0]}}}return z},Q=function(t){if("string"===t.leftType){var e=t.options&&t.options.textDiff&&t.options.textDiff.minLength||60;if(t.left.length<e||t.right.length<e)t.setResult([t.left,t.right]).exit();else{var n=$();if(n){var r=n.diff;t.setResult([r(t.left,t.right),0,2]).exit()}else t.setResult([t.left,t.right]).exit()}}};Q.filterName="texts";var J=function(t){if(!t.nested&&2===t.delta[2]){var e=$(!0).patch;t.setResult(e(t.left,t.delta[0])).exit()}};J.filterName="texts";var K=function(t){var e,n=void 0,r=void 0,i=void 0,o=void 0,a=null,s=/^@@ +-(\d+),(\d+) +\+(\d+),(\d+) +@@$/;for(n=0,e=(r=t.split("\n")).length;n<e;n++){var f=(i=r[n]).slice(0,1);"@"===f?(a=s.exec(i),r[n]="@@ -"+a[3]+","+a[4]+" +"+a[1]+","+a[2]+" @@"):"+"===f?(r[n]="-"+r[n].slice(1),"+"===r[n-1].slice(0,1)&&(o=r[n],r[n]=r[n-1],r[n-1]=o)):"-"===f&&(r[n]="+"+r[n].slice(1))}return r.join("\n")},Z=function(t){t.nested||2===t.delta[2]&&t.setResult([K(t.delta[0]),0,2]).exit()};Z.filterName="texts";var W=function(){function t(e){r(this,t),this.processor=new h(e),this.processor.pipe(new u("diff").append(w,_,q,Q,k,T).shouldHaveResult()),this.processor.pipe(new u("patch").append(A,B,b,J,j,S).shouldHaveResult()),this.processor.pipe(new u("reverse").append(M,V,x,Z,O,F).shouldHaveResult())}return i(t,[{key:"options",value:function(){var t;return(t=this.processor).options.apply(t,arguments)}},{key:"diff",value:function(t,e){return this.processor.process(new v(t,e))}},{key:"patch",value:function(t,e){return this.processor.process(new g(t,e))}},{key:"reverse",value:function(t){return this.processor.process(new y(t))}},{key:"unpatch",value:function(t,e){return this.patch(t,this.reverse(e))}},{key:"clone",value:function(t){return p(t)}}]),t}(),X="function"==typeof Array.isArray?Array.isArray:function(t){return t instanceof Array},G="function"==typeof Object.keys?function(t){return Object.keys(t)}:function(t){var e=[];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.push(n);return e},Y=function(t){return"_t"===t?-1:"_"===t.substr(0,1)?parseInt(t.slice(1),10):parseInt(t,10)+.1},tt=function(t,e){return Y(t)-Y(e)},et=function(){function t(){r(this,t)}return i(t,[{key:"format",value:function(t,e){var n={};return this.prepareContext(n),this.recurse(n,t,e),this.finalize(n)}},{key:"prepareContext",value:function(t){t.buffer=[],t.out=function(){var t;(t=this.buffer).push.apply(t,arguments)}}},{key:"typeFormattterNotFound",value:function(t,e){throw new Error("cannot format delta type: "+e)}},{key:"typeFormattterErrorFormatter",value:function(t,e){return e.toString()}},{key:"finalize",value:function(t){var e=t.buffer;if(X(e))return e.join("")}},{key:"recurse",value:function(t,e,n,r,i,o,a){var s=e&&o?o.value:n;if(void 0!==e||void 0!==r){var f=this.getDeltaType(e,o),l="node"===f?"a"===e._t?"array":"object":"";void 0!==r?this.nodeBegin(t,r,i,f,l,a):this.rootBegin(t,f,l);try{(this["format_"+f]||this.typeFormattterNotFound(t,f)).call(this,t,e,s,r,i,o)}catch(n){this.typeFormattterErrorFormatter(t,n,e,s,r,i,o),"undefined"!=typeof console&&console.error&&console.error(n.stack)}void 0!==r?this.nodeEnd(t,r,i,f,l,a):this.rootEnd(t,f,l)}}},{key:"formatDeltaChildren",value:function(t,e,n){var r=this;this.forEachDeltaKey(e,n,function(i,o,a,s){r.recurse(t,e[i],n?n[o]:void 0,i,o,a,s)})}},{key:"forEachDeltaKey",value:function(t,e,n){var r,i=G(t),o="a"===t._t,a={},s=void 0;if(void 0!==e)for(s in e)Object.prototype.hasOwnProperty.call(e,s)&&(void 0!==t[s]||o&&void 0!==t["_"+s]||i.push(s));for(s in t)if(Object.prototype.hasOwnProperty.call(t,s)){var f=t[s];X(f)&&3===f[2]&&(a[f[1].toString()]={key:s,value:e&&e[parseInt(s.substr(1))]},!1!==this.includeMoveDestinations&&void 0===e&&void 0===t[f[1]]&&i.push(f[1].toString()))}o?i.sort(tt):i.sort();for(var l=0,h=i.length;l<h;l++){var u=i[l];if(!o||"_t"!==u){var c=o?"number"==typeof u?u:parseInt("_"===(r=u).substr(0,1)?r.slice(1):r,10):u,d=l===h-1;n(u,c,a[c],d)}}}},{key:"getDeltaType",value:function(t,e){if(void 0===t)return void 0!==e?"movedestination":"unchanged";if(X(t)){if(1===t.length)return"added";if(2===t.length)return"modified";if(3===t.length&&0===t[2])return"deleted";if(3===t.length&&2===t[2])return"textdiff";if(3===t.length&&3===t[2])return"moved"}else if("object"===(void 0===t?"undefined":n(t)))return"node";return"unknown"}},{key:"parseTextDiff",value:function(t){for(var e=[],n=t.split("\n@@ "),r=0,i=n.length;r<i;r++){var o=n[r],a={pieces:[]},s=/^(?:@@ )?[-+]?(\d+),(\d+)/.exec(o).slice(1);a.location={line:s[0],chr:s[1]};for(var f=o.split("\n").slice(1),l=0,h=f.length;l<h;l++){var u=f[l];if(u.length){var c={type:"context"};"+"===u.substr(0,1)?c.type="added":"-"===u.substr(0,1)&&(c.type="deleted"),c.text=u.slice(1),a.pieces.push(c)}}e.push(a)}return e}}]),t}(),nt=Object.freeze({default:et}),rt=function(t){function e(){return r(this,e),s(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return a(e,et),i(e,[{key:"typeFormattterErrorFormatter",value:function(t,e){t.out('<pre class="jsondiffpatch-error">'+e+"</pre>")}},{key:"formatValue",value:function(t,e){t.out("<pre>"+it(JSON.stringify(e,null,2))+"</pre>")}},{key:"formatTextDiffString",value:function(t,e){var n=this.parseTextDiff(e);t.out('<ul class="jsondiffpatch-textdiff">');for(var r=0,i=n.length;r<i;r++){var o=n[r];t.out('<li><div class="jsondiffpatch-textdiff-location"><span class="jsondiffpatch-textdiff-line-number">'+o.location.line+'</span><span class="jsondiffpatch-textdiff-char">'+o.location.chr+'</span></div><div class="jsondiffpatch-textdiff-line">');for(var a=o.pieces,s=0,f=a.length;s<f;s++){var l=a[s];t.out('<span class="jsondiffpatch-textdiff-'+l.type+'">'+it(decodeURI(l.text))+"</span>")}t.out("</div></li>")}t.out("</ul>")}},{key:"rootBegin",value:function(t,e,n){var r="jsondiffpatch-"+e+(n?" jsondiffpatch-child-node-type-"+n:"");t.out('<div class="jsondiffpatch-delta '+r+'">')}},{key:"rootEnd",value:function(t){t.out("</div>"+(t.hasArrows?'<script type="text/javascript">setTimeout('+ot.toString()+",10);<\/script>":""))}},{key:"nodeBegin",value:function(t,e,n,r,i){var o="jsondiffpatch-"+r+(i?" jsondiffpatch-child-node-type-"+i:"");t.out('<li class="'+o+'" data-key="'+n+'"><div class="jsondiffpatch-property-name">'+n+"</div>")}},{key:"nodeEnd",value:function(t){t.out("</li>")}},{key:"format_unchanged",value:function(t,e,n){void 0!==n&&(t.out('<div class="jsondiffpatch-value">'),this.formatValue(t,n),t.out("</div>"))}},{key:"format_movedestination",value:function(t,e,n){void 0!==n&&(t.out('<div class="jsondiffpatch-value">'),this.formatValue(t,n),t.out("</div>"))}},{key:"format_node",value:function(t,e,n){var r="a"===e._t?"array":"object";t.out('<ul class="jsondiffpatch-node jsondiffpatch-node-type-'+r+'">'),this.formatDeltaChildren(t,e,n),t.out("</ul>")}},{key:"format_added",value:function(t,e){t.out('<div class="jsondiffpatch-value">'),this.formatValue(t,e[0]),t.out("</div>")}},{key:"format_modified",value:function(t,e){t.out('<div class="jsondiffpatch-value jsondiffpatch-left-value">'),this.formatValue(t,e[0]),t.out('</div><div class="jsondiffpatch-value jsondiffpatch-right-value">'),this.formatValue(t,e[1]),t.out("</div>")}},{key:"format_deleted",value:function(t,e){t.out('<div class="jsondiffpatch-value">'),this.formatValue(t,e[0]),t.out("</div>")}},{key:"format_moved",value:function(t,e){t.out('<div class="jsondiffpatch-value">'),this.formatValue(t,e[0]),t.out('</div><div class="jsondiffpatch-moved-destination">'+e[1]+"</div>"),t.out('<div class="jsondiffpatch-arrow" style="position: relative; left: -34px;">\n          <svg width="30" height="60" style="position: absolute; display: none;">\n          <defs>\n              <marker id="markerArrow" markerWidth="8" markerHeight="8"\n                 refx="2" refy="4"\n                     orient="auto" markerUnits="userSpaceOnUse">\n                  <path d="M1,1 L1,7 L7,4 L1,1" style="fill: #339;" />\n              </marker>\n          </defs>\n          <path d="M30,0 Q-10,25 26,50"\n            style="stroke: #88f; stroke-width: 2px; fill: none; stroke-opacity: 0.5; marker-end: url(#markerArrow);"\n          ></path>\n          </svg>\n      </div>'),t.hasArrows=!0}},{key:"format_textdiff",value:function(t,e){t.out('<div class="jsondiffpatch-value">'),this.formatTextDiffString(t,e[0]),t.out("</div>")}}]),e}();function it(t){for(var e=t,n=[[/&/g,"&amp;"],[/</g,"&lt;"],[/>/g,"&gt;"],[/'/g,"&apos;"],[/"/g,"&quot;"]],r=0;r<n.length;r++)e=e.replace(n[r][0],n[r][1]);return e}var ot=function(t){var e=t||document;!function(t,e,n){for(var r=t.querySelectorAll(e),i=0,o=r.length;i<o;i++)n(r[i])}(e,".jsondiffpatch-arrow",function(t){var e=t.parentNode,n=t.children,r=t.style,i=e,o=n[0],a=o.children[1];o.style.display="none";var s,f,l,h=(s=i.querySelector(".jsondiffpatch-moved-destination"),f=s.textContent,l=s.innerText,f||l),u=i.parentNode,c=void 0;if(function(t,e){for(var n=t.children,r=0,i=n.length;r<i;r++)e(n[r],r)}(u,function(t){t.getAttribute("data-key")===h&&(c=t)}),c)try{var d=c.offsetTop-i.offsetTop;o.setAttribute("height",Math.abs(d)+6),r.top=-8+(d>0?0:d)+"px";var p=d>0?"M30,0 Q-10,"+Math.round(d/2)+" 26,"+(d-4):"M30,"+-d+" Q-10,"+Math.round(-d/2)+" 26,4";a.setAttribute("d",p),o.style.display=""}catch(t){}})},at=function(t,e,n){var r=e||document.body,i="jsondiffpatch-unchanged-",o={showing:i+"showing",hiding:i+"hiding",visible:i+"visible",hidden:i+"hidden"},a=r.classList;if(a){if(!n)return a.remove(o.showing),a.remove(o.hiding),a.remove(o.visible),a.remove(o.hidden),void(!1===t&&a.add(o.hidden));!1===t?(a.remove(o.showing),a.add(o.visible),setTimeout(function(){a.add(o.hiding)},10)):(a.remove(o.hiding),a.add(o.showing),a.remove(o.hidden));var s=setInterval(function(){ot(r)},100);setTimeout(function(){a.remove(o.showing),a.remove(o.hiding),!1===t?(a.add(o.hidden),a.remove(o.visible)):(a.add(o.visible),a.remove(o.hidden)),setTimeout(function(){a.remove(o.visible),clearInterval(s)},n+400)},n)}},st=void 0;var ft=Object.freeze({showUnchanged:at,hideUnchanged:function(t,e){return at(!1,t,e)},default:rt,format:function(t,e){return st||(st=new rt),st.format(t,e)}}),lt=function(t){function e(){r(this,e);var t=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t.includeMoveDestinations=!1,t}return a(e,et),i(e,[{key:"prepareContext",value:function(t){o(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"prepareContext",this).call(this,t),t.indent=function(t){this.indentLevel=(this.indentLevel||0)+(void 0===t?1:t),this.indentPad=new Array(this.indentLevel+1).join("&nbsp;&nbsp;")},t.row=function(e,n){t.out('<tr><td style="white-space: nowrap;"><pre class="jsondiffpatch-annotated-indent" style="display: inline-block">'),t.out(t.indentPad),t.out('</pre><pre style="display: inline-block">'),t.out(e),t.out('</pre></td><td class="jsondiffpatch-delta-note"><div>'),t.out(n),t.out("</div></td></tr>")}}},{key:"typeFormattterErrorFormatter",value:function(t,e){t.row("",'<pre class="jsondiffpatch-error">'+e+"</pre>")}},{key:"formatTextDiffString",value:function(t,e){var n=this.parseTextDiff(e);t.out('<ul class="jsondiffpatch-textdiff">');for(var r=0,i=n.length;r<i;r++){var o=n[r];t.out('<li><div class="jsondiffpatch-textdiff-location"><span class="jsondiffpatch-textdiff-line-number">'+o.location.line+'</span><span class="jsondiffpatch-textdiff-char">'+o.location.chr+'</span></div><div class="jsondiffpatch-textdiff-line">');for(var a=o.pieces,s=0,f=a.length;s<f;s++){var l=a[s];t.out('<span class="jsondiffpatch-textdiff-'+l.type+'">'+l.text+"</span>")}t.out("</div></li>")}t.out("</ul>")}},{key:"rootBegin",value:function(t,e,n){t.out('<table class="jsondiffpatch-annotated-delta">'),"node"===e&&(t.row("{"),t.indent()),"array"===n&&t.row('"_t": "a",',"Array delta (member names indicate array indices)")}},{key:"rootEnd",value:function(t,e){"node"===e&&(t.indent(-1),t.row("}")),t.out("</table>")}},{key:"nodeBegin",value:function(t,e,n,r,i){t.row("&quot;"+e+"&quot;: {"),"node"===r&&t.indent(),"array"===i&&t.row('"_t": "a",',"Array delta (member names indicate array indices)")}},{key:"nodeEnd",value:function(t,e,n,r,i,o){"node"===r&&t.indent(-1),t.row("}"+(o?"":","))}},{key:"format_unchanged",value:function(){}},{key:"format_movedestination",value:function(){}},{key:"format_node",value:function(t,e,n){this.formatDeltaChildren(t,e,n)}}]),e}(),ht=function(t){return'<pre style="display:inline-block">&quot;'+t+"&quot;</pre>"},ut={added:function(t,e,n,r){var i=" <pre>([newValue])</pre>";return void 0===r?"new value"+i:"number"==typeof r?"insert at index "+r+i:"add property "+ht(r)+i},modified:function(t,e,n,r){var i=" <pre>([previousValue, newValue])</pre>";return void 0===r?"modify value"+i:"number"==typeof r?"modify at index "+r+i:"modify property "+ht(r)+i},deleted:function(t,e,n,r){var i=" <pre>([previousValue, 0, 0])</pre>";return void 0===r?"delete value"+i:"number"==typeof r?"remove index "+r+i:"delete property "+ht(r)+i},moved:function(t,e,n,r){return'move from <span title="(position to remove at original state)">index '+r+'</span> to <span title="(position to insert at final state)">index '+t[1]+"</span>"},textdiff:function(t,e,n,r){return"text diff"+(void 0===r?"":"number"==typeof r?" at index "+r:" at property "+ht(r))+', format is <a href="https://code.google.com/p/google-diff-match-patch/wiki/Unidiff">a variation of Unidiff</a>'}},ct=function(t,e){var n=this.getDeltaType(e),r=ut[n],i=r&&r.apply(r,Array.prototype.slice.call(arguments,1)),o=JSON.stringify(e,null,2);"textdiff"===n&&(o=o.split("\\n").join('\\n"+\n   "')),t.indent(),t.row(o,i),t.indent(-1)};lt.prototype.format_added=ct,lt.prototype.format_modified=ct,lt.prototype.format_deleted=ct,lt.prototype.format_moved=ct,lt.prototype.format_textdiff=ct;var dt=void 0;var pt=Object.freeze({default:lt,format:function(t,e){return dt||(dt=new lt),dt.format(t,e)}}),vt="add",gt="remove",yt="replace",mt="move",_t=function(t){function e(){r(this,e);var t=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t.includeMoveDestinations=!0,t}return a(e,et),i(e,[{key:"prepareContext",value:function(t){o(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"prepareContext",this).call(this,t),t.result=[],t.path=[],t.pushCurrentOp=function(t){var e=t.op,n=t.value,r={op:e,path:this.currentPath()};void 0!==n&&(r.value=n),this.result.push(r)},t.pushMoveOp=function(t){var e=this.currentPath();this.result.push({op:mt,from:e,path:this.toPath(t)})},t.currentPath=function(){return"/"+this.path.join("/")},t.toPath=function(t){var e=this.path.slice();return e[e.length-1]=t,"/"+e.join("/")}}},{key:"typeFormattterErrorFormatter",value:function(t,e){t.out("[ERROR] "+e)}},{key:"rootBegin",value:function(){}},{key:"rootEnd",value:function(){}},{key:"nodeBegin",value:function(t,e,n){t.path.push(n)}},{key:"nodeEnd",value:function(t){t.path.pop()}},{key:"format_unchanged",value:function(){}},{key:"format_movedestination",value:function(){}},{key:"format_node",value:function(t,e,n){this.formatDeltaChildren(t,e,n)}},{key:"format_added",value:function(t,e){t.pushCurrentOp({op:vt,value:e[0]})}},{key:"format_modified",value:function(t,e){t.pushCurrentOp({op:yt,value:e[1]})}},{key:"format_deleted",value:function(t){t.pushCurrentOp({op:gt})}},{key:"format_moved",value:function(t,e){var n=e[1];t.pushMoveOp(n)}},{key:"format_textdiff",value:function(){throw new Error("Not implemented")}},{key:"format",value:function(t,e){var n={};return this.prepareContext(n),this.recurse(n,t,e),n.result}}]),e}(),bt=function(t){return t[t.length-1]},xt=function(t){return n=function(t,e){var n,r,i,o,a=t.path.split("/"),s=e.path.split("/");return a.length!==s.length?a.length-s.length:(n=bt(a),r=bt(s),i=parseInt(n,10),o=parseInt(r,10),isNaN(i)||isNaN(o)?0:o-i)},(e=t).sort(n),e;var e,n},wt=function(t,e){var n=Array(e.length+1).fill().map(function(){return[]});return t.map(function(t){var n=e.map(function(e){return e(t)}).indexOf(!0);return n<0&&(n=e.length),{item:t,position:n}}).reduce(function(t,e){return t[e.position].push(e.item),t},n)},kt=function(t){return"move"===t.op},jt=function(t){return"remove"===t.op},At=void 0,Ot=function(t,e){return At||(At=new _t),n=At.format(t,e),r=wt(n,[kt,jt]),i=f(r,3),o=i[0],a=i[1],s=i[2],h=xt(a),[].concat(l(h),l(o),l(s));var n,r,i,o,a,s,h},Mt=Object.freeze({default:_t,partitionOps:wt,format:Ot,log:function(t,e){console.log(Ot(t,e))}});function Rt(t){return e&&e[t]||function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];return e}}var Ct={added:Rt("green"),deleted:Rt("red"),movedestination:Rt("gray"),moved:Rt("yellow"),unchanged:Rt("gray"),error:Rt("white.bgRed"),textDiffLine:Rt("gray")},Et=function(t){function e(){r(this,e);var t=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t.includeMoveDestinations=!1,t}return a(e,et),i(e,[{key:"prepareContext",value:function(t){o(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"prepareContext",this).call(this,t),t.indent=function(t){this.indentLevel=(this.indentLevel||0)+(void 0===t?1:t),this.indentPad=new Array(this.indentLevel+1).join("  "),this.outLine()},t.outLine=function(){this.buffer.push("\n"+(this.indentPad||""))},t.out=function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];for(var r=0,i=e.length;r<i;r++){var o=e[r].split("\n").join("\n"+(this.indentPad||""));this.color&&this.color[0]&&(o=this.color[0](o)),this.buffer.push(o)}},t.pushColor=function(t){this.color=this.color||[],this.color.unshift(t)},t.popColor=function(){this.color=this.color||[],this.color.shift()}}},{key:"typeFormattterErrorFormatter",value:function(t,e){t.pushColor(Ct.error),t.out("[ERROR]"+e),t.popColor()}},{key:"formatValue",value:function(t,e){t.out(JSON.stringify(e,null,2))}},{key:"formatTextDiffString",value:function(t,e){var n=this.parseTextDiff(e);t.indent();for(var r=0,i=n.length;r<i;r++){var o=n[r];t.pushColor(Ct.textDiffLine),t.out(o.location.line+","+o.location.chr+" "),t.popColor();for(var a=o.pieces,s=0,f=a.length;s<f;s++){var l=a[s];t.pushColor(Ct[l.type]),t.out(l.text),t.popColor()}r<i-1&&t.outLine()}t.indent(-1)}},{key:"rootBegin",value:function(t,e,n){t.pushColor(Ct[e]),"node"===e&&(t.out("array"===n?"[":"{"),t.indent())}},{key:"rootEnd",value:function(t,e,n){"node"===e&&(t.indent(-1),t.out("array"===n?"]":"}")),t.popColor()}},{key:"nodeBegin",value:function(t,e,n,r,i){t.pushColor(Ct[r]),t.out(n+": "),"node"===r&&(t.out("array"===i?"[":"{"),t.indent())}},{key:"nodeEnd",value:function(t,e,n,r,i,o){"node"===r&&(t.indent(-1),t.out("array"===i?"]":"}"+(o?"":","))),o||t.outLine(),t.popColor()}},{key:"format_unchanged",value:function(t,e,n){void 0!==n&&this.formatValue(t,n)}},{key:"format_movedestination",value:function(t,e,n){void 0!==n&&this.formatValue(t,n)}},{key:"format_node",value:function(t,e,n){this.formatDeltaChildren(t,e,n)}},{key:"format_added",value:function(t,e){this.formatValue(t,e[0])}},{key:"format_modified",value:function(t,e){t.pushColor(Ct.deleted),this.formatValue(t,e[0]),t.popColor(),t.out(" => "),t.pushColor(Ct.added),this.formatValue(t,e[1]),t.popColor()}},{key:"format_deleted",value:function(t,e){this.formatValue(t,e[0])}},{key:"format_moved",value:function(t,e){t.out("==> "+e[1])}},{key:"format_textdiff",value:function(t,e){this.formatTextDiffString(t,e[0])}}]),e}(),Pt=void 0,Dt=function(t,e){return Pt||(Pt=new Et),Pt.format(t,e)};var Tt=Object.freeze({default:Et,format:Dt,log:function(t,e){console.log(Dt(t,e))}}),Nt=Object.freeze({base:nt,html:ft,annotated:pt,jsonpatch:Mt,console:Tt});var It=void 0;t.DiffPatcher=W,t.formatters=Nt,t.console=Tt,t.create=function(t){return new W(t)},t.dateReviver=function(t,e){var n=void 0;return"string"==typeof e&&(n=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d*))?(Z|([+-])(\d{2}):(\d{2}))$/.exec(e))?new Date(Date.UTC(+n[1],+n[2]-1,+n[3],+n[4],+n[5],+n[6],+(n[7]||0))):e},t.diff=function(){return It||(It=new W),It.diff.apply(It,arguments)},t.patch=function(){return It||(It=new W),It.patch.apply(It,arguments)},t.unpatch=function(){return It||(It=new W),It.unpatch.apply(It,arguments)},t.reverse=function(){return It||(It=new W),It.reverse.apply(It,arguments)},t.clone=function(){return It||(It=new W),It.clone.apply(It,arguments)},Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=/sm/c1efa94280544d6a6fd3d1cab24d9d9eae663bf9d9671f40a1a5329f0901a71e.map

var jsondiffpatch2 = jsondiffpatch.create();
jsondiffpatch2.processor.pipes.diff.before('trivial', function ignoreFunctionDiffFilter(context) {
    if (typeof context.left === 'function' || typeof context.right === 'function' ) {
        context.setResult(undefined);
        context.exit();
    }
});

</script>



<scriptold src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.4.0/min/dropzone.min.js"></scriptold>
<script src="/js_libs/dropzone5.4.0.js"></script>





<style>
.containerclasslargetext {
container-type: inline-size;
}
.containerclassmediumtext {
container-type: inline-size;
}
.containerclasssmalltext {
container-type: inline-size;
}
.containerclasshugetext {
container-type: inline-size;
}
.containerclasshugetext {
container-type: inline-size;
}
.containerclass {
container-type: inline-size;
}
@container  (min-width: 0px) {
.containerclass > * {
font-size: var(--fontresizable);
}
}

@container  (min-width: 0px) {
.containerclasslargetext > * {
font-size: 25cqw;
}
}
@container  (min-width: 0px) {
.containerclassmediumtext > * {
font-size: 15cqw;
}
}
@container  (min-width: 0px) {
.containerclasssmalltext > * {
font-size: 5cqw;
}
}
@container  (min-width: 0px) {
.containerclasshugetext > * {
font-size: 50cqw;
}
}



blink {
-webkit-animation: 2s linear infinite condemned_blink_effect; /* for Safari 4.0 - 8.0 */
animation: 2s linear infinite condemned_blink_effect;
}

/* for Safari 4.0 - 8.0 */
@-webkit-keyframes condemned_blink_effect {
0% {
visibility: hidden;
}
50% {
visibility: hidden;
}
100% {
visibility: visible;
}
}

@keyframes condemned_blink_effect {
0% {
visibility: hidden;
}
50% {
visibility: hidden;
}
100% {
visibility: visible;
}
}

.force_scrollbars {
overflow-y: auto;
border: 1px solid black;
height: 3em;
width: 100%;
line-height: 1em;
}

.force_scrollbars::-webkit-scrollbar {
-webkit-appearance: none;
}

.force_scrollbars::-webkit-scrollbar:vertical {
width: 11px;
}

.force_scrollbars::-webkit-scrollbar:horizontal {
height: 11px;
}

.force_scrollbars::-webkit-scrollbar-thumb {
border-radius: 8px;
border: 2px solid white; /* should match background, can't be transparent */
background-color: rgba(0, 0, 0, .5);
}
</style>



<style>
.ace_gutter-cell.ace_breakpoint{
border-radius: 20px 0px 0px 20px;
box-shadow: 0px 0px 1px 1px red inset;
}
.app_card {
top:    100px;
width:  200px;
height: 200px;
transition: width .5s ease-in-out, height .5s ease-in-out, top .5s ease-in-out;
}
.app_card:hover{
/*...*/
transition: width .5s ease-in-out, height .5s ease-in-out, top .5s ease-in-out;
top:    0px;
width:  330px;
height: 330px;
}
.right_project_pane_collapsed {
height: 15%;
transition: all .5s ease-out;
}
.right_project_pane_expanded {
height: 85%;
transition: all .5s ease-out;
}


.right_properties_pane_collapsed {
height: 85%;
transition: all .5s ease-out;
}
.right_properties_pane_expanded {
height: 15%;
transition: all .5s ease-out;
}
.selected_pane_title {
background-color:#000099;
color: white;
transition: all .2s ease-out;
}
.unselected_pane_title {
background-color:darkgray;
color: white;
transition: all .1s ease-out;
}
.selected_pane_title_slower {
background-color:#000099;
color: white;
transition: all .7s ease-out;
}
.unselected_pane_title_slower {
background-color:darkgray;
color: white;
transition: all .3s ease-out;
}
div.ace_editor.ace_autocomplete {
width: 40%
}
</style>


<style>




<style>
.reload { font-family: Lucida Sans Unicode }
</style>


<script>
</script>


<script src="https://cdn.socket.io/4.5.3/socket.io.min.js" integrity="sha384-WPFUvHkB1aHA5TDSZi6xtDgkF0wXJcIIxXhC6h8OT8EH3fC5PWro5pWJ1THjcfEi" crossorigin="anonymous"></script>
<scriptold src="/js_libs/socketio4.4.1.js"  crossorigin="anonymous"></scriptold>

<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.7.14/vue.min.js"></script>
<scriptold src="/js_libs/vue2.6.11.js"></scriptold>


<script>




/*
________________________________________
|                                      |
|         registerComponent            |
|                                      |
|______________________________________|
Every UI component in a GUI app must register itself here
__________
| PARAMS |______________________________________________________________
|
|     vueComponentObject    The Vue object. From the component that
|     ------------------    is registering itself, it calls register(this)
|                           from it's mount: method
|________________________________________________________________________ */
function registerComponent(vueComponentObject) {

    /*
    ____________________________________________________________
    |    registerComponent
    |_________________________
                             | part
                             |
                             | longer description
                             |__________________________________ */
    if (vueComponentObject) {
        let args        = vueComponentObject.args
        let argsPrefix  = "args"
        if (vueComponentObject.properties) {
            args = vueComponentObject.properties
            argsPrefix = "properties"
        }
        if (args && args.name) {
            let cccname = args.name

            for (let oneProperty of GLOBALS.getControlPropertyDefns({baseComponentId: args.base_component_id})) {
                let propNamee = oneProperty.id
                let propType = oneProperty.type
                if (propNamee) {
                    vueComponentObject.$watch(argsPrefix + '.' + propNamee, function(newValue, oldValue) {

                    if (propType != "Action") {
                        console.log(cccname + '.' + propNamee + ' = ' + oldValue + ' to ' + newValue );
                    }
                    let designTimeOnlyEvents = false

                    if (oneProperty.design_time_only_events) {
                        designTimeOnlyEvents = true
                    }

                    if (vueComponentObject && vueComponentObject.meta) {
                        if (vueComponentObject.meta.getEditor) {
                            vueComponentObject.meta.getEditor().processControlEvent(
                                {
                                    type: "subcomponent_event",
                                    form_name: vueComponentObject.meta.getEditor().active_form,
                                    control_name: vueComponentObject[argsPrefix].name,
                                    sub_type: "on_property_changed",
                                    code: vueComponentObject[argsPrefix].on_property_changed,
                                    design_time_only_events: designTimeOnlyEvents,

                                    args:
                                        {
                                            form: vueComponentObject.meta.getEditor().active_form,
                                            component: vueComponentObject[argsPrefix].name,
                                            property: propNamee,
                                            value: newValue,
                                            old_value: oldValue,
                                            new_value: newValue
                                        }
                                })
                        }

                    }
                    });
                }
            }
        }

    }




    /*
    ____________________________________________________________
    |    registerComponent
    |_________________________
                             | part
                             |
                             | longer description
                             |__________________________________ */
    if (isValidObject(vueComponentObject)) {
        let  usePropVar = vueComponentObject.args
        if (!isValidObject(usePropVar)) {
            usePropVar = vueComponentObject.properties
        }
        if (!isValidObject(usePropVar)) {
            usePropVar = vueComponentObject.props
        }



        if (isValidObject(usePropVar)) {
            if (isValidObject(usePropVar.name)) {
                if (vueComponentObject.design_mode) {
                    GLOBALS.designModeUiControlNameReturnsVueInstance[usePropVar.name] =  vueComponentObject
                } else {
                    GLOBALS.runtimeUiControlNameReturnsVueInstance[usePropVar.name] =  vueComponentObject
                }
            }

            if (isValidObject(usePropVar.load) && isValidObject(vueComponentObject.meta) ) {

                setTimeout(function() {
                    vueComponentObject.$emit('send', {
                        type:               "subcomponent_event",
                        form_name:           vueComponentObject.meta.form,
                        control_name:        vueComponentObject.meta.name,
                        code:                usePropVar.load
                    })
                },350)

            }
        }
    }
}












function unregisterComponent(componentName) {
    GLOBALS.designModeUiControlNameReturnsVueInstance[componentName]   = null
    GLOBALS.runtimeUiControlNameReturnsVueInstance[componentName]               = null
}




function base64ToUint8Array (string) {
let raw = atob(string);
let rawLength = raw.length;
let array = new Uint8Array(new ArrayBuffer(rawLength));
for (let i = 0; i < rawLength; i += 1) {
array[i] = raw.charCodeAt(i);
}
return array;
}
if (window.SQL) {
localSqliteDb = new window.SQL.Database()
}
function localSql(sql, params) {
    if (!window.SQL) {
        console.log("Local SQLite only works for static Creator apps")
    } else {
        resOut = []
        try {
            let stmt = localSqliteDb.prepare(sql);
            let res = stmt.bind(params)
            let moreRows = stmt.step()
            while (moreRows) {
                let newRow = stmt.getAsObject()
                resOut.push(newRow)
                moreRows = stmt.step()
            }
            stmt.free();
        } catch (err) {
            console.log(err)
        }
        return resOut
    }
}
String.prototype.replaceAll = function(search, replacement) {
    let target = this;
    return target.replace(new RegExp(search, 'g'), replacement);
};

var useProtocol = location.protocol
var useHostname = null
var usePort = null

async function initFn() {
    setTimeout(async function(){

        Vue.component('card_component', {
            props: ["item","visible","element_id", "full_screen", "card_selected", "is_static"]
            ,
            mounted: async function() {
                let mm = this

                globalEventBus.$on('hide_settings',
                    async function() {
                        mm.showSettings = false
                    });
                globalEventBus.$on('show_settings',
                    async function() {
                        mm.showSettings = true
                    });
            }
            ,
            methods: {
        click_card: async function(id) {
        autoScroll = false;
        await select_card(id)
        }
        ,
        updateComments: async function() {
        let mm                           = this
        let newrestUrl = location.protocol + "//" + getNetworkHostName() + ":" +
        location.port + "/get_comments_for_component" + "/" +
        "?"

        callAjaxPost(newrestUrl
        ,
        {
        base_component_id: base_component_id
        ,
        base_component_id_version: null
        }
        ,
        function(response) {
        //debugger
        let resp = JSON.parse(response)
        mm.new_comment = ""
        mm.new_rating = 0
        if (resp.status == "ok")
        mm.comments = resp.comments_and_ratings
        })


        }
        ,
        submitComment: async function() {
        let mm                           = this

        //debugger
        mm.submit_error_message = ""
        if (mm.new_comment.length < 5) {
        mm.submit_error_message = "You must enter a comment to rate this"
        return
        }

        if (mm.new_rating == 0 ) {
        mm.submit_error_message = "You must enter a rating"
        return
        }


        let newrestUrl = location.protocol + "//" + getNetworkHostName() + ":" +
        location.port + "/submit_comment" + "/" +
        "?"

        callAjaxPost(newrestUrl
        ,
        {
        base_component_id: base_component_id
        ,
        base_component_id_version: null
        ,
        comment: mm.new_comment
        ,
        rating: mm.new_rating
        }
        ,
        function(response) {
        //debugger
        let resp = JSON.parse(response)
        mm.new_comment = ""
        mm.new_rating = 0
        if (resp.status == "ok")
        {
        mm.comments = resp.comments_and_ratings
        mm.submit_info_message = "Comment submitted"
        }
        })

        }
        ,
        openInfo: async function(useTab) {
        //debugger
        let mm = this
        if (mm.tab == useTab) {
        mm.tab = ""
        mm.show_page_info=false;
        } else {
        mm.tab = useTab
        mm.show_page_info = true
        await mm.updateComments()
        }
        }
        ,
                logInWithMetamask: async function() {
                    let mm = this
                    //debugger
                    if (window.ethereum) {
                        await useWeb3()
                        setTimeout(async function() {
                            let accs        = await web3.eth.getAccounts()
                            let accNo       = accs[0]
                            let openfileurl = "http" + (($HOSTPORT == 443)?"s":"") + "://" + $HOST + "/login_with_metamask?" +
                                new URLSearchParams({
                                    metamask_account_id: accNo
                                })
                            fetch(openfileurl, {
                                method: 'get',
                                credentials: "include"
                            })
                            .then((response) => response.json())
                            .then(async function(responseJson)
                            {
                                let seed = responseJson.seed
                                let signMessage =   signMessageTemplate + seed
                                let signedTx = await mm.signTransactionV2(signMessage)

                                let checkSeedurl = "http" + (($HOSTPORT == 443)?"s":"") + "://" + $HOST + "/check_metamask_seed?" +
                                new URLSearchParams({
                                    metamask_account_id: accNo
                                    ,
                                    signedTx: signedTx
                                    ,
                                    sign_message: signMessage
                                    ,
                                    random_seed: seed
                                })

                                fetch(checkSeedurl, {
                                    method: 'get',
                                    credentials: "include"
                                })
                                .then((response2) => response2.json())
                                .then(async function(responseJson2)
                                {
                                    if (responseJson2.error) {
                                        mm.login_error_message =  responseJson2.error
                                    } else {
                                        mm.accountNumber = accs[0]
                                        mm.show_page_info   = false;
                                        mm.tab              = ""

                                    }

                                })
                                .catch(err => {
                                    //error block
                                })
                                mm.accountNumber = accs[0]

                            })
                            .catch(err => {
                                //error block
                            })

                        },100)
                    }
                }
                ,
        signTransactionV2: async function(test_transaction_text) {
        let currentETHACC = (await web3.eth.getAccounts())[0]
        let signedTx = //await web3.eth.sign(test_transaction_text, (await web3.eth.getAccounts())[0] );
        await ethereum.request({
        method: 'personal_sign',
        params: [test_transaction_text   //message
        ,
        currentETHACC
        // account
        //,
        //test_transaction_text   //password?
        ],
        });
        return signedTx
        }
        ,
                signMetamaskLoginTransaction: async function() {
                    let mm                          = this
                    let test_transaction_text_el    = document.getElementById("test_transaction_text")
                    let test_transaction_text       = test_transaction_text_el.value
                    let currentETHACC               = (await web3.eth.getAccounts())[0]

                    mm.debug_sign_tx_out = //await web3.eth.sign(test_transaction_text, (await web3.eth.getAccounts())[0] );
                    await ethereum.request({
                        method: 'personal_sign',
                        params: [
                            test_transaction_text   //message
                            ,
                            currentETHACC
                            // account
                            //,
                            //test_transaction_text   //password?
                        ],
                    });
                }

            },
        data: function () {
        return {
        show_page_info: false
        ,
        accountNumber: null
        ,
        comments:
        [
        ]
        ,
        rating: 0
        ,
        new_rating: 0
        ,
        numRatings: 0
        ,
        new_comment: ""
        ,
        submit_error_message: ""
        ,
        login_error_message: ""
        ,
        submit_info_message: ""
        ,
        tab: ""
        ,
        debug_sign_tx_out: ""
        ,
        showSettings: true
        }
        }
        ,

        template:
        `<span   v-bind:id='element_id'
                 v-bind:style="'padding:0px;position: relative; margin: auto;height:100%;width:100%;border:0px; overflow-y:none;'"
                 v-on:click='click_card(item.id)'
                 v-bind:class='card_selected?(is_static?"container":" container"):" container"' >

            <div
            v-if="showSettings"
            style='background-color:navy;height:5vh;width: 100vw;color:white;'>



                <!-- ------------------------------------------------
                The top menu items for the info pane
                ------------------------------------------------ -->
                <span
                    v-on:click=' openInfo("login")'
                    v-on:touchstart=' openInfo("login")'
                    style='height:100%;margin-left:20px;vertical-align:middle;'
                    >
                    {{ accountNumber?("" + accountNumber).substring(0,5) + "...":"Login" }}
                </span>


                <span
                    style='margin-left: 30px;'
                    v-on:click=' openInfo("comments")'
                    v-on:touchstart=' openInfo("comments")'
                    style='height:100%;margin-left:20px;vertical-align:middle;'
                    >
                    Comments
                </span>


                <span
                    style='margin-left: 30px;'
                    v-on:click=' openInfo("debug")'
                    v-on:touchstart=' openInfo("debug")'
                    style='height:100%;margin-left:20px;vertical-align:middle;'
                >
                    Debug

                </span>


                <span
                    style='height:100%;margin-left:20px;vertical-align:middle;'
                    v-if='show_page_info'
                    v-on:click='show_page_info=false;tab=""'
                    v-on:touchstart='show_page_info=false;'
                >
                    Close
                </span>
            </div>



            <div    v-if='show_page_info'
                    style='width:100vw; height:100vh;color:white;background-color:navy;padding:20px;'>

                <!-- ------------------------------------------------
                LOGIN pane
                ------------------------------------------------ -->
                <div v-if='tab=="login"'>

                <div v-if='accountNumber'>Metamask Account Number: {{accountNumber}}</div>
                <div v-else='accountNumber'>Logging in to Metamask will bring the Metamask popup and you will be
                requested to authorise the login</div>

                <div style='color:red' id='login_error'>{{login_error_message}}</div>

                <button type=button
                    class='btn btn-primary'
                    style='margin-left: 10px;width:40vw;height:15vh;'
                    v-on:click='logInWithMetamask()'>

                    <img    src="/driver_icons/metamaskfox.svg"
                            style="height:100%;width:100%"
                    />
                </button>

            </div>



            <!-- ------------------------------------------------

            Comments pane

            ------------------------------------------------ -->

            <div v-if='tab=="comments"'>

                <div style=";height:40vh">

                    Add comment
                    <br>
                    <textarea   style='display: inline-block;'
                                id='new_comment'
                                v-model='new_comment'>
                    </textarea>
                    <br><br>

                    Rating (1-5, 5 is best):<br>
                    <input  id="new_rating"
                    v-model="new_rating"
                    type="range"
                    min="0"
                    max="5"
                    value="0">
                    </input>{{new_rating}}
                    <br>
                    <button type=button class='btn btn-primary' style='margin-left: 10px' v-on:click='submitComment()'>
                    Submit comment
                    </button>
                    <div style='color:red' id='submit_error'>{{submit_error_message}}</div>
                    <div style='color:green' id='submit_info'>{{submit_info_message}}</div>

                </div>



                <div style="overflow: scroll;height:40vh">
                    <b>Previous comments:</b>
                    <li v-for='comment in comments'
                    style='color:white;background-color:navy;'>
                    {{comment.comment}} , {{comment.rating}} , {{msToTime(comment.date_and_time)}}

                    </li>
                </div>

            </div>






            <!-- -------------------------------------------------
             |                                                   |
             |                    DEBUG pane                     |
             |                                                   |
             -------------------------------------------------- -->

            <div v-if='tab=="debug"'>

                <div v-if='!accountNumber'>
                    You are not signed into Metamask. Please login first
                </div>

                <textarea id="test_transaction_text"
                          value="">
                </textarea>

                <button type=button
                        class='btn btn-primary'
                        v-bind:disabled='accountNumber?false:true'
                        style='margin-left: 10px;width:40vw;height:15vh;'
                        v-on:click='signMetamaskTransaction()'>

                    Sign transaction
                </button>


                <div>
                    {{debug_sign_tx_out}}
                </div>


                <div    style="background-color: black; color: white; text-align: center;"
                        v-on:click='showProgressBar();setupPublicWebSocket()' >

                        Edit this app
                </div>
            </div>
        </div>



          <div
              v-bind:style="'; padding:0px; font-family: Helvetica ;  width: 100vw ;visibility: ' + (visible?'':'hidden') + ';' ">







                    <div    v-if='full_screen && (item.card.type == "app")'>

                        <div    v-bind:id='"app_container_"+ item.id'  >
                            <div v-bind:id='"app_"+ item.id' >
                            </div>
                        </div>
                    </div>
                    <div style='height: 2em;'></div>

            </div>
        </div>`
        })











        mainMoonApp = new Vue({
        el: "#infinite-list"
        ,
        data: function() {
        return {
        count: 1
        ,
        is_gui_app:              true
        ,
        console_output:         ""
        ,
        selected_card: -1
        ,
        cards: []
        ,
        show_loader: false
        ,
        is_static: false
        ,
        local_app:                    false

        }
        }
        ,
        mounted: async function(){
        this.local_app = localAppshareApp


        }
        });

        listElm = document.querySelector('#wrapper');

        // Add 20 items.
        var loadMore = function() {
        if (!GLOBALS.isStaticHtmlPageApp) {
        for (let i = 0; i < 1; i++) {
        let nextIndex = nextItem - 1;
        if (nextItem <= defaultCards.length) {
        add_card( {id: nextItem++, card: defaultCards[nextIndex]});
        refresh();
        }
        }
        }
        }

        listElm.addEventListener('scroll', function(event)
        {
        let element = event.target;
        if (element.scrollHeight - element.scrollTop <= (element.clientHeight + 10))
        {
        //console.log('scrolled');
        loadMore();
        //alert("load")
        }
        });
        // Initially load some items.
        for (let i=0; i < 20; i++) {
        loadMore();
        }





        //alert(0)
        if (GLOBALS.isStaticHtmlPageApp) {
        //alert(1)
        let nid = nextItem++;
        add_card({
        id: nid,
        card: {
        id:                 nid,
        name:               "***STATIC_NAME***",
        base_component_id:  "***STATIC_BASE_COMPONENT_ID***",
        code_id:            "***STATIC_BASE_COMPONENT_ID***",
        display_name:       "***STATIC_NAME***",
        type:               "app"
        }});
        mainMoonApp.show_loader = false
        autoScroll = false
        setTimeout(async function() {
        await select_card(nid)
        },20)
        refresh();
        }


        if (GLOBALS.isStaticHtmlPageApp) {
        useHostname = /*static_hostname_start*/"***location.hostname***"/*static_hostname_end*/
        usePort = /*static_port_start*/-1/*static_port_end*/
        } else {
        useHostname = location.hostname
        usePort = location.port
        }
        setupWebSocket(useHostname,  usePort);
        //alert(useHostname + ":" +  usePort)

        let regex = /[?&]([^=#]+)=([^&#]*)/g,
        url = window.location.href,
        match;
        while(match = regex.exec(url)) {
        params[match[1]] = match[2];
        }

        if (params.goto) {
        wait_and_select_app = params.goto.replaceAll("%20"," ").toLowerCase()
        autoScroll = false;
        mainMoonApp.show_loader = true
        } else if (params.embed) {
        wait_and_select_app = params.embed.replaceAll("%20"," ").toLowerCase()
        autoScroll = false;
        mainMoonApp.show_loader = true
        } else if (!GLOBALS.isStaticHtmlPageApp) {
        setTimeout(async function() {
        await select_card(1)
        },200)
        } else if (GLOBALS.isStaticHtmlPageApp) {
        mainMoonApp.is_static = true
        }


        if (editAppShareApp) {
        showProgressBar()
        let nid = nextItem++;
        await loadUiComponentsV4("app_editor_3")
        add_card({
        id: nid,
        card: {
        id:                 nid,
        name:               "fdsfsd",
        base_component_id:  "app_editor_3",
        code_id:            "app_editor_3",
        display_name:       "fdsfds",
        args:                {app_base_component_id: editAppShareApp},
        type:               "app"
        }});
        mainMoonApp.show_loader = false
        autoScroll = false
        setTimeout(async function() {
        await select_card(nid)
        },2000)
        refresh();
        }




        Dropzone.autoDiscover = false;


        Dropzone.options.mydropzone = {
        init: function() {
        this.on("addedfile", function(file) {
        //alert("Added file.");
        });
        }
        };
        var myDropzone = new Dropzone("body#mydropzone", {
        url: "/file_upload"
        ,
        createImageThumbnails: false
        ,
        sending: function(file, xhr, formData){
        showProgressBar()
        file_upload_uuid = uuidv4()
        //alert(fdfs)
        formData.append('client_file_upload_id', file_upload_uuid);
        }
        });
        myDropzone.on("complete", function(file) {
        myDropzone.removeFile(file);
        //let eds = yz.getValueOfCodeString(data.value.code, "sqlite",")//sqlite")
        });




    },100)
};




</script>



<style>
@-webkit-keyframes passing-through{0%{opacity:0;-webkit-transform:translateY(40px);-moz-transform:translateY(40px);-ms-transform:translateY(40px);-o-transform:translateY(40px);transform:translateY(40px)}30%, 70%{opacity:1;-webkit-transform:translateY(0px);-moz-transform:translateY(0px);-ms-transform:translateY(0px);-o-transform:translateY(0px);transform:translateY(0px)}100%{opacity:0;-webkit-transform:translateY(-40px);-moz-transform:translateY(-40px);-ms-transform:translateY(-40px);-o-transform:translateY(-40px);transform:translateY(-40px)}}@-moz-keyframes passing-through{0%{opacity:0;-webkit-transform:translateY(40px);-moz-transform:translateY(40px);-ms-transform:translateY(40px);-o-transform:translateY(40px);transform:translateY(40px)}30%, 70%{opacity:1;-webkit-transform:translateY(0px);-moz-transform:translateY(0px);-ms-transform:translateY(0px);-o-transform:translateY(0px);transform:translateY(0px)}100%{opacity:0;-webkit-transform:translateY(-40px);-moz-transform:translateY(-40px);-ms-transform:translateY(-40px);-o-transform:translateY(-40px);transform:translateY(-40px)}}@keyframes passing-through{0%{opacity:0;-webkit-transform:translateY(40px);-moz-transform:translateY(40px);-ms-transform:translateY(40px);-o-transform:translateY(40px);transform:translateY(40px)}30%, 70%{opacity:1;-webkit-transform:translateY(0px);-moz-transform:translateY(0px);-ms-transform:translateY(0px);-o-transform:translateY(0px);transform:translateY(0px)}100%{opacity:0;-webkit-transform:translateY(-40px);-moz-transform:translateY(-40px);-ms-transform:translateY(-40px);-o-transform:translateY(-40px);transform:translateY(-40px)}}@-webkit-keyframes slide-in{0%{opacity:0;-webkit-transform:translateY(40px);-moz-transform:translateY(40px);-ms-transform:translateY(40px);-o-transform:translateY(40px);transform:translateY(40px)}30%{opacity:1;-webkit-transform:translateY(0px);-moz-transform:translateY(0px);-ms-transform:translateY(0px);-o-transform:translateY(0px);transform:translateY(0px)}}@-moz-keyframes slide-in{0%{opacity:0;-webkit-transform:translateY(40px);-moz-transform:translateY(40px);-ms-transform:translateY(40px);-o-transform:translateY(40px);transform:translateY(40px)}30%{opacity:1;-webkit-transform:translateY(0px);-moz-transform:translateY(0px);-ms-transform:translateY(0px);-o-transform:translateY(0px);transform:translateY(0px)}}@keyframes slide-in{0%{opacity:0;-webkit-transform:translateY(40px);-moz-transform:translateY(40px);-ms-transform:translateY(40px);-o-transform:translateY(40px);transform:translateY(40px)}30%{opacity:1;-webkit-transform:translateY(0px);-moz-transform:translateY(0px);-ms-transform:translateY(0px);-o-transform:translateY(0px);transform:translateY(0px)}}@-webkit-keyframes pulse{0%{-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}10%{-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}20%{-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}}@-moz-keyframes pulse{0%{-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}10%{-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}20%{-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}}@keyframes pulse{0%{-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}10%{-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}20%{-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}}.dropzone,.dropzone *{box-sizing:border-box}.dropzone{min-height:150px;border:2px solid rgba(0,0,0,0.3);background:white;padding:20px 20px}.dropzone.dz-clickable{cursor:pointer}.dropzone.dz-clickable *{cursor:default}.dropzone.dz-clickable .dz-message,.dropzone.dz-clickable .dz-message *{cursor:pointer}.dropzone.dz-started .dz-message{display:none}.dropzone.dz-drag-hover{border-style:solid}.dropzone.dz-drag-hover .dz-message{opacity:0.5}.dropzone .dz-message{text-align:center;margin:2em 0}.dropzone .dz-preview{position:relative;display:inline-block;vertical-align:top;margin:16px;min-height:100px}.dropzone .dz-preview:hover{z-index:1000}.dropzone .dz-preview:hover .dz-details{opacity:1}.dropzone .dz-preview.dz-file-preview .dz-image{border-radius:20px;background:#999;background:linear-gradient(to bottom, #eee, #ddd)}.dropzone .dz-preview.dz-file-preview .dz-details{opacity:1}.dropzone .dz-preview.dz-image-preview{background:white}.dropzone .dz-preview.dz-image-preview .dz-details{-webkit-transition:opacity 0.2s linear;-moz-transition:opacity 0.2s linear;-ms-transition:opacity 0.2s linear;-o-transition:opacity 0.2s linear;transition:opacity 0.2s linear}.dropzone .dz-preview .dz-remove{font-size:14px;text-align:center;display:block;cursor:pointer;border:none}.dropzone .dz-preview .dz-remove:hover{text-decoration:underline}.dropzone .dz-preview:hover .dz-details{opacity:1}.dropzone .dz-preview .dz-details{z-index:20;position:absolute;top:0;left:0;opacity:0;font-size:13px;min-width:100%;max-width:100%;padding:2em 1em;text-align:center;color:rgba(0,0,0,0.9);line-height:150%}.dropzone .dz-preview .dz-details .dz-size{margin-bottom:1em;font-size:16px}.dropzone .dz-preview .dz-details .dz-filename{white-space:nowrap}.dropzone .dz-preview .dz-details .dz-filename:hover span{border:1px solid rgba(200,200,200,0.8);background-color:rgba(255,255,255,0.8)}.dropzone .dz-preview .dz-details .dz-filename:not(:hover){overflow:hidden;text-overflow:ellipsis}.dropzone .dz-preview .dz-details .dz-filename:not(:hover) span{border:1px solid transparent}.dropzone .dz-preview .dz-details .dz-filename span,.dropzone .dz-preview .dz-details .dz-size span{background-color:rgba(255,255,255,0.4);padding:0 0.4em;border-radius:3px}.dropzone .dz-preview:hover .dz-image img{-webkit-transform:scale(1.05, 1.05);-moz-transform:scale(1.05, 1.05);-ms-transform:scale(1.05, 1.05);-o-transform:scale(1.05, 1.05);transform:scale(1.05, 1.05);-webkit-filter:blur(8px);filter:blur(8px)}.dropzone .dz-preview .dz-image{border-radius:20px;overflow:hidden;width:120px;height:120px;position:relative;display:block;z-index:10}.dropzone .dz-preview .dz-image img{display:block}.dropzone .dz-preview.dz-success .dz-success-mark{-webkit-animation:passing-through 3s cubic-bezier(0.77, 0, 0.175, 1);-moz-animation:passing-through 3s cubic-bezier(0.77, 0, 0.175, 1);-ms-animation:passing-through 3s cubic-bezier(0.77, 0, 0.175, 1);-o-animation:passing-through 3s cubic-bezier(0.77, 0, 0.175, 1);animation:passing-through 3s cubic-bezier(0.77, 0, 0.175, 1)}.dropzone .dz-preview.dz-error .dz-error-mark{opacity:1;-webkit-animation:slide-in 3s cubic-bezier(0.77, 0, 0.175, 1);-moz-animation:slide-in 3s cubic-bezier(0.77, 0, 0.175, 1);-ms-animation:slide-in 3s cubic-bezier(0.77, 0, 0.175, 1);-o-animation:slide-in 3s cubic-bezier(0.77, 0, 0.175, 1);animation:slide-in 3s cubic-bezier(0.77, 0, 0.175, 1)}.dropzone .dz-preview .dz-success-mark,.dropzone .dz-preview .dz-error-mark{pointer-events:none;opacity:0;z-index:500;position:absolute;display:block;top:50%;left:50%;margin-left:-27px;margin-top:-27px}.dropzone .dz-preview .dz-success-mark svg,.dropzone .dz-preview .dz-error-mark svg{display:block;width:54px;height:54px}.dropzone .dz-preview.dz-processing .dz-progress{opacity:1;-webkit-transition:all 0.2s linear;-moz-transition:all 0.2s linear;-ms-transition:all 0.2s linear;-o-transition:all 0.2s linear;transition:all 0.2s linear}.dropzone .dz-preview.dz-complete .dz-progress{opacity:0;-webkit-transition:opacity 0.4s ease-in;-moz-transition:opacity 0.4s ease-in;-ms-transition:opacity 0.4s ease-in;-o-transition:opacity 0.4s ease-in;transition:opacity 0.4s ease-in}.dropzone .dz-preview:not(.dz-processing) .dz-progress{-webkit-animation:pulse 6s ease infinite;-moz-animation:pulse 6s ease infinite;-ms-animation:pulse 6s ease infinite;-o-animation:pulse 6s ease infinite;animation:pulse 6s ease infinite}.dropzone .dz-preview .dz-progress{opacity:1;z-index:1000;pointer-events:none;position:absolute;height:16px;left:50%;top:50%;margin-top:-8px;width:80px;margin-left:-40px;background:rgba(255,255,255,0.9);-webkit-transform:scale(1);border-radius:8px;overflow:hidden}.dropzone .dz-preview .dz-progress .dz-upload{background:#333;background:linear-gradient(to bottom, #666, #444);position:absolute;top:0;left:0;bottom:0;width:0;-webkit-transition:width 300ms ease-in-out;-moz-transition:width 300ms ease-in-out;-ms-transition:width 300ms ease-in-out;-o-transition:width 300ms ease-in-out;transition:width 300ms ease-in-out}.dropzone .dz-preview.dz-error .dz-error-message{display:block}.dropzone .dz-preview.dz-error:hover .dz-error-message{opacity:1;pointer-events:auto}.dropzone .dz-preview .dz-error-message{pointer-events:none;z-index:1000;position:absolute;display:block;display:none;opacity:0;-webkit-transition:opacity 0.3s ease;-moz-transition:opacity 0.3s ease;-ms-transition:opacity 0.3s ease;-o-transition:opacity 0.3s ease;transition:opacity 0.3s ease;border-radius:8px;font-size:13px;top:130px;left:-10px;width:140px;background:#be2626;background:linear-gradient(to bottom, #be2626, #a92222);padding:0.5em 1.2em;color:white}.dropzone .dz-preview .dz-error-message:after{content:'';position:absolute;top:-6px;left:64px;width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:6px solid #be2626}


#wrapper {
/* We need to limit the height and show a scrollbar */
width: 100%;
height: 100%;
overflow-y: scroll;

/* Optional, only to check that it works with margin/padding */
margin: 0px;
padding: 0px;
border: 0px solid black;
scroll-behavior2: smooth;
}
#infinite-list {
}
/* Optional eye candy below: */
li {
width: 95%;
background-color: white;
padding: 10px;
}

.loader {
margin: auto;
margin-top:25vh;
border: 26px solid #f3f3f3; /* Light grey */
border-top: 26px solid #3498db; /* Blue */
border-radius: 100%;
width: 14vw;
position:absolute;
left:43vw;
height: 14vw;
animation: spin2 2s linear infinite;
z-index: 21474836;
}

@keyframes spin2 {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}



body {
margin: 30px;



}



.link {
cursor:pointer;
color:blue;
text-decoration:underline;
}

.link:hover {
color:black;
}
.dotted_vb6 {
padding: 2.25em 1.6875em;
background-image: -webkit-repeating-radial-gradient(center center, gray, gray 1px, transparent 2px, transparent 100%);
background-image: -moz-repeating-radial-gradient(center center, gray, gray 1px, transparent 2px, transparent 100%);
background-image: -ms-repeating-radial-gradient(center center, gray, gray 1px, transparent 2px, transparent 100%);
background-image: repeating-radial-gradient(center center, gray, gray 1px, transparent 2px, transparent 100%);
-webkit-background-size: 15px 15px;
-moz-background-size: 15px 15px;
background-size: 15px 15px;
background-color: lightgray;
}


.dotted {
background-position: 0px 0px, 10px 10px;
background-size: 20px 20px;
background-image: linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee 100%),linear-gradient(45deg, #eee 25%, white 25%, white 75%, #eee 75%, #eee 100%);
cursor: crosshair;
}
</style>

<style>
.my-custom-selectr {
padding: 3px;
border-radius: 3px;
margin: 0px;
border-right: 2px solid gray;
border-bottom: 2px solid gray;
}
/*!
* Selectr 2.4.8
* http://mobius.ovh/docs/selectr
*
* Released under the MIT license
*/
.selectr-container li,.selectr-option,.selectr-tag{list-style:none}.selectr-container{position:relative}.selectr-hidden{position:absolute;overflow:hidden;clip:rect(0,0,0,0);width:1px;height:1px;margin:-1px;padding:0;border:0}.selectr-visible{position:absolute;left:0;top:0;width:100%;height:100%;opacity:0;z-index:11}.selectr-desktop.multiple .selectr-visible{display:none}.selectr-desktop.multiple.native-open .selectr-visible{top:100%;min-height:200px!important;height:auto;opacity:1;display:block}.selectr-container.multiple.selectr-mobile .selectr-selected{z-index:0}.selectr-selected{position:relative;z-index:1;box-sizing:border-box;width:100%;padding:7px 28px 7px 14px;cursor:pointer;border:1px solid #999;border-radius:3px;background-color:#fff}.selectr-selected::before{position:absolute;top:50%;right:10px;width:0;height:0;content:'';-o-transform:rotate(0) translate3d(0,-50%,0);-ms-transform:rotate(0) translate3d(0,-50%,0);-moz-transform:rotate(0) translate3d(0,-50%,0);-webkit-transform:rotate(0) translate3d(0,-50%,0);transform:rotate(0) translate3d(0,-50%,0);border-width:4px 4px 0;border-style:solid;border-color:#6c7a86 transparent transparent}.selectr-container.native-open .selectr-selected::before,.selectr-container.open .selectr-selected::before{border-width:0 4px 4px;border-style:solid;border-color:transparent transparent #6c7a86}.selectr-label{display:none;overflow:hidden;width:100%;white-space:nowrap;text-overflow:ellipsis}.selectr-placeholder{color:#6c7a86}.selectr-tags{margin:0;padding:0;white-space:normal}.has-selected .selectr-tags{margin:0 0 -2px}.selectr-tag{position:relative;float:left;padding:2px 25px 2px 8px;margin:0 2px 2px 0;cursor:default;color:#fff;border:none;border-radius:10px;background:#acb7bf}.selectr-container.multiple.has-selected .selectr-selected{padding:5px 28px 5px 5px}.selectr-options-container{position:absolute;z-index:10000;top:calc(100% - 1px);left:0;display:none;box-sizing:border-box;width:100%;border-width:0 1px 1px;border-style:solid;border-color:transparent #999 #999;border-radius:0 0 3px 3px;background-color:#fff}.selectr-container.open .selectr-options-container{display:block}.selectr-input-container{position:relative;display:none}.selectr-clear,.selectr-input-clear,.selectr-tag-remove{position:absolute;top:50%;right:22px;width:20px;height:20px;padding:0;cursor:pointer;-o-transform:translate3d(0,-50%,0);-ms-transform:translate3d(0,-50%,0);-moz-transform:translate3d(0,-50%,0);-webkit-transform:translate3d(0,-50%,0);transform:translate3d(0,-50%,0);border:none;background-color:transparent;z-index:11}.selectr-clear,.selectr-input-clear{display:none}.selectr-container.has-selected .selectr-clear,.selectr-input-container.active,.selectr-input-container.active .selectr-clear,.selectr-input-container.active .selectr-input-clear{display:block}.selectr-selected .selectr-tag-remove{right:2px}.selectr-clear::after,.selectr-clear::before,.selectr-input-clear::after,.selectr-input-clear::before,.selectr-tag-remove::after,.selectr-tag-remove::before{position:absolute;top:5px;left:9px;width:2px;height:10px;content:' ';background-color:#6c7a86}.selectr-tag-remove::after,.selectr-tag-remove::before{top:4px;width:3px;height:12px;background-color:#fff}.selectr-clear:before,.selectr-input-clear::before,.selectr-tag-remove::before{-o-transform:rotate(45deg);-ms-transform:rotate(45deg);-moz-transform:rotate(45deg);-webkit-transform:rotate(45deg);transform:rotate(45deg)}.selectr-clear:after,.selectr-input-clear::after,.selectr-tag-remove::after{-o-transform:rotate(-45deg);-ms-transform:rotate(-45deg);-moz-transform:rotate(-45deg);-webkit-transform:rotate(-45deg);transform:rotate(-45deg)}.selectr-input{top:5px;left:5px;box-sizing:border-box;width:calc(100% - 30px);margin:10px 15px;padding:7px 30px 7px 9px;border:1px solid #999;border-radius:3px}.selectr-notice{display:none;box-sizing:border-box;width:100%;padding:8px 16px;border-top:1px solid #999;border-radius:0 0 3px 3px;background-color:#fff}.input-tag,.taggable .selectr-label{width:auto}.selectr-container.notice .selectr-notice{display:block}.selectr-container.notice .selectr-selected{border-radius:3px 3px 0 0}.selectr-options{position:relative;top:calc(100% + 2px);display:none;overflow-x:auto;overflow-y:scroll;max-height:200px;margin:0;padding:0}.selectr-container.notice .selectr-options-container,.selectr-container.open .selectr-input-container,.selectr-container.open .selectr-options{display:block}.selectr-option{position:relative;display:block;padding:5px 20px;cursor:pointer;font-weight:400}.has-selected .selectr-placeholder,.selectr-empty,.selectr-option.excluded{display:none}.selectr-options.optgroups>.selectr-option{padding-left:25px}.selectr-optgroup{font-weight:700;padding:0}.selectr-optgroup--label{font-weight:700;margin-top:10px;padding:5px 15px}.selectr-match{text-decoration:underline}.selectr-option.selected{background-color:#ddd}.selectr-option.active{color:#fff;background-color:#5897fb}.selectr-option.disabled{opacity:.4}.selectr-container.open .selectr-selected{border-color:#999 #999 transparent;border-radius:3px 3px 0 0}.selectr-container.open .selectr-selected::after{-o-transform:rotate(180deg) translate3d(0,50%,0);-ms-transform:rotate(180deg) translate3d(0,50%,0);-moz-transform:rotate(180deg) translate3d(0,50%,0);-webkit-transform:rotate(180deg) translate3d(0,50%,0);transform:rotate(180deg) translate3d(0,50%,0)}.selectr-disabled{opacity:.6}.has-selected .selectr-label{display:block}.taggable .selectr-selected{padding:4px 28px 4px 4px}.taggable .selectr-selected::after{display:table;content:" ";clear:both}.taggable .selectr-tags{float:left;display:block}.taggable .selectr-placeholder{display:none}.input-tag{float:left;min-width:90px}.selectr-tag-input{border:none;padding:3px 10px;width:100%;font-family:inherit;font-weight:inherit;font-size:inherit}.selectr-input-container.loading::after{position:absolute;top:50%;right:20px;width:20px;height:20px;content:'';-o-transform:translate3d(0,-50%,0);-ms-transform:translate3d(0,-50%,0);-moz-transform:translate3d(0,-50%,0);-webkit-transform:translate3d(0,-50%,0);transform:translate3d(0,-50%,0);-o-transform-origin:50% 0 0;-ms-transform-origin:50% 0 0;-moz-transform-origin:50% 0 0;-webkit-transform-origin:50% 0 0;transform-origin:50% 0 0;-moz-animation:.5s linear 0s normal forwards infinite running spin;-webkit-animation:.5s linear 0s normal forwards infinite running spin;animation:.5s linear 0s normal forwards infinite running spin;border-width:3px;border-style:solid;border-color:#aaa #ddd #ddd;border-radius:50%}@-webkit-keyframes spin{0%{-webkit-transform:rotate(0) translate3d(0,-50%,0);transform:rotate(0) translate3d(0,-50%,0)}100%{-webkit-transform:rotate(360deg) translate3d(0,-50%,0);transform:rotate(360deg) translate3d(0,-50%,0)}}@keyframes spin{0%{-webkit-transform:rotate(0) translate3d(0,-50%,0);transform:rotate(0) translate3d(0,-50%,0)}100%{-webkit-transform:rotate(360deg) translate3d(0,-50%,0);transform:rotate(360deg) translate3d(0,-50%,0)}}.selectr-container.open.inverted .selectr-selected{border-color:transparent #999 #999;border-radius:0 0 3px 3px}.selectr-container.inverted .selectr-options-container{border-width:1px 1px 0;border-color:#999 #999 transparent;border-radius:3px 3px 0 0;background-color:#fff;top:auto;bottom:calc(100% - 1px)}.selectr-container ::-webkit-input-placeholder{color:#6c7a86;opacity:1}.selectr-container ::-moz-placeholder{color:#6c7a86;opacity:1}.selectr-container :-ms-input-placeholder{color:#6c7a86;opacity:1}.selectr-container ::placeholder{color:#6c7a86;opacity:1}
</style>
<script>

</script>

</head>




<body onload='initFn()' id='mydropzone' style='border: 0px; margin: 0px;padding: 0px;height: 100%;'>



<div    id='popup'
style='display: none;position: absolute; margin:0px; padding: 0%;  border: 0px;  width: 100%;  height:100%;  left: 0%; top: 0%; z-index: -10000;'
onclick='document.getElementById("popup").style.zIndex = "-1";document.getElementById("popup").style.display = "none";document.getElementById("popup_content").innerHTML =""'>

<div    id='popup_content'
style='position: absolute; margin:0px; padding: 5%;  border: 0px;  width: 50%;  height:80%;  left: 25%; top: 0%; ; background-color: white;color: black;overflow-y: scroll; z-index: 400000;'
onclick="dontBubble(event, this);">
</div>
</div>




<div    id='wrapper'
onscroll='onscrolled()'
onmousedown='onemousedown()'
onmouseup='onemouseup()'
onwheel='onemousedown()'     >



<div    id='infinite-list'
style='overflow-y: none;' >



<div    v-if="show_loader"
v-bind:style='show_loader?"":"display:none;"'
class="loader">
</div>


<div v-if='!is_gui_app' style="padding:10px;"><pre id="console_id" style="color: white;">{{console_output}}</pre></div>


<template   v-if='is_gui_app'
v-for="item  in  cards" >
<div v-if="item.id == selected_card"
style="position: fixed; left:0px; top:0px; height:100%; width: 100vw ;z-index: 200000;background-color: white;overflow-y:hidden;overflow-x: hidden;">
<card_component :item='item' :visible='true' :element_id='"current_card"'
:full_screen='true'
:is_static='is_static' :card_selected='true'>
</card_component>
</div>

</template>







<template   v-for="item  in  cards"
v-if='is_gui_app'>

<div v-bind:style='"width: 100%; display:" + (is_static?"none;":"") + ";"'>
<card_component :item='item' :visible='true' :element_id='"card_" + item.id'
:full_screen='false'
:is_static='is_static' :card_selected='(item.id == selected_card)'>
</card_component>
</div>
</template>

<div style="height: 200px;">
</div>





</div>
</div>


<script>

var globalEventBus = new Vue();
//lll
let newAppArgs = []
async function prepareApp(  id,  bbase_component_id,  args  ) {
    base_component_id = bbase_component_id
    GLOBALS.base_component_id_of_main_runtime_component = bbase_component_id
    let rootElement = "app_" + id
    if ((mainMoonApp.cards[id - 1].card.base_component_id != base_component_id) ||
        (!newAppArgs[id])) {

        newAppArgs[id] = args
    }

    await loadUiComponentsV4(base_component_id)
    if (mainMoonApp.cards[id - 1].card.base_component_id == base_component_id) {
        loadAppIntoElement(base_component_id, rootElement)
    }

}


function loadAppIntoElement(tagName, rootElement) {
if (!mainMoonApp.is_gui_app) {
return
}

if (!document.getElementById(rootElement)) {
let newRootId = rootElement.substring(4)
let newCardId = "app_container_" + newRootId
let newAppId = "app_" + newRootId
//alert("Creating: " + newAppId + " under " + newCardId)
document.getElementById(newCardId).innerHTML = ""

}

new Vue({
template: `<${tagName} app_base_component_id='${editAppShareApp}' v-bind:card_index='1'></${tagName}>`,
el: "#" + rootElement
})
}



function loadContent(  data_id,  data_name  ) {
//
// _______
// Browser  --Send me a preview of a document--  Server
// _______
//
//console.log("**1) browser_asks_server_for_document_preview")
sendToServerViaWebSocket({
message_type:   "browser_asks_server_for_document_preview",
data_id:         data_id,
data_name:       data_name
});
}



function openContent(  data_id  ) {
//
// _______
// Browser  --Send me a preview of a document--  Server
// _______
//
//console.log("**1) browser_asks_server_to_open_document_natively")
sendToServerViaWebSocket({
message_type:   "browser_asks_server_to_open_document_natively",
data_id:         data_id
});
}




function add_card(payload) {

let ccy = document.getElementById('wrapper').scrollTop
mainMoonApp.cards.push(payload);
setTimeout(function() {
document.getElementById('wrapper').scrollTop = ccy
},100)

}

function update_card(payload) {
//console.log("update_card: " + JSON.stringify(payload,null,2))
for (let i = 0; i < mainMoonApp.cards.length; i++) {
if (mainMoonApp.cards[i].id == payload.id) {
mainMoonApp.cards[i].card.hide_header           = payload.card.hide_header
mainMoonApp.cards[i].card.name                  = payload.card.name
mainMoonApp.cards[i].card.base_component_id     = payload.card.base_component_id
mainMoonApp.cards[i].card.code_id               = payload.card.code_id
mainMoonApp.cards[i].card.display_name          = payload.card.display_name
mainMoonApp.cards[i].card.type                  = payload.card.type
}
}
}


function refresh() {
mainMoonApp.count += 1;
}



function getPosition(el) {
let xPos = 0;
let yPos = 0;

while (el) {
if (el.tagName == "BODY") {
// deal with browser quirks with body/window/document and page scroll
let xScroll = el.scrollLeft || document.documentElement.scrollLeft;
let yScroll = el.scrollTop || document.documentElement.scrollTop;

xPos += (el.offsetLeft - xScroll + el.clientLeft);
yPos += (el.offsetTop - yScroll + el.clientTop);
} else {
// for all other non-BODY elements
xPos += (el.offsetLeft - el.scrollLeft + el.clientLeft);
yPos += (el.offsetTop - el.scrollTop + el.clientTop);
}

el = el.offsetParent;
}
return {
x: xPos,
y: yPos
};
}
async function select_card(id) {
if (mainMoonApp.selected_card == id) {
return;
}
if (mainMoonApp.selected_card != -1) {
if (id != -1) {
document.querySelector('#card_' + mainMoonApp.selected_card).classList.remove("expand");
}
document.querySelector('#card_' + mainMoonApp.selected_card).classList.add('contract');

//alert(document.querySelector('#card_' + id))
}

if (id != -1) {
let elmnt = document.querySelector('#card_' + id);
if (elmnt) {
//elmnt.scrollIntoView({  alignToTop: 'true',
//                        bahaviour: 'smooth'});
//document.getElementById("wrapper").scrollTop = getPosition(document.querySelector('#card_' + id)).y - 200
if (GLOBALS.isStaticHtmlPageApp) {
mainMoonApp.selected_card = id;
setTimeout(async function() {
let thisApp = mainMoonApp.cards[id - 1]
//alert("id: " + JSON.stringify(thisApp,null,2))
//alert("thisApp: " + JSON.stringify(thisApp,null,2))
//alert("thisApp.id: " + JSON.stringify(thisApp.id,null,2))
//alert("thisApp.card.base_component_id: " + JSON.stringify(thisApp.card.base_component_id,null,2))
//console.log(JSON.stringify(mainMoonApp.cards[id - 1],null,2))
if (mainMoonApp.cards[id - 1].card.fn) {
setTimeout( mainMoonApp.cards[id - 1].card.fn, 3000)
//alert(1)
}
if (thisApp.card.base_component_id) {
await prepareApp(  thisApp.id,   thisApp.card.base_component_id,   thisApp.card.args  )
}
},200)

} else {
document.querySelector('#card_' + id).classList.remove('contract');
document.querySelector('#card_' + id).classList.add('expand');
setTimeout(function() {
mainMoonApp.selected_card = id;
setTimeout(async function() {
let thisApp = mainMoonApp.cards[id - 1]
//alert("id: " + JSON.stringify(thisApp,null,2))
//alert("thisApp: " + JSON.stringify(thisApp,null,2))
//alert("thisApp.id: " + JSON.stringify(thisApp.id,null,2))
//alert("thisApp.card.base_component_id: " + JSON.stringify(thisApp.card.base_component_id,null,2))
//console.log(JSON.stringify(mainMoonApp.cards[id - 1],null,2))
if (mainMoonApp.cards[id - 1].card.fn) {
setTimeout( mainMoonApp.cards[id - 1].card.fn, 3000)
//alert(1)
}
if (thisApp.card.base_component_id) {
await prepareApp(  thisApp.id,   thisApp.card.base_component_id,   thisApp.card.args  )
}
},200)
},1000)
}


}
}

}

var mainMoonApp = null



//ccc
var defaultCards = [
{
html:
`<div>
</div>
`
}

];



populateCache()
function populateCache() {




//***ADD_STATIC_CODE
}






var socket=null;
function sendToServerViaWebSocket(msg) {
if (GLOBALS.online) {
msg.cookie = getYazzCookie()
socket.send(JSON.stringify(msg));
}
//console.log("Sent over socket: " + JSON.stringify(msg,null,2));
}



var staticAppSocket
async function setupPublicWebSocket()
{
var hostEditorAddress = "https://yazz.com:443"
//hostEditorAddress = "http://192.168.0.63:3000"

//console.log('opening web socketio');
//staticAppSocket = io('http://yazz.com:80');

staticAppSocket = io(hostEditorAddress);






//console.log('opening web socketio');
staticAppSocket.on('socket_connected',function(data){
//console.log("Connected: " + JSON.stringify(data,null,2));
//alert("Connected 2")

staticAppSocket.send(JSON.stringify(
{
message_type:           "edit_static_app",
host_editor_address:     hostEditorAddress,
sql_data:                sqlitedata,
code_fn:                 code_fn,
base_component_id:       base_component_id,
msg:                    "Hi from client"
}));

});

staticAppSocket.on('edit_static_app_url', function(msg) {
//alert(JSON.stringify(msg,null,2))
window.location.href = msg.url;
//var receivedMessage = eval("(" + msg + ")");
//console.log(" 1- Server recieved message: " + JSON.stringify(receivedMessage));

// if we get the message "server_get_all_queries" from the web browser
//alert("Browser received from server socket: " + JSON.stringify(msg,null,2));
})

}

function setupWebSocket(host, port)
{

//console.log('opening web socketio');
socket = io();
//console.log('opening web socketio');
socket.on('socket_connected',function(data){
GLOBALS.online = true
//console.log("Connected: " + JSON.stringify(data,null,2));

setTimeout(function(){
//
// _______
// Browser  --Send me your data--  Server
// _______
//


setInterval(function() {
sendToServerViaWebSocket({
message_type: "browser_asks_server_for_data"
});
}, 5000)


},3000);
});

socket.on('set_file_upload_uuid',async function(data) {
file_upload_uuid = data.file_upload_uuid
})

socket.on('set_saveCodeToFile',async function(data) {
saveCodeToFile = data.saveCodeToFile
})





socket.on('uploaded_app_as_file_from_server',async function(data) {

//console.log("Browser received from server socket: " + JSON.stringify(data,null,2));
if (data.client_file_upload_id == file_upload_uuid) {
//alert("File uploaded: " + JSON.stringify(data.base_component_id,null,2))
globalEventBus.$emit('new-appshare-app-uploaded', data.base_component_id);
}
});















// ----------------------------------------------------------------------------------------------
//
//                  Share the container environment variables with the front end
//
// ----------------------------------------------------------------------------------------------
socket.on('env_vars',async function(data) {
    //console.log("Browser received from server socket: " + JSON.stringify(data,null,2));

    var allEnvVarNames = Object.keys(data.value)
    for (var i=0; i< allEnvVarNames.length;i++) {
        try
        {
            let envName = allEnvVarNames[i].replace(/[^a-zA-Z0-9]/g,'_')
            //console.log(envName)
            var valueEnvVar = data.value[envName]
            var cmddd = '($' + envName + " =  String.raw`" +  String.raw`${valueEnvVar}` +"`)"

            if (mainMoonApp.is_gui_app) {
                console.log(cmddd)
            }

            eval(cmddd)

        } catch (errr) {
            console.log(errr)
        }
    }
    pageInitialised = true



    if (($USEHTTPS == "true") || (location.hostname == "localhost")) {
        //debugger
        await useIpfsServer()
        try {
            ipfs = await Ipfs.create({offline: true, start: false})
            console.log('IPFS server loaded:')
        } catch (ipfsError) {
            console.log('IPFS server erroe: ' + ipfsError)
        }
    }


    if (executeOnPageLoad) {
        await executeOnPageLoad()
        executeOnPageLoad = null
    }
});









// ----------------------------------------------------------------------------------------------
//
//                  Share the container environent variables with the front end
//
// ----------------------------------------------------------------------------------------------
socket.on('network_ip_address_intranet',function(data) {
//console.log("Browser received from server socket: " + JSON.stringify(data,null,2));

networkIntranetIpAddress = data.value
});





// ----------------------------------------------------------------------------------------------
//
//
//
// ----------------------------------------------------------------------------------------------
socket.on('send_is_win',function(data) {
//console.log("Browser received from server socket: " + JSON.stringify(data,null,2));

isWin = data.value
});























    socket.on('ws_to_browser_call_component_results',async function(data) {
                var callbackFn = queuedResponses[data.seq_num]
                callbackFn(data.value)
                queuedResponses[data.seq_num] = null
    });

}

function getNetworkHostName() {
let networkHostName = location.hostname
if (networkHostName == "127.0.0.1") {
networkHostName = networkIntranetIpAddress
}
if (networkHostName == "0.0.0.0") {
networkHostName = networkIntranetIpAddress
}
return networkHostName
}


async function scriptTag(src, callback) {

var s = document.createElement('script');
s.type = 'text/' + (src.type || 'javascript');
s.src = src.src || src;
s.async = false;

s.onreadystatechange = s.onload = async function () {

var state = s.readyState;

if (!callback.done && (!state || /loaded|complete/.test(state))) {
callback.done = true;
await callback();
}
};

// use body if available. more safe in IE
(document.body || head).appendChild(s);
}



function logVarBefore(codeBlockName, line, varName, varValue) {
if (executionCode[codeBlockName]) {

if (executionTimeline[currentTimelineLogPoint]) {
if (!executionTimeline[currentTimelineLogPoint].vars[varName]) {
executionTimeline[currentTimelineLogPoint].vars[varName] = {}
}
executionTimeline[currentTimelineLogPoint].vars[varName].before = varValue
}

}


}

function logVarAfter(codeBlockName, line, varName, varValue) {
if (executionCode[codeBlockName]) {

if (executionTimeline[currentTimelineLogPoint]) {
if (!executionTimeline[currentTimelineLogPoint].vars[varName]) {
executionTimeline[currentTimelineLogPoint].vars[varName] = {}
}
executionTimeline[currentTimelineLogPoint].vars[varName].after = varValue
}
}
}


function fillInMissingWatchTimelineValues(vName, executionStepNo) {
if (!globalWatchList[vName]) {
globalWatchList[vName] = {
viewer: ""
}
}
if (!globalWatchList[vName][executionStepNo]) {
globalWatchList[vName][executionStepNo] = {}
}

if (executionStepNo == executionTimeline.length) {
return

} else if (!globalWatchList[vName][executionStepNo].isSet) {
if (executionStepNo == 0) {
globalWatchList[vName][executionStepNo].value = null
} else {
globalWatchList[vName][executionStepNo].value = globalWatchList[vName][executionStepNo - 1].value
}
}
fillInMissingWatchTimelineValues(vName, executionStepNo + 1)
}

function addWatchPoint(vName,value) {
globalWatchList[vName][currentTimelineLogPoint] = {}
globalWatchList[vName][currentTimelineLogPoint].value = eval("(" + JSON.stringify(value) + ")")
globalWatchList[vName][currentTimelineLogPoint].isSet = true
if (value){
globalWatchList[vName].type = typeof(value)
globalWatchList[vName].viewer = "text"

if (typeof(value) == "object") {
if (value[0]) {
if (typeof(value[0]) == "number") {
globalWatchList[vName].type = "ListOfNumbers"
globalWatchList[vName].viewer = "graph"
}
}
}
}
}




function logExecutionPoint(codeBlockName, line, node) {
//console.log("logExecutionPoint(" + codeBlockName + "," + line)

if (executionCode[codeBlockName]) {
currentTimelineLogPoint = maxTimelineLogPoint ++

var recor = { code_block_name:    codeBlockName,
line:               line,
time:               currentTimelineLogPoint,
node:               node,
vars:               {}
}
executionTimeline.push(recor)

executionTimelineMapTimeToLine[recor.time] = recor
}
}





function getDebugCode(blockName,  trcode2 , args) {
    if (!uiDebuggerOn) {
        return trcode2
    }

    let _b = esprima.parse(trcode2,{tolerant: true , loc:true, range: true, attachComment: false})
    let line = -1
    let varsToAdd = {}
    let skipFirstAndLastLine = false
    if (isValidObject(args)) {
    if (args.skipFirstAndLastLine){
        skipFirstAndLastLine=true
    }
    }

    estraverse.traverse(_b, {
    enter: function (node, parent) {
    //
    // add the line numbers
    //
    if (
    (node.type == "ExpressionStatement")
    ||
    (node.type == "VariableDeclaration")
    ||
    (node.type == "AssignmentExpression")
    ) {
    if (parent) {
    if ((node.loc.start.line - (skipFirstAndLastLine?1:0)) > line) {
    line = node.loc.start.line - (skipFirstAndLastLine?1:0)

    if (line > 0) {
    let newLine = "logExecutionPoint('" + blockName + "', " + line +",'" + JSON.stringify(node.type) + "');"
    let newNode = esprima.parse(newLine)

    for (let rr = 0; rr < parent.body.length; rr++){
    if (parent.body[rr] == node) {
    parent.body.splice(rr, 0, newNode);
    break
    }
    }





    //
    // vars
    //
    if (node.type == "VariableDeclaration") {
    if (node.declarations[0].init) {
    //alert(`let ${node.declarations[0].id.name} = ${node.declarations[0].init.value}`)
    let varNameToUse = node.declarations[0].id.name

    if (node.kind == "var") {
    let newLine = "logVarBefore('" + blockName + "', " + node.loc.start.line +",'" +
    varNameToUse + "', " + varNameToUse  + ");"
    let newNode = esprima.parse(newLine)
    }
    varsToAdd[varNameToUse] = {}

    let newLineAfter = "logVarAfter('" + blockName + "', " + node.loc.start.line +",'" +
    varNameToUse + "'," + varNameToUse  + ");"
    let newNodeAfter = esprima.parse(newLineAfter)

    let logWatchVarsCode = `for (let _uu=0; _uu<Object.keys(globalWatchList).length; _uu++){try { let _vName = Object.keys(globalWatchList)[_uu];if (isValidObject(_vName)){ addWatchPoint(_vName, eval(_vName) ) }} catch(_err){}}`
    let logWatchVarsNode = esprima.parse(logWatchVarsCode)

    for (let rr=0; rr<parent.body.length; rr++){
    if (parent.body[rr] == node) {
    parent.body.splice(rr + 1, 0, logWatchVarsNode);
    parent.body.splice(rr + 1, 0, newNodeAfter);
    parent.body.splice(rr, 0, newNode);
    break;
    }
    }
    }
    }



    if ((node.type == "ExpressionStatement") && node.expression) {
    if (node.expression.type == "CallExpression") {
    let logWatchVarsCode = `for (let _uu=0; _uu<Object.keys(globalWatchList).length; _uu++){try { let _vName = Object.keys(globalWatchList)[_uu];if (isValidObject(_vName)){ addWatchPoint(_vName, eval(_vName) ) }} catch(_err){}}`
    let logWatchVarsNode = esprima.parse(logWatchVarsCode)

    for (let rr=0; rr<parent.body.length; rr++){
    if (parent.body[rr] == node) {
    if (logWatchVarsNode){
    parent.body.splice(rr + 1, 0, logWatchVarsNode);
    }
    break;   }}}}




    if ((node.type == "ExpressionStatement") && node.expression) {
    if ((node.expression.type == "AssignmentExpression") &&
    (node.expression.operator == "=")) {
    let varName = node.expression.left.name
    if (!isValidObject(varName)) {
    if (node.expression.left.object.type == "ThisExpression") {
    varName = "this." + node.expression.left.property.name
    } else if (node.expression.left.type == "MemberExpression") {
    varName = node.expression.left.object.name
    if (node.expression.left.property.type == "Identifier") {
    varName += "." + node.expression.left.property.name
    }
    }
    }
    varsToAdd[varName] = {}

    let newLine = "logVarBefore('" + blockName + "', " + node.loc.start.line +",'" +
    varName + "', " + varName  + ");"
    let newNode = esprima.parse(newLine)

    let newLineAfter = "logVarAfter('" + blockName + "', " + node.loc.start.line +",'" +
    varName + "', " + varName  + ");"
    let newNodeAfter = esprima.parse(newLineAfter)

    let logWatchVarsCode = `for (let _uu=0; _uu<Object.keys(globalWatchList).length; _uu++){try { let _vName = Object.keys(globalWatchList)[_uu];if (isValidObject(_vName)){ addWatchPoint(_vName, eval(_vName) ) }} catch(_err){}}`
    let logWatchVarsNode = esprima.parse(logWatchVarsCode)

    for (let rr=0; rr<parent.body.length; rr++){
    if (parent.body[rr] == node) {
    if (logWatchVarsNode){
    parent.body.splice(rr + 1, 0, logWatchVarsNode);
    }
    if (newNodeAfter){
    parent.body.splice(rr + 1, 0, newNodeAfter);
    }
    parent.body.splice(rr, 0, newNode);
    break;
    }
    }

    }
    }



    }
    }
    }
    }






    },
    leave: function (node, parent) {
    },

    keys: {
    'AwaitExpression': ['argument']
    }
    });

    for ( let fds = 0 ; fds < Object.keys(varsToAdd).length ; fds ++ ) {
    let nnn = Object.keys(varsToAdd)[fds]
    globalWatchList[nnn]={
    viewer: ""
    }
    }


    let debugCode = escodegen.generate(_b, {comment: false})





    executionCode[blockName] = {}
    executionCode[blockName].debug_code = debugCode
    if (skipFirstAndLastLine){
    let indexOfFirst = trcode2.indexOf("\n")
    if (indexOfFirst != -1) {
    trcode2 = trcode2.substring(indexOfFirst + 1)
    }

    let indexOfLast = trcode2.lastIndexOf("\n")
    if (indexOfLast != -1) {
    trcode2 = trcode2.substring(0,indexOfLast)
    }
    }

    trcode2 = trcode2.toString().replaceAll("await rxsql[(][^,]*,[^,]*,","sql(")
    trcode2 = trcode2.toString().replaceAll("await rxsql1[(][^,]*,[^,]*,","sql1(" )
    trcode2 = trcode2.toString().replaceAll("await rxsqlFirstCol[(][^,]*,[^,]*,","sqlFirstCol(" )
    trcode2 = trcode2.toString().replaceAll("await rxsqlFirstCol1[(][^,]*,[^,]*,","sqlFirstCol1(" )

    executionCode[blockName].code = trcode2
    executionCode[blockName].start = startTimelineTop
    startTimelineTop += trcode2.length

    return debugCode

}








/*
creates the following:

GLOBALS.linkedProperties = {
horiz_scroll_control: {
outgoing: {
me: {
value: {
label_control: {text: true}
}
},
them: {
label_control: {
text: {value: true}
}
}
}

}
,
input_control: {
outgoing: {
me: {
value: {
label_control: {text: true}
}
},
them: {
label_control: {
text: {value: true}
}
}
}
}
,
label_control: {

outgoing: {
me: {
leftX: {
horiz_scroll_control: {value: true}
},
topY: {
horiz_scroll_control: {value: true}
},
text: {
input_control: {value: true}
}
},
them: {
horiz_scroll_control: {
value: {text: true, leftX: true, topY: true}
},
input_control: {
value: {text: true}
},
timer_control: {
counter: {
text: true, leftX: true, topY: true
}
}

}
}
,
incoming: {
me: {
leftX: {
horiz_scroll_control: {value: true}
},
topY: {
horiz_scroll_control: {value: true}
},
text: {
input_control: {value: true},
timer_control: {counter: true}
}

},
them: {
horiz_scroll_control: {
value: {text: true, leftX: true, topY: true}
},
input_control: {
value: {text: true}
},
timer_control: {
counter: {
text: true, leftX: true, topY: true
}
}


}
}

}
}

*/


async function findComponentsImplementing(listOfProperties){
//aaa
let results = await callComponent(
{
base_component_id: "findComponentsImplementing"
}
,{
properties: listOfProperties
})
return results
}

function indexComponent(typeName) {
//return
    GLOBALS.linkedProperties[typeName] = {
        incoming: {
            me: {},
            them: {}

        },
        outgoing: {
            me: {},
            them: {}
        }
    }

    if (typeName == "horiz_scroll_control") {
//debugger

    }


    if (GLOBALS.isComponentTypeCached(typeName)) {
        for (let oneProperty of GLOBALS.getControlPropertyDefns({baseComponentId: typeName})) {
            let propertyName = oneProperty.name
            if (propertyName) {

//
// match my ACCEPT TYPES with TYPES coming from other components
//
                if (oneProperty.accept_types) {
                    let acceptTypes = Object.keys(oneProperty.accept_types)
                    for (let acceptType of acceptTypes) {

                        for (let otherComponentName of GLOBALS.getAllLoadedTypeNames()) {
                            if (otherComponentName == "database_control") {

                            }
                            if (otherComponentName != typeName) {
                                if (GLOBALS.isComponentTypeCached(otherComponentName)) {
                                    if (GLOBALS.getControlPropertyDefns({baseComponentId: otherComponentName})) {
                                        let otherProperties = GLOBALS.getControlPropertyDefns({baseComponentId: otherComponentName})
                                        for (let otherProperty of otherProperties) {
                                            if (otherProperty.types) {
                                                for (let otherPropertyType of Object.keys(otherProperty.types)) {
                                                    if (otherPropertyType == acceptType) {

//console.log("        Found Match for " + acceptType)
                                                        if (!GLOBALS.linkedProperties[typeName].incoming.them[otherComponentName]) {
                                                            GLOBALS.linkedProperties[typeName].incoming.them[otherComponentName] = {}
                                                        }
                                                        if (!GLOBALS.linkedProperties[typeName].incoming.them[otherComponentName][otherProperty.id]) {
                                                            GLOBALS.linkedProperties[typeName].incoming.them[otherComponentName][otherProperty.id] = {}
                                                        }
                                                        GLOBALS.linkedProperties[typeName].incoming.them[otherComponentName][otherProperty.id][oneProperty.id] = true

                                                        if (!GLOBALS.linkedProperties[typeName].incoming.me[oneProperty.id]) {
                                                            GLOBALS.linkedProperties[typeName].incoming.me[oneProperty.id] = {}
                                                        }
                                                        if (!GLOBALS.linkedProperties[typeName].incoming.me[oneProperty.id][otherComponentName]) {
                                                            GLOBALS.linkedProperties[typeName].incoming.me[oneProperty.id][otherComponentName] = {}
                                                        }

                                                        GLOBALS.linkedProperties[typeName].incoming.me[oneProperty.id][otherComponentName][otherProperty.id] = true


                                                        if (!GLOBALS.linkedProperties[otherComponentName].outgoing.them[typeName]) {
                                                            GLOBALS.linkedProperties[otherComponentName].outgoing.them[typeName] = {}
                                                        }
                                                        if (!GLOBALS.linkedProperties[otherComponentName].outgoing.them[typeName][oneProperty.id]) {
                                                            GLOBALS.linkedProperties[otherComponentName].outgoing.them[typeName][oneProperty.id] = {}
                                                        }
                                                        if (!GLOBALS.linkedProperties[otherComponentName].outgoing.them[typeName][oneProperty.id][otherProperty.id]) {
                                                            GLOBALS.linkedProperties[otherComponentName].outgoing.them[typeName][oneProperty.id][otherProperty.id] = true
                                                        }


                                                        if (!GLOBALS.linkedProperties[otherComponentName].outgoing.me) {
                                                            GLOBALS.linkedProperties[otherComponentName].outgoing.me = {}
                                                        }
                                                        if (!GLOBALS.linkedProperties[otherComponentName].outgoing.me[otherProperty.id]) {
                                                            GLOBALS.linkedProperties[otherComponentName].outgoing.me[otherProperty.id] = {}
                                                        }
                                                        if (!GLOBALS.linkedProperties[otherComponentName].outgoing.me[otherProperty.id][typeName]) {
                                                            GLOBALS.linkedProperties[otherComponentName].outgoing.me[otherProperty.id][typeName] = {}
                                                        }
                                                        if (!GLOBALS.linkedProperties[otherComponentName].outgoing.me[otherProperty.id][typeName][oneProperty.id]) {
                                                            GLOBALS.linkedProperties[otherComponentName].outgoing.me[otherProperty.id][typeName][oneProperty.id] = true
                                                        }


                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                            }
                        }

                    }
                }


//
// match my TYPES with ACCEPT_TYPES to other components
//
                if (oneProperty.types) {
                    let types = Object.keys(oneProperty.types)
                    for (let myType of types) {
//console.log("    " + myType)
                        for (let otherComponentName of GLOBALS.getAllLoadedTypeNames()) {
//if (otherComponentName == "table_control") {
//debugger
//}
                            if (otherComponentName != typeName) {
                                if (GLOBALS.isComponentTypeCached(otherComponentName)) {
                                    if (GLOBALS.getControlPropertyDefns({baseComponentId: otherComponentName})) {
                                        let otherProperties = GLOBALS.getControlPropertyDefns({baseComponentId: otherComponentName})
                                        for (let otherProperty of otherProperties) {
                                            if (otherProperty.accept_types) {
                                                for (let otherPropertyAcceptType of Object.keys(otherProperty.accept_types)) {
                                                    if (otherPropertyAcceptType == myType) {
//debugger
//console.log("        Found Match for " + myType)
                                                        if (!GLOBALS.linkedProperties[typeName].outgoing.them[otherComponentName]) {
                                                            GLOBALS.linkedProperties[typeName].outgoing.them[otherComponentName] = {}
                                                        }
                                                        if (!GLOBALS.linkedProperties[typeName].outgoing.them[otherComponentName][otherProperty.id]) {
                                                            GLOBALS.linkedProperties[typeName].outgoing.them[otherComponentName][otherProperty.id] = {}
                                                        }
                                                        GLOBALS.linkedProperties[typeName].outgoing.them[otherComponentName][otherProperty.id][oneProperty.id] = true

                                                        if (!GLOBALS.linkedProperties[typeName].outgoing.me) {
                                                            GLOBALS.linkedProperties[typeName].outgoing.me = {}
                                                        }
                                                        if (!GLOBALS.linkedProperties[typeName].outgoing.me[oneProperty.id]) {
                                                            GLOBALS.linkedProperties[typeName].outgoing.me[oneProperty.id] = {}
                                                        }

                                                        if (!GLOBALS.linkedProperties[typeName].outgoing.me[oneProperty.id][otherComponentName]) {
                                                            GLOBALS.linkedProperties[typeName].outgoing.me[oneProperty.id][otherComponentName] = {}
                                                        }
                                                        GLOBALS.linkedProperties[typeName].outgoing.me[oneProperty.id][otherComponentName][otherProperty.id] = true


                                                        if (!GLOBALS.linkedProperties[otherComponentName].incoming.them[typeName]) {
                                                            GLOBALS.linkedProperties[otherComponentName].incoming.them[typeName] = {}
                                                        }
                                                        if (!GLOBALS.linkedProperties[otherComponentName].incoming.them[typeName][oneProperty.id]) {
                                                            GLOBALS.linkedProperties[otherComponentName].incoming.them[typeName][oneProperty.id] = {}
                                                        }
                                                        if (!GLOBALS.linkedProperties[otherComponentName].incoming.them[typeName][oneProperty.id][otherProperty.id]) {
                                                            GLOBALS.linkedProperties[otherComponentName].incoming.them[typeName][oneProperty.id][otherProperty.id] = true
                                                        }


                                                        if (!GLOBALS.linkedProperties[otherComponentName].incoming.me) {
                                                            GLOBALS.linkedProperties[otherComponentName].incoming.me = {}
                                                        }
                                                        if (!GLOBALS.linkedProperties[otherComponentName].incoming.me[otherProperty.id]) {
                                                            GLOBALS.linkedProperties[otherComponentName].incoming.me[otherProperty.id] = {}
                                                        }
                                                        if (!GLOBALS.linkedProperties[otherComponentName].incoming.me[otherProperty.id][typeName]) {
                                                            GLOBALS.linkedProperties[otherComponentName].incoming.me[otherProperty.id][typeName] = {}
                                                        }
                                                        if (!GLOBALS.linkedProperties[otherComponentName].incoming.me[otherProperty.id][typeName][oneProperty.id]) {
                                                            GLOBALS.linkedProperties[otherComponentName].incoming.me[otherProperty.id][typeName][oneProperty.id] = true
                                                        }


                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                            }
                        }

                    }
                }


            }
        }

    }

}






















var listElm = null
var params = {}

var autoScroll = false;
var autoId = 0;
var nextItem = 1;
var wait_and_select_app = null





function onscrolled() {
if (mousedown) {
autoScroll = false;
//select_card(-1)
//console.log("onscroll")
}
};
var mousedown=false;
function onemousedown() {
//console.log("onmousedown")
mousedown = true
};
function onemouseup() {
//console.log("onmouseup")
mousedown = false
};



function closeCard() {
autoScroll = false
setTimeout(async function(){
await select_card(-1)
},200)
}


function alj(jj) {
alert(JSON.stringify(jj,null,2))
}



function isValidObject(variable){
    if ((typeof variable !== 'undefined') && (variable != null)) {
        return true
    }
    return false
}





function is_app(t) {

}
function uuidv4() {
return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
return v.toString(16);
});
}


function description(d) {

}
function base_component_id(d) {

}
function display_name(d) {

}
function created_timestamp(d) {

}

// this is a server side call but for some reason it gets evaluated
// when open a microservice which contains the "trace" function (Which
// is used for Jaeger OpenTracing)
function trace() {

}


async function rxsql(code_id,base_component_id, sqlcode, params) {
if (localAppshareApp) {
var results = localSql(sqlcode,params)
return results
} else {
var results = await callComponent(
{
base_component_id:    "systemFunctionAppSql"
}
,
{
sql:                sqlcode,
params:             params,
code_id:            code_id,
base_component_id:  base_component_id
})


return results
}
}

async function rxsql1(code_id,base_component_id,sqlcode, params) {
var x = await rxsql(code_id,base_component_id,sqlcode, params)
if (x && (x.length > 0)) {
return x[0]
} else {
return null
}
}



async function rxsqlFirstCol(code_id,base_component_id,sqlcode, params) {
var x = await rxsql(code_id,base_component_id,sqlcode, params)
if (x && (x.length > 0)) {
var colName = Object.keys(x[0])[0]
var ff = []
for (var tt=0; tt < x.length; tt++) {
ff.push(x[tt][colName])
}
return ff
} else {
return []
}
}

async function rxsqlFirstCol1(code_id,base_component_id,sqlcode, params) {
var x = await rxsqlFirstCol(code_id,base_component_id,sqlcode, params)
if (x && (x.length > 0)) {
return x[0]
} else {
return null
}
}

var appIntervalTimers = []
function appSetInterval(fnn,interval) {
var xx = setInterval(fnn,interval)
appIntervalTimers.push(xx)
}
function appClearIntervals() {
for(var i = 0; i < appIntervalTimers.length; i++){
clearInterval(appIntervalTimers[i]);
}
appIntervalTimers = []
}

function showProgressBar() {
mainMoonApp.show_loader = true
}
function hideProgressBar() {
mainMoonApp.show_loader = false
}

function callAjax(url, callback){
var xmlhttp;
// compatible with IE7+, Firefox, Chrome, Opera, Safari
xmlhttp = new XMLHttpRequest();
xmlhttp.onreadystatechange = function(){
if (xmlhttp.readyState == 4 && xmlhttp.status == 200){
callback(xmlhttp.responseText);
}
}
xmlhttp.open("GET", url, true);
xmlhttp.send();
}

function callAjax2(url, options, callback){
var xmlhttp;
//debugger
if (options && options.params) {
url += "?"
let paramArray = Object.entries(options.params)
let ajaxParams = Array.from(paramArray, ([name, value]) => ({ name, value }));
ajaxParams.forEach(
function myFunction(entry, index, ajaxParams) {
//debugger
url += entry.name + "=" + encodeURIComponent(entry.value) + "&";
});
}
console.log("callAjax2 url = " + url)


// compatible with IE7+, Firefox, Chrome, Opera, Safari
xmlhttp = new XMLHttpRequest();
xmlhttp.onreadystatechange = function(){
if (xmlhttp.readyState == 4 && xmlhttp.status == 200){
callback(xmlhttp.responseText);
}
}
xmlhttp.open("GET", url, true);
xmlhttp.send();
}

function callAjaxPost(url, value, callback){
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function(){

if (xhr.readyState == 4 && xhr.status == 200){
callback(xhr.responseText);
}
}
xhr.open("POST", url, true);
xhr.setRequestHeader('Content-Type', 'application/json');
//debugger
let payload = JSON.stringify({
value: value
})
xhr.send(payload);
}

</script>
<script>

var keycloak = null
var keycloakJsonInUse = null
function logoutKeycloak() {
if (keycloak) {
keycloakJsonInUse = null
keycloak.logout()
}
}
var username="";
function compareValues(a, b) {

//if a and b aren't the same type, they can't be equal
if (typeof a !== typeof b) {
return false;
}

if (typeof a === 'object') {
var keysA = Object.keys(a).sort(),
keysB = Object.keys(b).sort();

//if a and b are objects with different no of keys, unequal
if (keysA.length !== keysB.length) {
return false;
}

//if keys aren't all the same, unequal
if (!keysA.every(function(k, i) { return k === keysB[i];})) {
return false;
}

//recurse on the values for each key
return keysA.every(function(key) {
//if we made it here, they have identical keys
return compareValues(a[key], b[key]);
});

//for primitives just use a straight up check
} else {
return a === b;
}
}
function loadKeycloak(keycloakJson) {
if (keycloakJsonInUse) {
//debugger
if (compareValues(keycloakJsonInUse, keycloakJson)) {
return
}
}
var script = document.createElement('script');
script.onload = function () {
keycloak = Keycloak(keycloakJson);
keycloakJsonInUse = JSON.parse(JSON.stringify(keycloakJson))
keycloak.init(
{
onLoad: 'login-required' ,
checkLoginIframe: false
}
).success(function(authenticated) {
//alert(authenticated ? 'authenticated' : 'not authenticated');

if (authenticated) {
console.log("keycloak.subject:" + keycloak.subject)
console.log("Loading profile 1")
keycloak.loadUserProfile(function() {
console.log("Loading profile 2")
username = keycloak.profile.username;
console.log("keycloak username:" + username)
})
}

}).error(function(err) {

console.log('Failed to initialize keycloak: ' + err);
});
};
script.src = keycloakJson["auth-server-url"] + "/js/keycloak.js";
document.head.appendChild(script);
}

/*
loadKeycloak(
{
"realm": "yazz",
"auth-server-url": "http://127.0.0.1:8080/auth",
"ssl-required": "external",
"resource": "yazz",
"clientId": "yazz",
"public-client": true,
"confidential-port": 0,
"enable-cors": true
}
)
*/


console.log("Start debugger")
var thecode = `
(function xx() {
var a=10
if(runLine == 1) {return}
a=a+1
console.log(a)
if(runLine == 2) {return}
a=a+1
console.log(a)
if(runLine == 3) {return}
a=a+1
console.log(a)

})()
`
fullCode = async function(cc) {
eval(cc)
}

var runLine=2;
async function runn() {
fullCode(thecode)
}
runn()
//var rt=esprima.parse(thecode,{tolerant: true , loc:true, range: true, attachComment: false})
//console.log(JSON.stringify(rt,null,2))

let globalStartTimer = new Date().getTime()
let globalEndTimer = new Date().getTime()
let globalTimerCounter = 0
function resetTimer(messageToStart) {
console.log("Starting timer for: " + messageToStart)
globalStartTimer = new Date().getTime()
globalTimerCounter = 0
}

function showTimer(optionalMessage) {
globalEndTimer = new Date().getTime()
globalTimerCounter ++
let theTimerText = optionalMessage
if (!theTimerText) {
theTimerText = "" + globalTimerCounter
}
console.log("    Elapsed time in milliseconds: " + theTimerText + " : "+ (globalEndTimer - globalStartTimer))
}

function getUrlParam(paramName) {

var pairs = document.URL.split('?')
.pop()
.split('&');

for (var i = 0, p; i < pairs.length; i++) {
p = pairs[i].split('=');
if (p[0] == paramName) {
return p[1];
}
}

return null;
}




function msToTime(duration, options) {
if (!duration) {
return ""
}
let ret = new Date(duration).toUTCString()

let ret2 = ""

let currentTime = new Date().getTime()

let timeDiffSecs = (currentTime - duration) / 1000
let timeDiffMins = timeDiffSecs / 60
let timeDiffHours = timeDiffMins / 60
let timeDiffDays = timeDiffHours / 24
if (timeDiffSecs < 60) {
ret2 = ret2 + "a few seconds ago"
} else if (timeDiffMins < 10) {
ret2 = ret2 + "a few minutes ago"
} else if (timeDiffMins < 30) {
ret2 = ret2 + "less than half an hour ago"
} else if (timeDiffMins < 60) {
ret2 = ret2 + "under an hour ago"
} else if (timeDiffHours < 10) {
ret2 = ret2 + "a few hours ago"
} else if (timeDiffDays < 2) {
ret2 = ret2 + "yesterday"
} else if (timeDiffDays < 10) {
ret2 = ret2 + "a few days ago"
}

if (options && options.timeOnly) {
} else if (options && options.shortOnly) {
ret = ret2
} else {
ret =  ret2 +  " (" + ret + ")"
}

return ret
}

function capitalizeFirstLetter(string) {
return string.charAt(0).toUpperCase() + string.slice(1);
}


function timeDiffLater(time1, time2) {
//debugger
if (!time1) {
return ""
}
if (!time2) {
return ""
}
let duration = time2 - time1
let ret2 = ""

let timeDiffSecs = duration / 1000
let timeDiffMins = timeDiffSecs / 60
let timeDiffHours = timeDiffMins / 60
let timeDiffDays = timeDiffHours / 24
if (duration < 100) {
ret2 = ret2 + "a few milliseconds"
} else if (duration < 600) {
ret2 = ret2 + "half a second"
} else if (duration < 1000) {
ret2 = ret2 + "under a second"
} else if (duration < 1400) {
ret2 = ret2 + "about a second"
} else if (timeDiffSecs < 60) {
ret2 = ret2 + "a few seconds"
} else if (timeDiffMins < 10) {
ret2 = ret2 + "a few minutes"
} else if (timeDiffMins < 60) {
ret2 = ret2 + "little under an half an hour"
} else if (timeDiffMins < 60) {
ret2 = ret2 + "little under an hour"
} else if (timeDiffHours < 10) {
ret2 = ret2 + "a few hours"
} else if (timeDiffDays < 10) {
ret2 = ret2 + "a few days"
}


let ret = "after " + ret2

return ret
}


async function getFromYazzReturnJson(urlToget, urlParams) {
    let openfileurl = "http" + (($HOSTPORT == 443) ? "s" : "") + "://" + $HOST + urlToget + "?" +
        new URLSearchParams(urlParams)

    let promise = new Promise(async function (returnfn) {
        fetch(openfileurl, {
            method: 'get',
            credentials: "include"
        })
        .then((response) => response.json())
        .then(async function (responseJson) {
            returnfn(responseJson)
        })
        .catch(err => {
            //error block
            returnfn()
        })
    })
    retval = await promise
    return retval
}


async function postToYazzReturnJson(urlToget, postParams) {
    let openfileurl = "http" + (($HOSTPORT == 443) ? "s" : "") + "://" + $HOST + urlToget

    let promise = new Promise(async function (returnfn) {
        fetch(openfileurl, {
            method: 'post',
            //credentials: "include",
            headers: {
                'Content-Type': 'application/json'
                // 'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: JSON.stringify(postParams)

        })
        .then((response) => response.json())
        .then(async function (responseJson) {
            returnfn(responseJson)
        })
        .catch(err => {
            //error block
            returnfn()
        })
    })
    retval = await promise
    return retval
}



function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

function getYazzCookie() {
    return getCookie("yazz")
}


function enhanceCodeBeforeSaving(code, options) {
    let mm = this
    let parentHash = null
    let baseComponentId = null
    if (options) {
        parentHash = options.parentHash
        baseComponentId = options.baseComponentId
    }

    //
    // parent HASH
    //
    let lastParentHash = yz.getValueOfCodeString(code,"parent_hash")
    if (lastParentHash) {
        code = yz.deleteCodeString(code, "parent_hash")
    }
    if (parentHash) {
        code = yz.insertCodeString(code, "parent_hash", parentHash)
    }

    //
    // type
    //
    let oldBaseComp = yz.getValueOfCodeString(code,"base_component_id")
    if (oldBaseComp != baseComponentId ) {
        code = yz.deleteCodeString(code, "base_component_id")
        code = yz.insertCodeString(code, "base_component_id", baseComponentId)
    }

    //
    // timestamps
    //
    let timeNow = new Date().getTime()
    // if we don't want to reload this file then don't update the timestamp
    let createdTimestamp = yz.getValueOfCodeString(code, "created_timestamp")
    if ((createdTimestamp == null) || (createdTimestamp == "-1")) {
        if (yz.getValueOfCodeString(code,"load_once_from_file")) {
            timeNow = -1
        }
    }
    if (!createdTimestamp) {
        code = yz.deleteCodeString(code, "created_timestamp")
        code = yz.insertCodeString(code, "created_timestamp", timeNow)
    }

    code = yz.deleteCodeString(code, "updated_timestamp")
    code = yz.insertCodeString(code, "updated_timestamp", timeNow)


    //
    // Add a logo if none supplied
    //
    let logoUrl = yz.getValueOfCodeString(code,"logo_url")
    if (!isValidObject(logoUrl)) {
        logoUrl = "/driver_icons/js.png"
        code = yz.insertCodeString(code, "logo_url", logoUrl)
    }


    //
    // visibility
    //
    let visibility = null
    let newvisibility = null
    visibility = yz.getValueOfCodeString(code,"visibility")
    newvisibility = visibility
    if (!isValidObject(visibility)) {
        if (isValidObject(options) && options.make_public) {
            newvisibility = "PUBLIC"
        } else {
            newvisibility = "PRIVATE"
        }
    }
    if (newvisibility != visibility) {
        code = yz.deleteCodeString(code, "visibility")
        code = yz.insertCodeString(code, "visibility", newvisibility)
    }
    //
    // return the amended code
    //
    return code
}

</script>



<script id="web_worker_1" type="javascript/worker">


async function webWorkerPostToYazzReturnJson(host, hostPort, urlToPost, postParams) {
    let openfileurl = "http" + ((hostPort == 443) ? "s" : "") + "://" + host + urlToPost


    let promise = new Promise(async function (returnfn) {
        fetch(openfileurl, {
            method: 'post',
            //credentials: "include",
            headers: {
                'Content-Type': 'application/json'
                // 'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: JSON.stringify(postParams)

        })
        .then((response) => response.json())
        .then(async function (responseJson) {
            returnfn(responseJson)
        })
        .catch(err => {
            //error block
            returnfn()
        })
    })
    retval = await promise
    return retval
}




        // This script won't be parsed by JS engines because its type is javascript/worker.
        self.onmessage = async function(e) {
        //debugger
            let host        = e.data.host
            let hostPort    = e.data.hostPort
            let code        = e.data.code
            let options     = e.data.options
            //console.log("in web worker, host: " +  host )
            //console.log("in web worker, hostPort: " +  hostPort )
            //console.log("in web worker, code: " +  code.length )
            //console.log("in web worker, options: " +  JSON.stringify(options,null,2)  )

            await webWorkerPostToYazzReturnJson(host, hostPort, "/save_code_v3",
            {
                value: {
                    code:       code,
                    options:    {
                                    sub_components:         options.sub_components,
                                    save_html:              true,
                                    save_code_to_file:      options.saveCodeToFile,
                                    allowAppToWorkOffline:  options.allowAppToWorkOffline,
                                    allowChanges:           false
                                }
                }
            }
            ,
            async function(response){
                console.log("Code saved")
            })
        };
        // Rest of your worker code goes here.
</script>


<script>

async function sqliteQuery(sql) {
    let results = await callComponent(
        {
            base_component_id:    "readFromInternalSqliteDatabase"
        }
        ,
        {
            sql: sql
        })
    return results
}




/*
 Here are what is used to execute code:
    queuedBrowserResponseSeqNum     - ascending counter used to identify requests send via web sockets to the server
    queuedResponses[seqNum]         = callbackFn; // called when the websocket fn returns
    componentCallsListArgsSent[seqNum]    = args..  // arguents send to the server
    queuedResponses                 = new Object()
    queuedBrowserResponseSeqNum     = 0
    componentCallsListArgsSent            = new Object()




 Here are what the main component loading functions and vars do:




    METHODS
    -------

      -----------
    - checkLibsV3
      -----------
        checks that related libs are loaded


      ------------------
    - loadUiComponentsV4
      ------------------
        Loads Yazz UI components only

      ---------------------------
    - enhanceYazzSourceCodeBeforeRunning
      ---------------------------
        parse and run the source code for a Yazz Component loaded into the front end



      -------------
    - callComponent
      -------------
        This actually can call server side code and return a result. We can pass either the base component ID
        or the commit ID for the code to run


 */



async function checkLibsV3(libsToLoad){
    if (libsToLoad && libsToLoad.length > 0 ) {
        for (var tt = 0; tt < libsToLoad.length ; tt++) {
            if (!GLOBALS.libLoaded[ libsToLoad[tt].dependency_name ]) {
                GLOBALS.libLoaded[ libsToLoad[tt].dependency_name ] = true
            }
        }
    }
}














/*
________________________________________
|                                      |
|       loadUiComponentsV4             |
|                                      |
|______________________________________|
 Dynamically loads a component class into the currently running system. V4
 should have the ability to load components via IPFS as well

 Can be called like:

     loadUiComponentsV4(    "button_control"  )
     loadUiComponentsV4(  [ "button_control" ]  )
     loadUiComponentsV4(  [ "button_control"   ,  "label_control"  ]  )
     loadUiComponentsV4(  [ { baseComponentId: "button_control" }]  )
     loadUiComponentsV4(  [ { baseComponentId: "button_control" }  ,  { codeId: "Qmeff737e7878...3223" } ]  )
__________
| PARAMS |______________________________________________________________
|
|     argComponentsToLoad
|     -------------------   This is a list of all the UI components that
|                           we wish to load
|
|     argsToPassToUiComponents
|     ------------------------      This is the arguments that we wish to pass into the UI component.
|                                   I am not sure where this is used. I will have to look to find out
|                                   more
|
|________________________________________________________________________ */
async function loadUiComponentsV4( argComponentsToLoad, argsToPassToUiComponents ) {
    console.log("loadUiComponentsV4")
    console.log("    argComponentsToLoad := " + JSON.stringify(argComponentsToLoad,null,2))
    console.log("    argsToPassToUiComponents := " + JSON.stringify(argsToPassToUiComponents,null,2))
    console.log("")

    /*
    ________________________________________
    |    loadUiComponentsV4                |
    |_________________                     |______________________________________
                     |
                     | Transform "argComponentsToLoad" from a list
                     | into a list of tuples in "whichComponentsToLoadAsTuples":
                     | [
                     |    {baseComponentId: "label"},
                     |    {baseComponentId: "button"},
                     |    {baseComponentId: "button",  codeId: "1f"},
                     |    {codeId: "1f"}
                     | ]
                     |____________________________________________________________
    */
    if (typeof argComponentsToLoad === 'string' || argComponentsToLoad instanceof String) {
        argComponentsToLoad = [{baseComponentId: argComponentsToLoad}]
    } else if (!Array.isArray(argComponentsToLoad)) {
        argComponentsToLoad = [argComponentsToLoad]
    }

    let whichComponentsToLoadAsTuples = []
    for ( let componentItem  of  argComponentsToLoad ) {
        if (typeof componentItem == 'string') {
            whichComponentsToLoadAsTuples.push({baseComponentId: componentItem})
        } else {
            whichComponentsToLoadAsTuples.push(componentItem)
        }
    }



    /*
    ________________________________________
    |    loadUiComponentsV4                |
    |_________________                     |______________________________________
                     |
                     | For static HTML pages (ie: just HTML , with no Yazz engine)
                     | then load the components from the global componenet cache which
                     | contains all the UI control definitions
                     |____________________________________________________________
    */

    let loadedStatic = false
    if (GLOBALS.isStaticHtmlPageApp) {
        for (let tt=0; tt < whichComponentsToLoadAsTuples.length; tt++) {
            let componentType = whichComponentsToLoadAsTuples[tt].baseComponentId
            GLOBALS.loadedControlsMapInCurrentlyEditedApp[componentType] = true
            if (GLOBALS.isStaticHtmlPageApp  &&  GLOBALS.getCommitIdForBaseComponentId(componentType)  && !GLOBALS.isComponentLoaded({baseComponentId: componentType})) {
                console.log("loadUiComponentsV4: " + componentType)
                //alert("Reading app from cache: " + findComponentArgs.base_component_id)

                //let newDataCodeId   = GLOBALS.baseComponentIdReturnsCommitId[ componentType ]
                let newDataCodeId   = GLOBALS.getCommitIdForBaseComponentId( componentType )
                let codeForCommit   = GLOBALS.getCodeForComponent({codeId: newDataCodeId })
                let libsForCode     = GLOBALS.getLibsForCommit({codeId: newDataCodeId })
                let properties = yz.getValueOfCodeString(codeForCommit, "properties",")//properties")

                await checkLibsV3(libsForCode)
                if (componentType.startsWith("label_control")) {
                    //debugger
                }

                let trcode2 = await enhanceYazzSourceCodeBeforeRunning({codeId: newDataCodeId,   code: codeForCommit})
                await runYazzSourceCode(trcode2, argsToPassToUiComponents, null)
                GLOBALS.setComponentLoaded({codeId: newDataCodeId})
                loadedStatic = true
            }
        }
    }





    /*
    ________________________________________
    |    loadUiComponentsV4                |
    |_________________                     |______________________________________
                     |
                     | For Dynamic HTML pages (which have access to the Yazz engine)
                     | first find out which components are not loaded and need to be
                     | loaded in
                     |____________________________________________________________
    */
    let componentsItemsToLoad = []
    if (!loadedStatic) {
        for (let  componentTuple  of  whichComponentsToLoadAsTuples  ) {
            let componentType       = componentTuple.baseComponentId
            let componentCodeId     = componentTuple.codeId


            //
            // if we have cached the component then run it
            //
            if (componentCodeId && GLOBALS.getCodeForComponent({codeId: componentCodeId})) {
                let compCode        = GLOBALS.getCodeForComponent({codeId: componentCodeId})
                if (compCode) {
                    let libsForCode     = GLOBALS.getLibsForCommit({codeId: componentCodeId })
                    await checkLibsV3(libsForCode)
                    let trcode2 = await enhanceYazzSourceCodeBeforeRunning({codeId: componentCodeId,   code: compCode})
                    await runYazzSourceCode(trcode2, argsToPassToUiComponents, null)
                }

            //
            // if we have haven't cached the component (given the code ID) then put it on the list of things to load
            //
            } else if (componentCodeId && !GLOBALS.getCodeForComponent({codeId: componentCodeId})) {
                componentsItemsToLoad.push(componentTuple)

            //
            // if we have haven't cached the component (given the Type) then put it on the list of things to load
            //
            } else if (componentType && (!GLOBALS.isComponentTypeCached(componentType))) {
                componentsItemsToLoad.push(componentTuple)

            //
            // Otherwise just put it on the list of things to load
            //
            } else {
                //Causes a crash as editor is reloaded
                //componentsItemsToLoad.push(componentTuple)
            }
        }

        if (componentsItemsToLoad.length > 0) {
            let promise = new Promise(async function(returnfn) {
                let resultsUi = await postToYazzReturnJson(
                    "/load_ui_components_v3",
                    {
                        find_components:  {items: componentsItemsToLoad},
                    })

                    for (const data of resultsUi) {

                        var sdf     = eval("(" + data.record + ")")

                        for (var i=0; i< sdf.length; i++) {
                            if (sdf[i]) {
                                await checkLibsV3(sdf[i])
                            }
                            let trcode2 = await enhanceYazzSourceCodeBeforeRunning(
                                {
                                    codeId:             sdf[i].code_id,
                                    baseComponentId:    sdf[i].base_component_id,
                                    code:               sdf[i].code
                                })
                            await runYazzSourceCode(trcode2, argsToPassToUiComponents, null)

                        }
                    };

                returnfn({})

            })

            let ret = await promise
            return ret
        }
    }


    return {}
}









/*
________________________________________
|                                      |
|       callComponent                  |
|                                      |
|______________________________________|
Calls a server side component and returns the results
__________
| PARAMS |______________________________________________________________
|
|     componentSearchDetails
|     ----------------------    Some text
|                               can go here
|
|     fnCallArgs
|     ----------    Some text
|                   can go here
|
|________________________________________________________________________ */
async function callComponent(  componentSearchDetails,  fnCallArgs  ) {
    var promise = new Promise(returnfn => {
        let seqNum                          = queuedBrowserResponseSeqNum ++;
        queuedResponses[seqNum]             = function(result) {returnfn(result)};
        componentCallsListArgsSent[seqNum]  = fnCallArgs

        sendToServerViaWebSocket({
            message_type:   "browser_calls_component_via_web_socket",
            find_component: componentSearchDetails,
            args:           fnCallArgs,
            seqNum:         seqNum
        });
    })

    var ret = await promise
    if (ret) {
        if (ret.value) {
            return ret.value
        } else if (ret.error) {
            throw ret.error
        }
    }

    return ret
}









/*
________________________________________
|                                      |
|  enhanceYazzSourceCodeBeforeRunning  |
|                                      |
|______________________________________|
Function description
__________
| PARAMS |______________________________________________________________
|
|     args      {
|     ----          codeId
|                   baseComponentId
|               }
|________________________________________________________________________ */
async function enhanceYazzSourceCodeBeforeRunning(args) {
    let codeId          = null
    let baseComponentId = null
    let code            = args.code


    /*
    ____________________________________________________________
    |    enhanceYazzSourceCodeBeforeRunning
    |_________________________
                             | Set the commit ID and type
                             |__________________________________ */
    if (!args) {
    } else if (args.codeId) {
        codeId = args.codeId
        baseComponentId = GLOBALS.getTypeForCommitId(codeId)
    } else if (args.baseComponentId) {
        baseComponentId = args.baseComponentId
        codeId = GLOBALS.getCommitIdForBaseComponentId(args.baseComponentId)
    }

    try {
        /*
        ____________________________________________________________
        |    enhanceYazzSourceCodeBeforeRunning
        |_________________________
                                 | Determine the apps SQlite database
                                 | to use
                                 |__________________________________ */
        let useDb = GLOBALS.getDbToUse({codeId: codeId, baseComponentId: baseComponentId})




        /*
        ____________________________________________________________
        |    enhanceYazzSourceCodeBeforeRunning
        |_________________________
                                 | if the component type hasn't been
                                 | added to the type database then add it
                                 | to use
                                 |__________________________________ */
                                 //zzz
        if (!GLOBALS.getCommitIdForBaseComponentId( baseComponentId )) {
        //if (!GLOBALS.isComponentTypeCached(baseComponentId)) {
            let codeId = await getIpfsHash(  code  )
            GLOBALS.cacheThisComponentCode(  {codeId: codeId,    code: code}  )
        }






        /*
        ____________________________________________________________
        |    enhanceYazzSourceCodeBeforeRunning
        |_________________________
                                 | If we are running the app from a
                                 | HTML page then run the SQL queries
                                 | from the embedded SQLite database
                                 |__________________________________ */
        let addP = "'" + codeId + "', '" + useDb + "', "
        if (localAppshareApp) {

            if (sqlitedata) {
                let b = base64ToUint8Array(sqlitedata)
                localSqliteDb = new SQL.Database(b);
            } else {
                let eds = yz.getValueOfCodeString(code, "sqlite",")//sqlite")
                if (eds){
                    for (let te = 1; te < eds.length ; te = te + 2) {
                        let sqlStatements = eds[te]
                        for (let te2 = 0; te2 < sqlStatements.length ; te2 ++) {
                            let sqlStatement = sqlStatements[te2]
                            localSql(sqlStatement)
                        }

                    }
                }
            }
        }







        /*
        ____________________________________________________________
        |    enhanceYazzSourceCodeBeforeRunning
        |_________________________
                                 | Add debugger info to the code to
                                 | allow step by step debugging
                                 |__________________________________ */
        let trcode2 = "(" + code + ")"

        let component_type = yz.getValueOfCodeString(code, "component_type")
        if (
            (component_type != "APP") &&
            (component_type != "SYSTEM") &&
            (component_type != "VB"))
        {
            trcode2 = getDebugCode(baseComponentId,  trcode2)
        } else if (component_type == "VB") {
            //console.log("Component to index: " + componentRecord.base_component_id)
            if (baseComponentId.startsWith("label_control")) {
                debugger
            }

            indexComponent( baseComponentId  )
        }






        /*
        ____________________________________________________________
        |    enhanceYazzSourceCodeBeforeRunning
        |_________________________
                                 | Sqlite stuff
                                 |__________________________________ */
        trcode2 = trcode2.toString().replaceAll("sql[(]","await rxsql(" + addP)
        trcode2 = trcode2.toString().replaceAll("sql1[(]","await rxsql1(" + addP)
        trcode2 = trcode2.toString().replaceAll("sqlFirstCol[(]","await rxsqlFirstCol(" + addP)
        trcode2 = trcode2.toString().replaceAll("sqlFirstCol1[(]","await rxsqlFirstCol1(" + addP)






        /*
        ____________________________________________________________
        |    enhanceYazzSourceCodeBeforeRunning
        |_________________________
                                 | User auth stuff
                                 |__________________________________ */
        let kkk = yz.getValueOfCodeString(trcode2.toString(), "keycloak",")//keycloak")
        if (kkk) {
            //alert(JSON.stringify(kkk,null,2))
            if (!kkk.clientId) {
                kkk.clientId = kkk.resource
            }
            loadKeycloak(
                    kkk
                )
        }







//zzz
        /*
        ____________________________________________________________
        |    enhanceYazzSourceCodeBeforeRunning
        |_________________________
                                 | Transform the code using the
                                 | runtime pipelines
                                 |__________________________________ */
        let runtimePipeline = yz.getValueOfCodeString(trcode2, "runtime_pipeline")
        if (runtimePipeline){
            for (let pipelineItem of runtimePipeline) {
                if (pipelineItem == "APP") {

                    let startIndex = trcode2.indexOf("/* ** *** insert_code_here_start *** ** */")
                    if (startIndex != -1) {
                        startIndex += 42 // nothing to do with Hitchhikers Guide To The Galaxy, 42 is the string length needed!
                    }
                    let endIndex = trcode2.indexOf("/* ** *** insert_code_here_end *** ** */")

                    let editorCodeToCopy = await GLOBALS.getPipelineCodeToCopy(
                        {
                            pipelineName: "APP",
                            fromMarker: "//*** gen_start ***//",
                            toMarker: "//*** gen_end ***//"
                        })

                    if (startIndex != -1) {
                        if (endIndex != -1) {
                            trcode2 = trcode2.substring(0,startIndex) +

                                editorCodeToCopy +

                                trcode2.substring(endIndex)
                        }
                    }






                    if (baseComponentId.startsWith("COMP_")) {
                        //debugger
                    }

                    let model = yz.getValueOfCodeString(trcode2,"formEditor",")//formEditor")
                    let modelAsText =  JSON.stringify( model,

                        function(key, value) {
                            if (typeof value === 'string') {
                                return  value.toString()
                            }
                            return value;
                        }, 2)

                    let startIndex2 = trcode2.indexOf("/* ** insert_app_model_start ** */")
                    if (startIndex2 != -1) {
                        startIndex2 += 34
                    }
                    let endIndex2 = trcode2.indexOf("/* ** insert_app_model_end ** */")

                    if (startIndex2 != -1) {
                        if (endIndex2 != -1) {
                            trcode2 = trcode2.substring(0,startIndex2) +

                                modelAsText +

                                trcode2.substring(endIndex2)
                        }
                    }






                    trcode2 = trcode2.toString().replaceAll("_REPLACE_THIS_WITH_BASE_COMPONENT_ID_",baseComponentId )

                }
                if (baseComponentId.startsWith("COMP_")) {
                        //await saveDebugTextOnServer(trcode2, "z.js")
                }
            }
        }







        return trcode2

    } catch (err) {
        alert(err)

        hideProgressBar()
    }
}













async function runYazzSourceCode(trcode2, args, callbackFn) {
    //Don't run any server code
    if (trcode2.toString().includes("only_run_on_server(true)")) {
        mainMoonApp.console_output  = ""
        mainMoonApp.is_gui_app      = false
    } else if (!trcode2.toString().includes("Vue.")) {
        mainMoonApp.console_output = ""
        mainMoonApp.is_gui_app = false
    } else {
        let fnfn = eval( trcode2  )
        if (trcode2.indexOf("async ")  == -1) {
            let fnfnRes = fnfn(args)
            //if (isValidObject(callbackFn)) {
            if (callbackFn) {
                callbackFn(fnfnRes)
            }

        } else {
            let fnfnRes = await fnfn(args)
            //if (isValidObject(callbackFn)) {
            if (callbackFn) {
                callbackFn(fnfnRes)
            }
        }
    }
}

async function getSubComponents(srcCode) {
    let subC = yz.getValueOfCodeString(srcCode,"sub_components")
    if (!subC) {
        return []
    }
    let retRes = []
    for (let subComponent  of  subC) {
        if (typeof subComponent === 'string' || subComponent instanceof String) {
            retRes.push({child_base_component_id: subComponent})
        } else {
            retRes.push(subComponent)
        }
    }

    return retRes
}







/*
________________________________________
|                                      |
|         saveDebugTextOnServer        |
|                                      |
|______________________________________|
Function description
__________
| PARAMS |______________________________________________________________
|
|     textInput         The text to save
|     ---------
|
|      fileLocation     Where to save the text
|      ------------
|________________________________________________________________________ */
async function saveDebugTextOnServer(textInput, fileLocation) {
    let resultsUi = await postToYazzReturnJson(
        "/save_debug_text",
        {
            textInput:      textInput,
            fileLocation:   fileLocation
        })

}


</script>
</body>
</html>
