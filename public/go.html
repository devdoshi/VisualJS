<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" Content-Type="text/javascript; charset=utf-8" content="initial-scale=1.0, width=device-width, height=device-height, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta charset="UTF-8" />
<link rel="stylesheet" href="https://cdn.usebootstrap.com/bootstrap/4.1.3/css/bootstrap.min.css">


<style>
#visualization {
width: 100%;
height: 50%;
border: 1px solid lightgray;
}
</style>

</script>


<script>
var web3loaded = false
var disableAutoSave = false;
var pageInitialised = false
var executeOnPageLoad = null
async function onPageInitialized(doCode) {

executeOnPageLoad = doCode
if (pageInitialised) {
await executeOnPageLoad()
executeOnPageLoad = null
}
}


var visJsloaded = false
var useVisJs = async function() {
if (!visJsloaded) {
//debugger
let loadVisJsScript = document.createElement('script');
loadVisJsScript.src = "/js_libs/vis-timeline-graph2d.min.css";

document.head.appendChild(loadVisJsScript);
loadVisJsScript.onload = function () {
try {
} catch (error) {
}
visJsloaded = true
};
}
}
var visCssloaded = false
var useVisCss = async function() {
if (!visCssloaded) {
//debugger
let loadVisCssScript = document.createElement('script');
loadVisCssScript.src = "/js_libs/vis-timeline-graph2d.min.js";

document.head.appendChild(loadVisCssScript);
loadVisCssScript.onload = function () {
try {
} catch (error) {
}
visCssloaded = true
};
}
}



var useWeb3 = async function() {

if (!web3loaded) {
//debugger
let loadWeb3LibScript = document.createElement('script');
loadWeb3LibScript.src = "/js_libs/web3.min.js";

document.head.appendChild(loadWeb3LibScript);
loadWeb3LibScript.onload = function () {
//debugger
try {
window.ethereum.request({method: "eth_requestAccounts"});

web3 = new Web3(window.ethereum);


(async function () {

//await switchBlockchainNetwork('1')   //eth mainnet
//await switchBlockchainNetwork('97')   //binance testnet
//await switchBlockchainNetwork('80001')   //polygon testnet
await switchBlockchainNetwork(window.currentBlockchain)   //polygon testnet

})()


} catch (error) {

}
web3loaded = true
};
}
}

var ideToolsloaded = false
var useIdeTools = async function() {
if (!ideToolsloaded) {
//debugger
let promise = new Promise(returnfn => {
let loadIdeToolsLibScript = document.createElement('script');
loadIdeToolsLibScript.src = "/js_libs/idetools.js";
document.head.appendChild(loadIdeToolsLibScript);
loadIdeToolsLibScript.onload = function () {
try {
} catch (error) {
}
ideToolsloaded = true
returnfn()
};
})
let ret = await promise
}
}



var diffJsloaded = false
var useDiffJs = async function() {
if (!diffJsloaded) {
//debugger
let promise = new Promise(returnfn => {
let loadDiffJsScript = document.createElement('script');
loadDiffJsScript.src = "/js_libs/diff.js";
document.head.appendChild(loadDiffJsScript);
loadDiffJsScript.onload = function () {
try {
} catch (error) {
}
diffJsloaded = true
returnfn()
};
})
let ret = await promise
}
}







var d3loaded = false
var useD3 = async function() {
if (!d3loaded) {
//debugger
let promise = new Promise(returnfn => {
let loadD3LibScript = document.createElement('script');
loadD3LibScript.src = "/js_libs/d3.js";
document.head.appendChild(loadD3LibScript);
loadD3LibScript.onload = function () {
try {
} catch (error) {
}
d3loaded = true
returnfn()
};
})
let ret = await promise
}
}



let signMessageTemplate =   "Hi there from Yazz. Sign this message " +
"to prove you have access to this wallet " +
"and we'll log you in. This won't cost " +
"you any Ether." +
"\n\n" +
"To stop hackers using your wallet, here's " +
"a unique message ID they can't guess: "

var chartsJsloaded = false
var useChartsJs = async function() {

if (!chartsJsloaded) {
//debugger
let promise = new Promise(returnfn => {
let loadChartsJsLibScript = document.createElement('script');
loadChartsJsLibScript.src = "/js_libs/charts.js";

document.head.appendChild(loadChartsJsLibScript);
loadChartsJsLibScript.onload = function () {
//debugger
try {


} catch (error) {

}
chartsJsloaded = true
returnfn()
};

})


let ret = await promise

}
}







var estraverseloaded = false
var useEstraverse = async function() {

if (!estraverseloaded) {
//debugger
let promise = new Promise(returnfn => {
let loadEstraverseScript = document.createElement('script');
loadEstraverseScript.src = "/js_libs/estraverse1.7.1.js";

document.head.appendChild(loadEstraverseScript);
loadEstraverseScript.onload = function () {
//debugger
try {
} catch (error) {
}
estraverseloaded = true
returnfn()
};
})


let ret = await promise

}
}






var esCodeGenLoaded = false
var useEsCodeGen = async function() {
if (!esCodeGenLoaded) {
//debugger
let promise = new Promise(returnfn => {
let loadEsCodeGenScript = document.createElement('script');
loadEsCodeGenScript.src = "/js_libs/escodegen.js";

document.head.appendChild(loadEsCodeGenScript);
loadEsCodeGenScript.onload = function () {
//debugger
try {
} catch (error) {
}
esCodeGenLoaded = true
returnfn()
};
})


let ret = await promise

}
}









var tabulatorJsLoaded = false
var useTabulatorJs = async function() {

if (!tabulatorJsLoaded) {
//debugger
let promise = new Promise(returnfn => {
let loadTabulatorJsLibScript = document.createElement('script');
loadTabulatorJsLibScript.src = "/js_libs/tabulator.js";

document.head.appendChild(loadTabulatorJsLibScript);
loadTabulatorJsLibScript.onload = function () {
//debugger
try {


} catch (error) {

}
tabulatorJsLoaded = true
returnfn()
};

})


let ret = await promise

}
}


function filterBlockchainParams(blockchainDetails) {
return {
chainId: blockchainDetails.chainId,
chainName: blockchainDetails.chainName,
rpcUrls: blockchainDetails.rpcUrls,
blockExplorerUrls: blockchainDetails.blockExplorerUrls,
nativeCurrency: blockchainDetails.nativeCurrency
}
}
window.currentBlockchain = "1"
window.blockchainIds = {
'0': 'kardia',
'1': {chainId: '0x1',chainName:'Ethereum - Mainnet',rpcUrls:['https://mainnet.infura.io/v3/'],blockExplorerUrls:['https://etherscan.io'],nativeCurrency: {symbol:'ETH',decimals: 18}},
'4': {chainId: '0x4',chainName:'Ethereum - Rinkby test net',rpcUrls:['https://rinkeby.infura.io/v3/'],blockExplorerUrls:['https://rinkeby.etherscan.io'],nativeCurrency: {symbol:'ETH',decimals: 18}, faucet: "https://rinkebyfaucet.com/"},
'8': 'ubiq',
'10': 'optimism',
'19': 'songbird',
'20': 'elastos',
'25': 'cronos',
'30': {
chainId: '0x1e',
chainName:'rsk - mainnet',
rpcUrls:["https://public-node.rsk.co"],
blockExplorerUrls:['https://explorer.rsk.co'],
nativeCurrency: {symbol:'RBTC',decimals: 18}
},
'31': {
chainId: '0x1f',
chainName:'rsk - testnet',
rpcUrls:["https://public-node.testnet.rsk.co"],
blockExplorerUrls:['https://explorer.testnet.rsk.co'],
nativeCurrency: {symbol:'RBTC',decimals: 18},
faucet: "https://faucet.rsk.co",
preMinedUrl: "https://explorer.testnet.rsk.co/address/",
postMinedUrl: ""
},
'40': {chainId: '0x28',chainName:'telos - mainnet',rpcUrls:['https://mainnet.telos.net/evm'],blockExplorerUrls:['https://teloscan.io'],nativeCurrency: {symbol:'TLOS',decimals: 18},
faucet: "https://app.telos.net/testnet/developers"},
'41': {
chainId: '0x29',
chainName:'telos - testnet',
rpcUrls:["https://testnet.telos.net/evm"],
blockExplorerUrls:['https://testnet.teloscan.io'],
nativeCurrency: {symbol:'TLOS',decimals: 18},
faucet: "https://app.telos.net/testnet/developers"
},
'52': 'csc',
'55': 'zyx',
'56': 'binance',
'57': 'syscoin',
'60': 'gochain',
'61': 'ethclassic',
'66': 'okexchain',
'70': 'hoo',
'82': 'meter',
'88': 'tomochain',
'97': {chainId: '0x61',chainName:'Binance Smart Chain - Testnet',rpcUrls:['https://data-seed-prebsc-1-s1.binance.org:8545'],blockExplorerUrls:['https://testnet.bscscan.com'],nativeCurrency: {symbol:'BNB',decimals: 18}},
'100': 'xdai',
'106': 'velas',
'108': 'thundercore',
'122': 'fuse',
'128': 'heco',
'137': 'polygon',
'200': 'xdaiarb',
'246': 'energyweb',
'250': {chainId: '0xFA',chainName: 'Fantom Opera Mainnet',rpcUrls:['https://rpc.ftm.tools/'],blockExplorerUrls:['https://ftmscan.com'],nativeCurrency: {symbol:'FTM',decimals: 18}},
'269': 'hpb',
'288': 'boba',
'321': 'kucoin',
'336': 'shiden',
'361': 'theta',
'592': 'astar',
'820': 'callisto',
'888': 'wanchain',
'1088': 'metis',
'1284': 'moonbeam',
'1285': 'moonriver',
'2020': 'ronin',
'4689': 'iotex',
'5050': 'xlc',
'5551': 'nahmii',
'8217': 'klaytn',
'10000': 'smartbch',
'32659': 'fusion',
'42161': 'arbitrum',
'421611': {
chainId: '0x66EEB',
chainName:'arbitrum - testnet',
rpcUrls:["https://rinkeby.arbitrum.io/rpc"],
blockExplorerUrls:['https://rinkeby-explorer.arbitrum.io/#/'],
nativeCurrency: {symbol:'ETH',decimals: 18},
faucet: "https://docs.theanthill.io/how-to/getting-bnb-on-binance-smart-chain-bsc-testnet"
},
'42220': 'celo',
'42262': 'oasis',
'43114': 'avalanche',
'71394': 'godwoken',
'80001': {chainId: '0x80001',chainName:'Mumbai Testnet',rpcUrls:['https://rpc-mumbai.maticvigil.com'],blockExplorerUrls:['https://polygonscan.com'],nativeCurrency: {symbol:'MATIC',decimals: 18},
faucet: "https://faucet.polygon.technology"},
'333999': 'polis',
'1313161554': 'aurora',
'1666600000': 'harmony',
'11297108109': 'palm',
'836542336838601': 'curio'
}
async function switchBlockchainNetwork(blockchainId) {

const provider = window.ethereum;
if(!provider){
console.log("Metamask is not installed, please install!");
}
let chainId = await provider.request({ method: "eth_chainId" });
if (chainId === window.blockchainIds[blockchainId].chainId) {
console.log("Bravo!, you are on the correct network");
} else {
console.log("oulalal, switch to the correct network")
}

try {
await provider.request({
method: "wallet_switchEthereumChain",
params: [{ chainId: window.blockchainIds[blockchainId].chainId}],
});
console.log("You have succefully switched to Binance Test network")
} catch (switchError) {
// This error code indicates that the chain has not been added to MetaMask.
if (switchError.code === 4902) {
console.log("This network is not available in your metamask, please add it")
}
console.log("Failed to switch to the network")
try {
await provider.request({
method: 'wallet_addEthereumChain',
params: [
filterBlockchainParams(window.blockchainIds[blockchainId])
]
});
} catch (addError) {
console.log(addError);
return false
}
}
return true

}



var testObject = null; // Use this to test elements at debug time
/*use_local_sqlite_start*/let localAppshareApp = false/*use_local_sqlite_end*/
/*edit_app_share_app_start*/let editAppShareApp = null/*edit_app_share_app_end*/
var override_app_editor = null
var editingAppId = null
var localSqliteDb    = null
var networkIntranetIpAddress    = null
var libLoaded        = new Object()
var component_loaded = new Object()
var component_cache  = new Object()
var linked_properties  = new Object()
var advancedAlreadyLoaded=false


var online           = false
var dev_app_component_loaded = new Object()
var file_upload_uuid = null
var base_component_id = null
let isStaticHtmlPageApp = false
var queuedResponses = new Object()
var queuedBrowserResponseSeqNum = 0
var callDriverMethodArgs = new Object()
var globalControl={}
var globalControlDesignMode={}
var uiDebuggerOn = false
var saveCodeToFile = null

var isWin = null

var executionCode       = new Object()
var currentTimelineLogPoint = 0
var maxTimelineLogPoint = 0
var startTimelineTop    = 0
var executionTimeline   = []
var executionTimelineVars   = {}
var executionTimelineMapTimeToLine   = {}
var globalWatchList   = {}

</script>

<script>
//SQLITE
</script>

<script>
let sqlitedata = ''
</script>


<script>
//***ADD_SCRIPT
</script>



<script>
</script>




<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.4.0/min/dropzone.min.js"></script>





<style>
.containerclasslargetext {
container-type: inline-size;
}
.containerclassmediumtext {
container-type: inline-size;
}
.containerclasssmalltext {
container-type: inline-size;
}
.containerclasshugetext {
container-type: inline-size;
}
.containerclasshugetext {
container-type: inline-size;
}
.containerclass {
container-type: inline-size;
}
@container  (min-width: 0px) {
.containerclass > * {
font-size: var(--fontresizable);
}
}

@container  (min-width: 0px) {
.containerclasslargetext > * {
font-size: 25cqw;
}
}
@container  (min-width: 0px) {
.containerclassmediumtext > * {
font-size: 15cqw;
}
}
@container  (min-width: 0px) {
.containerclasssmalltext > * {
font-size: 5cqw;
}
}
@container  (min-width: 0px) {
.containerclasshugetext > * {
font-size: 50cqw;
}
}



blink {
-webkit-animation: 2s linear infinite condemned_blink_effect; /* for Safari 4.0 - 8.0 */
animation: 2s linear infinite condemned_blink_effect;
}

/* for Safari 4.0 - 8.0 */
@-webkit-keyframes condemned_blink_effect {
0% {
visibility: hidden;
}
50% {
visibility: hidden;
}
100% {
visibility: visible;
}
}

@keyframes condemned_blink_effect {
0% {
visibility: hidden;
}
50% {
visibility: hidden;
}
100% {
visibility: visible;
}
}

.force_scrollbars {
overflow-y: auto;
border: 1px solid black;
height: 3em;
width: 100%;
line-height: 1em;
}

.force_scrollbars::-webkit-scrollbar {
-webkit-appearance: none;
}

.force_scrollbars::-webkit-scrollbar:vertical {
width: 11px;
}

.force_scrollbars::-webkit-scrollbar:horizontal {
height: 11px;
}

.force_scrollbars::-webkit-scrollbar-thumb {
border-radius: 8px;
border: 2px solid white; /* should match background, can't be transparent */
background-color: rgba(0, 0, 0, .5);
}
</style>



<style>
.ace_gutter-cell.ace_breakpoint{
border-radius: 20px 0px 0px 20px;
box-shadow: 0px 0px 1px 1px red inset;
}
.app_card {
top:    100px;
width:  200px;
height: 200px;
transition: width .5s ease-in-out, height .5s ease-in-out, top .5s ease-in-out;
}
.app_card:hover{
/*...*/
transition: width .5s ease-in-out, height .5s ease-in-out, top .5s ease-in-out;
top:    0px;
width:  330px;
height: 330px;
}
.right_project_pane_collapsed {
height: 15%;
transition: all .5s ease-out;
}
.right_project_pane_expanded {
height: 85%;
transition: all .5s ease-out;
}


.right_properties_pane_collapsed {
height: 85%;
transition: all .5s ease-out;
}
.right_properties_pane_expanded {
height: 15%;
transition: all .5s ease-out;
}
.selected_pane_title {
background-color:#000099;
color: white;
transition: all .2s ease-out;
}
.unselected_pane_title {
background-color:darkgray;
color: white;
transition: all .1s ease-out;
}
.selected_pane_title_slower {
background-color:#000099;
color: white;
transition: all .7s ease-out;
}
.unselected_pane_title_slower {
background-color:darkgray;
color: white;
transition: all .3s ease-out;
}
div.ace_editor.ace_autocomplete {
width: 40%
}
</style>


<style>




<style>
.reload { font-family: Lucida Sans Unicode }
</style>


<script>
</script>
<script src="https://cdn.socket.io/4.5.3/socket.io.min.js" integrity="sha384-WPFUvHkB1aHA5TDSZi6xtDgkF0wXJcIIxXhC6h8OT8EH3fC5PWro5pWJ1THjcfEi" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.11/vue.min.js"></script>


<script>
function registerComponent(vueComponentObject) {
if (vueComponentObject) {
let args = vueComponentObject.args
if (vueComponentObject.properties) {
args = vueComponentObject.properties
}
let componentName = args.name
//debugger
console.log(args.name)
}

if (vueComponentObject) {
let argsPrefix="args"
let args = vueComponentObject.args
if (vueComponentObject.properties) {
args = vueComponentObject.properties
argsPrefix = "properties"
}
if (args && args.name) {
let cccname = args.name
console.log(args.name );
let thisComponent22 = vueComponentObject
let listOfProperties = Object.keys(thisComponent22[  argsPrefix  ])

for (let oneProperty of component_cache[args.base_component_id].properties) {
let propNamee = oneProperty.id
let propType = oneProperty.type
if (propNamee) {
thisComponent22.$watch(argsPrefix + '.' + propNamee, function(newValue, oldValue) {
//debugger
if (propType != "Action") {
console.log(cccname + '.' + propNamee + ' = ' + oldValue + ' to ' + newValue );
}
//console.log(cccname + '.' + propType );
let designTimeOnlyEvents = false
// get this from the component defn
//debugger

if (oneProperty.design_time_only_events) {
designTimeOnlyEvents = true
}
thisComponent22.meta.getEditor().processControlEvent(
{
type:                       "subcomponent_event",
form_name:                   thisComponent22.meta.getEditor().active_form,
control_name:                thisComponent22[  argsPrefix  ].name,
sub_type:                   "on_property_changed",
code:                        thisComponent22[  argsPrefix  ].on_property_changed,
design_time_only_events:     designTimeOnlyEvents,

args:               {
form:           thisComponent22.meta.getEditor().active_form,
component:      thisComponent22[  argsPrefix  ].name,
property:       propNamee,
value:          newValue,
old_value:      oldValue,
new_value:      newValue
}
})
});
}
}
}

}

if (isValidObject(vueComponentObject)) {


var usePropVar = vueComponentObject.args
if (!isValidObject(usePropVar)) {
usePropVar = vueComponentObject.properties
}
if (!isValidObject(usePropVar)) {
usePropVar = vueComponentObject.props
}



if (isValidObject(usePropVar)) {
if (isValidObject(usePropVar.name)) {
if (vueComponentObject.design_mode) {
globalControlDesignMode[usePropVar.name] =  vueComponentObject
} else {
globalControl[usePropVar.name] =  vueComponentObject
}
}

if (isValidObject(usePropVar.load) && isValidObject(vueComponentObject.meta) ) {

setTimeout(function(){
vueComponentObject.$emit('send', {
type:               "subcomponent_event",
form_name:           vueComponentObject.meta.form,
control_name:        vueComponentObject.meta.name,
code:                usePropVar.load
})
},350)

}

}

}

}

function unregisterComponent(componentName) {
globalControlDesignMode[componentName] = null
globalControl[componentName] = null
}




function base64ToUint8Array (string) {
var raw = atob(string);
var rawLength = raw.length;
var array = new Uint8Array(new ArrayBuffer(rawLength));
for (var i = 0; i < rawLength; i += 1) {
array[i] = raw.charCodeAt(i);
}
return array;
}
if (window.SQL) {
localSqliteDb = new window.SQL.Database()
}
function localSql(sql, params) {
if (!window.SQL) {
console.log("Local SQLite only works for static Creator apps")
} else {
resOut = []
try {
var stmt = localSqliteDb.prepare(sql);
var res = stmt.bind(params)
var moreRows = stmt.step()
while (moreRows) {
var newRow = stmt.getAsObject()
resOut.push(newRow)
moreRows = stmt.step()
}
stmt.free();
} catch (err) {
console.log(err)
}
return resOut
}
}
String.prototype.replaceAll = function(search, replacement) {
var target = this;
return target.replace(new RegExp(search, 'g'), replacement);
};

var useProtocol = location.protocol
var useHostname = null
var usePort = null

async function initFn() {
setTimeout(async function(){






Vue.component('card_component', {
props: ["item","visible","element_id", "full_screen", "card_selected", "is_static"],
methods: {
click_card: async function(id) {
autoScroll = false;
await select_card(id)
}
,
updateComments: async function() {
let mm                           = this
let newrestUrl = location.protocol + "//" + getNetworkHostName() + ":" +
location.port + "/get_comments_for_component" + "/" +
"?"

callAjaxPost(newrestUrl
,
{
base_component_id: base_component_id
,
base_component_id_version: null
}
,
function(response) {
//debugger
let resp = JSON.parse(response)
mm.new_comment = ""
mm.new_rating = 0
if (resp.status == "ok")
mm.comments = resp.comments_and_ratings
})


}
,
submitComment: async function() {
let mm                           = this

//debugger
mm.submit_error_message = ""
if (mm.new_comment.length < 5) {
mm.submit_error_message = "You must enter a comment to rate this"
return
}

if (mm.new_rating == 0 ) {
mm.submit_error_message = "You must enter a rating"
return
}


let newrestUrl = location.protocol + "//" + getNetworkHostName() + ":" +
location.port + "/submit_comment" + "/" +
"?"

callAjaxPost(newrestUrl
,
{
base_component_id: base_component_id
,
base_component_id_version: null
,
comment: mm.new_comment
,
rating: mm.new_rating
}
,
function(response) {
//debugger
let resp = JSON.parse(response)
mm.new_comment = ""
mm.new_rating = 0
if (resp.status == "ok")
{
mm.comments = resp.comments_and_ratings
mm.submit_info_message = "Comment submitted"
}
})

}
,
openInfo: async function(useTab) {
//debugger
let mm = this
if (mm.tab == useTab) {
mm.tab = ""
mm.show_page_info=false;
} else {
mm.tab = useTab
mm.show_page_info = true
await mm.updateComments()
}
}
,
logInWithMetamask: async function() {
let mm = this
//debugger
if (window.ethereum) {
await useWeb3()
setTimeout(async function() {
let accs = await web3.eth.getAccounts()
let accNo = accs[0]
let openfileurl = "http" + (($HOSTPORT == 443)?"s":"") + "://" + $HOST + "/login_with_metamask?" +
new URLSearchParams({
metamask_account_id: accNo
})
fetch(openfileurl, {
method: 'get',
credentials: "include"
})
.then((response) => response.json())
.then(async function(responseJson)
{
let seed = responseJson.seed
let signMessage =   signMessageTemplate + seed
let signedTx = await mm.signTransactionV2(signMessage)

let checkSeedurl = "http" + (($HOSTPORT == 443)?"s":"") + "://" + $HOST + "/check_metamask_seed?" +
new URLSearchParams({
metamask_account_id: accNo
,
signedTx: signedTx
,
sign_message: signMessage
,
random_seed: seed
})

fetch(checkSeedurl, {
method: 'get',
credentials: "include"
})
.then((response2) => response2.json())
.then(async function(responseJson2)
{
debugger
if (responseJson2.error) {
mm.login_error_message =  responseJson2.error
} else {
mm.accountNumber = accs[0]
}

})
.catch(err => {
//error block
})
x++
mm.accountNumber = accs[0]

})
.catch(err => {
//error block
})

},100)
}
}
,
signTransactionV2: async function(test_transaction_text) {
let currentETHACC = (await web3.eth.getAccounts())[0]
let signedTx = //await web3.eth.sign(test_transaction_text, (await web3.eth.getAccounts())[0] );
await ethereum.request({
method: 'personal_sign',
params: [test_transaction_text   //message
,
currentETHACC
// account
//,
//test_transaction_text   //password?
],
});
return signedTx
}
,
signTransaction: async function() {
debugger
let test_transaction_text_el = document.getElementById("test_transaction_text")
let test_transaction_text = test_transaction_text_el.value
let currentETHACC = (await web3.eth.getAccounts())[0]
this.debug_sign_tx_out = //await web3.eth.sign(test_transaction_text, (await web3.eth.getAccounts())[0] );
await ethereum.request({
method: 'personal_sign',
params: [test_transaction_text   //message
,
currentETHACC
// account
//,
//test_transaction_text   //password?
],
});
}

},
data: function () {
return {
show_page_info: false
,
accountNumber: null
,
comments:
[
]
,
rating: 0
,
new_rating: 0
,
numRatings: 0
,
new_comment: ""
,
submit_error_message: ""
,
login_error_message: ""
,
submit_info_message: ""
,
tab: ""
,
debug_sign_tx_out: ""
}
}
,

template: "<span   v-bind:id='element_id'"+
"                  v-bind:style=\"'padding:0px;position: relative; margin: auto;height:100%;width:100%;border:0px; overflow-y:none;'\" "+
"                  v-on:click='click_card(item.id)'"+
"                  v-bind:class='card_selected?(is_static?\"container\":\" container\"):\" container\"' >"+
`
<div style='background-color:navy;height:5vh;width: 100vw;color:white;'
>



<!-- ------------------------------------------------

The top menu items for the info pane

------------------------------------------------ -->
<span
v-on:click=' openInfo("login")'
v-on:touchstart=' openInfo("login")'
style='height:100%;margin-left:20px;vertical-align:middle;'
>{{ accountNumber?("" + accountNumber).substring(0,5) + "...":"Login" }}</span>

<span
style='margin-left: 30px;'
v-on:click=' openInfo("comments")'
v-on:touchstart=' openInfo("comments")'
style='height:100%;margin-left:20px;vertical-align:middle;'
>Comments</span>

<span
style='margin-left: 30px;'
v-on:click=' openInfo("debug")'
v-on:touchstart=' openInfo("debug")'
style='height:100%;margin-left:20px;vertical-align:middle;'
>Debug</span>


<span
style='height:100%;margin-left:20px;vertical-align:middle;'
v-if='show_page_info'
v-on:click='show_page_info=false;tab=""'
v-on:touchstart='show_page_info=false;'
>Close</span>
</div>

<div    v-if='show_page_info'
style='width:100vw; height:100vh;color:white;background-color:navy;padding:20px;'>





<!-- ------------------------------------------------

LOGIN pane

------------------------------------------------ -->

<div v-if='tab=="login"'>

<div v-if='accountNumber'>Metamask Account Number: {{accountNumber}}</div>
<div v-else='accountNumber'>Logging in to Metamask will bring the Metamask popup and you will be
requested to authorise the login</div>

<div style='color:red' id='login_error'>{{login_error_message}}</div>

<button type=button
class='btn btn-primary'
style='margin-left: 10px;width:40vw;height:15vh;'

v-on:click='logInWithMetamask()'>

<img    src="/driver_icons/metamaskfox.svg"
style="height:100%;width:100%"
/>

</button>




</div>












<!-- ------------------------------------------------

Comments pane

------------------------------------------------ -->

<div v-if='tab=="comments"'>



<div style=";height:40vh">

Add comment<br>
<textarea  style='display: inline-block;'
id='new_comment'
v-model='new_comment'>
</textarea>
<br><br>

Rating (1-5, 5 is best):<br>
<input  id="new_rating"
v-model="new_rating"
type="range"
min="0"
max="5"
value="0">
</input>{{new_rating}}
<br>
<button type=button class='btn btn-primary' style='margin-left: 10px' v-on:click='submitComment()'>
Submit comment
</button>
<div style='color:red' id='submit_error'>{{submit_error_message}}</div>
<div style='color:green' id='submit_info'>{{submit_info_message}}</div>

</div>



<div style="overflow: scroll;height:40vh">
<b>Previous comments:</b>
<li v-for='comment in comments'
style='color:white;background-color:navy;'>
{{comment.comment}} , {{comment.rating}} , {{msToTime(comment.date_and_time)}}

</li>
</div>

</div>






<!-- ------------------------------------------------

DEBUG pane

------------------------------------------------ -->

<div v-if='tab=="debug"'>

<div v-if='!accountNumber'>You are not signed into Metamask. Please login first</div>

<textarea  id="test_transaction_text"
value="">
</textarea>

<button type=button
class='btn btn-primary'
v-bind:disabled='accountNumber?false:true'
style='margin-left: 10px;width:40vw;height:15vh;'

v-on:click='signTransaction()'>

Sign transaction

</button>
<div>
{{debug_sign_tx_out}}
</div>


<div    style="background-color: black; color: white; text-align: center;"
v-on:click='showProgressBar();setupPublicWebSocket()' >Edit this app</div>



</div>
</div>



` +
"<div " +
" v-bind:style=\"'; padding0px; font-family: Helvetica ;  width: 100vw ;visibility: ' + (visible?'':'hidden') + ';' \">"+






""+
"            <div    v-if='full_screen && (item.card.type == \"app\")'>"+

"                <div    v-bind:id='\"app_container_\"+ item.id'  >"+
"                    <div v-bind:id='\"app_\"+ item.id' >"+
"                    </div>"+
"                </div>"+
"            </div>"+
""+
"            <div style='height: 2em;'></div>"+
""+


"</div>"+
"            </div>"})











mainMoonApp = new Vue({
el: "#infinite-list"
,
data: function() {
return {
count: 1
,
is_gui_app:              true
,
console_output:         ""
,
selected_card: -1
,
cards: []
,
show_loader: false
,
is_static: false
,
local_app:                    false

}
}
,
mounted: function(){
this.local_app = localAppshareApp
}
});

listElm = document.querySelector('#wrapper');

// Add 20 items.
var loadMore = function() {
if (!isStaticHtmlPageApp) {
for (var i = 0; i < 1; i++) {
var nextIndex = nextItem - 1;
if (nextItem <= defaultCards.length) {
add_card( {id: nextItem++, card: defaultCards[nextIndex]});
refresh();
}
}
}
}

listElm.addEventListener('scroll', function(event)
{
var element = event.target;
if (element.scrollHeight - element.scrollTop <= (element.clientHeight + 10))
{
//console.log('scrolled');
loadMore();
//alert("load")
}
});
// Initially load some items.
for (var i=0; i < 20; i++) {
loadMore();
}





//alert(0)
if (isStaticHtmlPageApp) {
//alert(1)
var nid = nextItem++;
add_card({
id: nid,
card: {
id:                 nid,
name:               "***STATIC_NAME***",
base_component_id:  "***STATIC_BASE_COMPONENT_ID***",
code_id:            "***STATIC_BASE_COMPONENT_ID***",
display_name:       "***STATIC_NAME***",
type:               "app"
}});
mainMoonApp.show_loader = false
autoScroll = false
setTimeout(async function() {
await select_card(nid)
},20)
refresh();
}


if (isStaticHtmlPageApp) {
useHostname = /*static_hostname_start*/"***location.hostname***"/*static_hostname_end*/
usePort = /*static_port_start*/-1/*static_port_end*/
} else {
useHostname = location.hostname
usePort = location.port
}
setupWebSocket(useHostname,  usePort);
//alert(useHostname + ":" +  usePort)

var regex = /[?&]([^=#]+)=([^&#]*)/g,
url = window.location.href,
match;
while(match = regex.exec(url)) {
params[match[1]] = match[2];
}

if (params.goto) {
wait_and_select_app = params.goto.replaceAll("%20"," ").toLowerCase()
autoScroll = false;
mainMoonApp.show_loader = true
} else if (params.embed) {
wait_and_select_app = params.embed.replaceAll("%20"," ").toLowerCase()
autoScroll = false;
mainMoonApp.show_loader = true
} else if (!isStaticHtmlPageApp) {
setTimeout(async function() {
await select_card(1)
},200)
} else if (isStaticHtmlPageApp) {
mainMoonApp.is_static = true
}


if (editAppShareApp) {
showProgressBar()
var nid = nextItem++;
await loadV2("app_editor_3")
add_card({
id: nid,
card: {
id:                 nid,
name:               "fdsfsd",
base_component_id:  "app_editor_3",
code_id:            "app_editor_3",
display_name:       "fdsfds",
args:                {app_id: editAppShareApp},
type:               "app"
}});
mainMoonApp.show_loader = false
autoScroll = false
setTimeout(async function() {
await select_card(nid)
},2000)
refresh();
}




Dropzone.autoDiscover = false;


Dropzone.options.mydropzone = {
init: function() {
this.on("addedfile", function(file) {
//alert("Added file.");
});
}
};
var myDropzone = new Dropzone("body#mydropzone", {
url: "/file_upload"
,
createImageThumbnails: false
,
sending: function(file, xhr, formData){
showProgressBar()
file_upload_uuid = uuidv4()
//alert(fdfs)
formData.append('client_file_upload_id', file_upload_uuid);
}
});
myDropzone.on("complete", function(file) {
myDropzone.removeFile(file);
//var eds = saveHelper.getValueOfCodeString(data.value.code, "sqlite",")//sqlite")
});




},100)
};




</script>



<style>
@-webkit-keyframes passing-through{0%{opacity:0;-webkit-transform:translateY(40px);-moz-transform:translateY(40px);-ms-transform:translateY(40px);-o-transform:translateY(40px);transform:translateY(40px)}30%, 70%{opacity:1;-webkit-transform:translateY(0px);-moz-transform:translateY(0px);-ms-transform:translateY(0px);-o-transform:translateY(0px);transform:translateY(0px)}100%{opacity:0;-webkit-transform:translateY(-40px);-moz-transform:translateY(-40px);-ms-transform:translateY(-40px);-o-transform:translateY(-40px);transform:translateY(-40px)}}@-moz-keyframes passing-through{0%{opacity:0;-webkit-transform:translateY(40px);-moz-transform:translateY(40px);-ms-transform:translateY(40px);-o-transform:translateY(40px);transform:translateY(40px)}30%, 70%{opacity:1;-webkit-transform:translateY(0px);-moz-transform:translateY(0px);-ms-transform:translateY(0px);-o-transform:translateY(0px);transform:translateY(0px)}100%{opacity:0;-webkit-transform:translateY(-40px);-moz-transform:translateY(-40px);-ms-transform:translateY(-40px);-o-transform:translateY(-40px);transform:translateY(-40px)}}@keyframes passing-through{0%{opacity:0;-webkit-transform:translateY(40px);-moz-transform:translateY(40px);-ms-transform:translateY(40px);-o-transform:translateY(40px);transform:translateY(40px)}30%, 70%{opacity:1;-webkit-transform:translateY(0px);-moz-transform:translateY(0px);-ms-transform:translateY(0px);-o-transform:translateY(0px);transform:translateY(0px)}100%{opacity:0;-webkit-transform:translateY(-40px);-moz-transform:translateY(-40px);-ms-transform:translateY(-40px);-o-transform:translateY(-40px);transform:translateY(-40px)}}@-webkit-keyframes slide-in{0%{opacity:0;-webkit-transform:translateY(40px);-moz-transform:translateY(40px);-ms-transform:translateY(40px);-o-transform:translateY(40px);transform:translateY(40px)}30%{opacity:1;-webkit-transform:translateY(0px);-moz-transform:translateY(0px);-ms-transform:translateY(0px);-o-transform:translateY(0px);transform:translateY(0px)}}@-moz-keyframes slide-in{0%{opacity:0;-webkit-transform:translateY(40px);-moz-transform:translateY(40px);-ms-transform:translateY(40px);-o-transform:translateY(40px);transform:translateY(40px)}30%{opacity:1;-webkit-transform:translateY(0px);-moz-transform:translateY(0px);-ms-transform:translateY(0px);-o-transform:translateY(0px);transform:translateY(0px)}}@keyframes slide-in{0%{opacity:0;-webkit-transform:translateY(40px);-moz-transform:translateY(40px);-ms-transform:translateY(40px);-o-transform:translateY(40px);transform:translateY(40px)}30%{opacity:1;-webkit-transform:translateY(0px);-moz-transform:translateY(0px);-ms-transform:translateY(0px);-o-transform:translateY(0px);transform:translateY(0px)}}@-webkit-keyframes pulse{0%{-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}10%{-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}20%{-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}}@-moz-keyframes pulse{0%{-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}10%{-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}20%{-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}}@keyframes pulse{0%{-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}10%{-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}20%{-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}}.dropzone,.dropzone *{box-sizing:border-box}.dropzone{min-height:150px;border:2px solid rgba(0,0,0,0.3);background:white;padding:20px 20px}.dropzone.dz-clickable{cursor:pointer}.dropzone.dz-clickable *{cursor:default}.dropzone.dz-clickable .dz-message,.dropzone.dz-clickable .dz-message *{cursor:pointer}.dropzone.dz-started .dz-message{display:none}.dropzone.dz-drag-hover{border-style:solid}.dropzone.dz-drag-hover .dz-message{opacity:0.5}.dropzone .dz-message{text-align:center;margin:2em 0}.dropzone .dz-preview{position:relative;display:inline-block;vertical-align:top;margin:16px;min-height:100px}.dropzone .dz-preview:hover{z-index:1000}.dropzone .dz-preview:hover .dz-details{opacity:1}.dropzone .dz-preview.dz-file-preview .dz-image{border-radius:20px;background:#999;background:linear-gradient(to bottom, #eee, #ddd)}.dropzone .dz-preview.dz-file-preview .dz-details{opacity:1}.dropzone .dz-preview.dz-image-preview{background:white}.dropzone .dz-preview.dz-image-preview .dz-details{-webkit-transition:opacity 0.2s linear;-moz-transition:opacity 0.2s linear;-ms-transition:opacity 0.2s linear;-o-transition:opacity 0.2s linear;transition:opacity 0.2s linear}.dropzone .dz-preview .dz-remove{font-size:14px;text-align:center;display:block;cursor:pointer;border:none}.dropzone .dz-preview .dz-remove:hover{text-decoration:underline}.dropzone .dz-preview:hover .dz-details{opacity:1}.dropzone .dz-preview .dz-details{z-index:20;position:absolute;top:0;left:0;opacity:0;font-size:13px;min-width:100%;max-width:100%;padding:2em 1em;text-align:center;color:rgba(0,0,0,0.9);line-height:150%}.dropzone .dz-preview .dz-details .dz-size{margin-bottom:1em;font-size:16px}.dropzone .dz-preview .dz-details .dz-filename{white-space:nowrap}.dropzone .dz-preview .dz-details .dz-filename:hover span{border:1px solid rgba(200,200,200,0.8);background-color:rgba(255,255,255,0.8)}.dropzone .dz-preview .dz-details .dz-filename:not(:hover){overflow:hidden;text-overflow:ellipsis}.dropzone .dz-preview .dz-details .dz-filename:not(:hover) span{border:1px solid transparent}.dropzone .dz-preview .dz-details .dz-filename span,.dropzone .dz-preview .dz-details .dz-size span{background-color:rgba(255,255,255,0.4);padding:0 0.4em;border-radius:3px}.dropzone .dz-preview:hover .dz-image img{-webkit-transform:scale(1.05, 1.05);-moz-transform:scale(1.05, 1.05);-ms-transform:scale(1.05, 1.05);-o-transform:scale(1.05, 1.05);transform:scale(1.05, 1.05);-webkit-filter:blur(8px);filter:blur(8px)}.dropzone .dz-preview .dz-image{border-radius:20px;overflow:hidden;width:120px;height:120px;position:relative;display:block;z-index:10}.dropzone .dz-preview .dz-image img{display:block}.dropzone .dz-preview.dz-success .dz-success-mark{-webkit-animation:passing-through 3s cubic-bezier(0.77, 0, 0.175, 1);-moz-animation:passing-through 3s cubic-bezier(0.77, 0, 0.175, 1);-ms-animation:passing-through 3s cubic-bezier(0.77, 0, 0.175, 1);-o-animation:passing-through 3s cubic-bezier(0.77, 0, 0.175, 1);animation:passing-through 3s cubic-bezier(0.77, 0, 0.175, 1)}.dropzone .dz-preview.dz-error .dz-error-mark{opacity:1;-webkit-animation:slide-in 3s cubic-bezier(0.77, 0, 0.175, 1);-moz-animation:slide-in 3s cubic-bezier(0.77, 0, 0.175, 1);-ms-animation:slide-in 3s cubic-bezier(0.77, 0, 0.175, 1);-o-animation:slide-in 3s cubic-bezier(0.77, 0, 0.175, 1);animation:slide-in 3s cubic-bezier(0.77, 0, 0.175, 1)}.dropzone .dz-preview .dz-success-mark,.dropzone .dz-preview .dz-error-mark{pointer-events:none;opacity:0;z-index:500;position:absolute;display:block;top:50%;left:50%;margin-left:-27px;margin-top:-27px}.dropzone .dz-preview .dz-success-mark svg,.dropzone .dz-preview .dz-error-mark svg{display:block;width:54px;height:54px}.dropzone .dz-preview.dz-processing .dz-progress{opacity:1;-webkit-transition:all 0.2s linear;-moz-transition:all 0.2s linear;-ms-transition:all 0.2s linear;-o-transition:all 0.2s linear;transition:all 0.2s linear}.dropzone .dz-preview.dz-complete .dz-progress{opacity:0;-webkit-transition:opacity 0.4s ease-in;-moz-transition:opacity 0.4s ease-in;-ms-transition:opacity 0.4s ease-in;-o-transition:opacity 0.4s ease-in;transition:opacity 0.4s ease-in}.dropzone .dz-preview:not(.dz-processing) .dz-progress{-webkit-animation:pulse 6s ease infinite;-moz-animation:pulse 6s ease infinite;-ms-animation:pulse 6s ease infinite;-o-animation:pulse 6s ease infinite;animation:pulse 6s ease infinite}.dropzone .dz-preview .dz-progress{opacity:1;z-index:1000;pointer-events:none;position:absolute;height:16px;left:50%;top:50%;margin-top:-8px;width:80px;margin-left:-40px;background:rgba(255,255,255,0.9);-webkit-transform:scale(1);border-radius:8px;overflow:hidden}.dropzone .dz-preview .dz-progress .dz-upload{background:#333;background:linear-gradient(to bottom, #666, #444);position:absolute;top:0;left:0;bottom:0;width:0;-webkit-transition:width 300ms ease-in-out;-moz-transition:width 300ms ease-in-out;-ms-transition:width 300ms ease-in-out;-o-transition:width 300ms ease-in-out;transition:width 300ms ease-in-out}.dropzone .dz-preview.dz-error .dz-error-message{display:block}.dropzone .dz-preview.dz-error:hover .dz-error-message{opacity:1;pointer-events:auto}.dropzone .dz-preview .dz-error-message{pointer-events:none;z-index:1000;position:absolute;display:block;display:none;opacity:0;-webkit-transition:opacity 0.3s ease;-moz-transition:opacity 0.3s ease;-ms-transition:opacity 0.3s ease;-o-transition:opacity 0.3s ease;transition:opacity 0.3s ease;border-radius:8px;font-size:13px;top:130px;left:-10px;width:140px;background:#be2626;background:linear-gradient(to bottom, #be2626, #a92222);padding:0.5em 1.2em;color:white}.dropzone .dz-preview .dz-error-message:after{content:'';position:absolute;top:-6px;left:64px;width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:6px solid #be2626}


#wrapper {
/* We need to limit the height and show a scrollbar */
width: 100%;
height: 100%;
overflow-y: scroll;

/* Optional, only to check that it works with margin/padding */
margin: 0px;
padding: 0px;
border: 0px solid black;
scroll-behavior2: smooth;
}
#infinite-list {
}
/* Optional eye candy below: */
li {
width: 95%;
background-color: white;
padding: 10px;
}

.loader {
margin: auto;
margin-top:25vh;
border: 26px solid #f3f3f3; /* Light grey */
border-top: 26px solid #3498db; /* Blue */
border-radius: 100%;
width: 14vw;
position:absolute;
left:43vw;
height: 14vw;
animation: spin2 2s linear infinite;
z-index: 21474836;
}

@keyframes spin2 {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}



body {
margin: 30px;



}



.link {
cursor:pointer;
color:blue;
text-decoration:underline;
}

.link:hover {
color:black;
}
.dotted_vb6 {
padding: 2.25em 1.6875em;
background-image: -webkit-repeating-radial-gradient(center center, gray, gray 1px, transparent 2px, transparent 100%);
background-image: -moz-repeating-radial-gradient(center center, gray, gray 1px, transparent 2px, transparent 100%);
background-image: -ms-repeating-radial-gradient(center center, gray, gray 1px, transparent 2px, transparent 100%);
background-image: repeating-radial-gradient(center center, gray, gray 1px, transparent 2px, transparent 100%);
-webkit-background-size: 15px 15px;
-moz-background-size: 15px 15px;
background-size: 15px 15px;
background-color: lightgray;
}


.dotted {
background-position: 0px 0px, 10px 10px;
background-size: 20px 20px;
background-image: linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee 100%),linear-gradient(45deg, #eee 25%, white 25%, white 75%, #eee 75%, #eee 100%);
cursor: crosshair;
}
</style>

<style>
.my-custom-selectr {
padding: 3px;
border-radius: 3px;
margin: 0px;
border-right: 2px solid gray;
border-bottom: 2px solid gray;
}
/*!
* Selectr 2.4.8
* http://mobius.ovh/docs/selectr
*
* Released under the MIT license
*/
.selectr-container li,.selectr-option,.selectr-tag{list-style:none}.selectr-container{position:relative}.selectr-hidden{position:absolute;overflow:hidden;clip:rect(0,0,0,0);width:1px;height:1px;margin:-1px;padding:0;border:0}.selectr-visible{position:absolute;left:0;top:0;width:100%;height:100%;opacity:0;z-index:11}.selectr-desktop.multiple .selectr-visible{display:none}.selectr-desktop.multiple.native-open .selectr-visible{top:100%;min-height:200px!important;height:auto;opacity:1;display:block}.selectr-container.multiple.selectr-mobile .selectr-selected{z-index:0}.selectr-selected{position:relative;z-index:1;box-sizing:border-box;width:100%;padding:7px 28px 7px 14px;cursor:pointer;border:1px solid #999;border-radius:3px;background-color:#fff}.selectr-selected::before{position:absolute;top:50%;right:10px;width:0;height:0;content:'';-o-transform:rotate(0) translate3d(0,-50%,0);-ms-transform:rotate(0) translate3d(0,-50%,0);-moz-transform:rotate(0) translate3d(0,-50%,0);-webkit-transform:rotate(0) translate3d(0,-50%,0);transform:rotate(0) translate3d(0,-50%,0);border-width:4px 4px 0;border-style:solid;border-color:#6c7a86 transparent transparent}.selectr-container.native-open .selectr-selected::before,.selectr-container.open .selectr-selected::before{border-width:0 4px 4px;border-style:solid;border-color:transparent transparent #6c7a86}.selectr-label{display:none;overflow:hidden;width:100%;white-space:nowrap;text-overflow:ellipsis}.selectr-placeholder{color:#6c7a86}.selectr-tags{margin:0;padding:0;white-space:normal}.has-selected .selectr-tags{margin:0 0 -2px}.selectr-tag{position:relative;float:left;padding:2px 25px 2px 8px;margin:0 2px 2px 0;cursor:default;color:#fff;border:none;border-radius:10px;background:#acb7bf}.selectr-container.multiple.has-selected .selectr-selected{padding:5px 28px 5px 5px}.selectr-options-container{position:absolute;z-index:10000;top:calc(100% - 1px);left:0;display:none;box-sizing:border-box;width:100%;border-width:0 1px 1px;border-style:solid;border-color:transparent #999 #999;border-radius:0 0 3px 3px;background-color:#fff}.selectr-container.open .selectr-options-container{display:block}.selectr-input-container{position:relative;display:none}.selectr-clear,.selectr-input-clear,.selectr-tag-remove{position:absolute;top:50%;right:22px;width:20px;height:20px;padding:0;cursor:pointer;-o-transform:translate3d(0,-50%,0);-ms-transform:translate3d(0,-50%,0);-moz-transform:translate3d(0,-50%,0);-webkit-transform:translate3d(0,-50%,0);transform:translate3d(0,-50%,0);border:none;background-color:transparent;z-index:11}.selectr-clear,.selectr-input-clear{display:none}.selectr-container.has-selected .selectr-clear,.selectr-input-container.active,.selectr-input-container.active .selectr-clear,.selectr-input-container.active .selectr-input-clear{display:block}.selectr-selected .selectr-tag-remove{right:2px}.selectr-clear::after,.selectr-clear::before,.selectr-input-clear::after,.selectr-input-clear::before,.selectr-tag-remove::after,.selectr-tag-remove::before{position:absolute;top:5px;left:9px;width:2px;height:10px;content:' ';background-color:#6c7a86}.selectr-tag-remove::after,.selectr-tag-remove::before{top:4px;width:3px;height:12px;background-color:#fff}.selectr-clear:before,.selectr-input-clear::before,.selectr-tag-remove::before{-o-transform:rotate(45deg);-ms-transform:rotate(45deg);-moz-transform:rotate(45deg);-webkit-transform:rotate(45deg);transform:rotate(45deg)}.selectr-clear:after,.selectr-input-clear::after,.selectr-tag-remove::after{-o-transform:rotate(-45deg);-ms-transform:rotate(-45deg);-moz-transform:rotate(-45deg);-webkit-transform:rotate(-45deg);transform:rotate(-45deg)}.selectr-input{top:5px;left:5px;box-sizing:border-box;width:calc(100% - 30px);margin:10px 15px;padding:7px 30px 7px 9px;border:1px solid #999;border-radius:3px}.selectr-notice{display:none;box-sizing:border-box;width:100%;padding:8px 16px;border-top:1px solid #999;border-radius:0 0 3px 3px;background-color:#fff}.input-tag,.taggable .selectr-label{width:auto}.selectr-container.notice .selectr-notice{display:block}.selectr-container.notice .selectr-selected{border-radius:3px 3px 0 0}.selectr-options{position:relative;top:calc(100% + 2px);display:none;overflow-x:auto;overflow-y:scroll;max-height:200px;margin:0;padding:0}.selectr-container.notice .selectr-options-container,.selectr-container.open .selectr-input-container,.selectr-container.open .selectr-options{display:block}.selectr-option{position:relative;display:block;padding:5px 20px;cursor:pointer;font-weight:400}.has-selected .selectr-placeholder,.selectr-empty,.selectr-option.excluded{display:none}.selectr-options.optgroups>.selectr-option{padding-left:25px}.selectr-optgroup{font-weight:700;padding:0}.selectr-optgroup--label{font-weight:700;margin-top:10px;padding:5px 15px}.selectr-match{text-decoration:underline}.selectr-option.selected{background-color:#ddd}.selectr-option.active{color:#fff;background-color:#5897fb}.selectr-option.disabled{opacity:.4}.selectr-container.open .selectr-selected{border-color:#999 #999 transparent;border-radius:3px 3px 0 0}.selectr-container.open .selectr-selected::after{-o-transform:rotate(180deg) translate3d(0,50%,0);-ms-transform:rotate(180deg) translate3d(0,50%,0);-moz-transform:rotate(180deg) translate3d(0,50%,0);-webkit-transform:rotate(180deg) translate3d(0,50%,0);transform:rotate(180deg) translate3d(0,50%,0)}.selectr-disabled{opacity:.6}.has-selected .selectr-label{display:block}.taggable .selectr-selected{padding:4px 28px 4px 4px}.taggable .selectr-selected::after{display:table;content:" ";clear:both}.taggable .selectr-tags{float:left;display:block}.taggable .selectr-placeholder{display:none}.input-tag{float:left;min-width:90px}.selectr-tag-input{border:none;padding:3px 10px;width:100%;font-family:inherit;font-weight:inherit;font-size:inherit}.selectr-input-container.loading::after{position:absolute;top:50%;right:20px;width:20px;height:20px;content:'';-o-transform:translate3d(0,-50%,0);-ms-transform:translate3d(0,-50%,0);-moz-transform:translate3d(0,-50%,0);-webkit-transform:translate3d(0,-50%,0);transform:translate3d(0,-50%,0);-o-transform-origin:50% 0 0;-ms-transform-origin:50% 0 0;-moz-transform-origin:50% 0 0;-webkit-transform-origin:50% 0 0;transform-origin:50% 0 0;-moz-animation:.5s linear 0s normal forwards infinite running spin;-webkit-animation:.5s linear 0s normal forwards infinite running spin;animation:.5s linear 0s normal forwards infinite running spin;border-width:3px;border-style:solid;border-color:#aaa #ddd #ddd;border-radius:50%}@-webkit-keyframes spin{0%{-webkit-transform:rotate(0) translate3d(0,-50%,0);transform:rotate(0) translate3d(0,-50%,0)}100%{-webkit-transform:rotate(360deg) translate3d(0,-50%,0);transform:rotate(360deg) translate3d(0,-50%,0)}}@keyframes spin{0%{-webkit-transform:rotate(0) translate3d(0,-50%,0);transform:rotate(0) translate3d(0,-50%,0)}100%{-webkit-transform:rotate(360deg) translate3d(0,-50%,0);transform:rotate(360deg) translate3d(0,-50%,0)}}.selectr-container.open.inverted .selectr-selected{border-color:transparent #999 #999;border-radius:0 0 3px 3px}.selectr-container.inverted .selectr-options-container{border-width:1px 1px 0;border-color:#999 #999 transparent;border-radius:3px 3px 0 0;background-color:#fff;top:auto;bottom:calc(100% - 1px)}.selectr-container ::-webkit-input-placeholder{color:#6c7a86;opacity:1}.selectr-container ::-moz-placeholder{color:#6c7a86;opacity:1}.selectr-container :-ms-input-placeholder{color:#6c7a86;opacity:1}.selectr-container ::placeholder{color:#6c7a86;opacity:1}
</style>
<script>

</script>

</head>




<body onload='initFn()' id='mydropzone' style='border: 0px; margin: 0px;padding: 0px;height: 100%;'>



<div    id='popup'
style='display: none;position: absolute; margin:0px; padding: 0%;  border: 0px;  width: 100%;  height:100%;  left: 0%; top: 0%; z-index: -10000;'
onclick='document.getElementById("popup").style.zIndex = "-1";document.getElementById("popup").style.display = "none";document.getElementById("popup_content").innerHTML =""'>

<div    id='popup_content'
style='position: absolute; margin:0px; padding: 5%;  border: 0px;  width: 50%;  height:80%;  left: 25%; top: 0%; ; background-color: white;color: black;overflow-y: scroll; z-index: 400000;'
onclick="dontBubble(event, this);">
</div>
</div>




<div    id='wrapper'
onscroll='onscrolled()'
onmousedown='onemousedown()'
onmouseup='onemouseup()'
onwheel='onemousedown()'     >



<div    id='infinite-list'
style='overflow-y: none;' >



<div    v-if="show_loader"
v-bind:style='show_loader?"":"display:none;"'
class="loader">
</div>


<div v-if='!is_gui_app' style="padding:10px;"><pre id="console_id" style="color: white;">{{console_output}}</pre></div>


<template   v-if='is_gui_app'
v-for="item  in  cards" >
<div v-if="item.id == selected_card"
style="position: fixed; left:0px; top:0px; height:100%; width: 100vw ;z-index: 200000;background-color: white;overflow-y:hidden;overflow-x: hidden;">
<card_component :item='item' :visible='true' :element_id='"current_card"'
:full_screen='true'
:is_static='is_static' :card_selected='true'>
</card_component>
</div>

</template>







<template   v-for="item  in  cards"
v-if='is_gui_app'>

<div v-bind:style='"width: 100%; display:" + (is_static?"none;":"") + ";"'>
<card_component :item='item' :visible='true' :element_id='"card_" + item.id'
:full_screen='false'
:is_static='is_static' :card_selected='(item.id == selected_card)'>
</card_component>
</div>
</template>

<div style="height: 200px;">
</div>





</div>
</div>


<script>

var globalEventBus = new Vue();
//lll
var newAppArgs = []
async function prepareApp(  id,  bbase_component_id,  args  ) {
//alert(id)
//alert(JSON.stringify(args,null,2))
base_component_id = bbase_component_id
//alert(base_component_id)

//console.log(" prepareApp base_component_id: " + base_component_id)
//alert(JSON.stringify(args,null,2))
var rootElement = "app_" + id
if ((mainMoonApp.cards[id - 1].card.base_component_id != base_component_id) ||
(!newAppArgs[id])) {
newAppArgs[id] = args
}
//alert(JSON.stringify(newAppArgs[id],null,2))

await loadV2(base_component_id)
if (mainMoonApp.cards[id - 1].card.base_component_id == base_component_id) {
loadAppIntoElement(base_component_id, rootElement)
}

}


function loadAppIntoElement(tagName, rootElement) {
if (!mainMoonApp.is_gui_app) {
return
}

if (!document.getElementById(rootElement)) {
var newRootId = rootElement.substring(4)
var newCardId = "app_container_" + newRootId
var newAppId = "app_" + newRootId
//alert("Creating: " + newAppId + " under " + newCardId)
document.getElementById(newCardId).innerHTML = ""

}

new Vue({
template: `<${tagName} app_id='${editAppShareApp}' v-bind:card_index='1'></${tagName}>`,
el: "#" + rootElement
})
}



function loadContent(  data_id,  data_name  ) {
//
// _______
// Browser  --Send me a preview of a document--  Server
// _______
//
//console.log("**1) browser_asks_server_for_document_preview")
sendToServerViaWebSocket({
message_type:   "browser_asks_server_for_document_preview",
data_id:         data_id,
data_name:       data_name
});
}



function openContent(  data_id  ) {
//
// _______
// Browser  --Send me a preview of a document--  Server
// _______
//
//console.log("**1) browser_asks_server_to_open_document_natively")
sendToServerViaWebSocket({
message_type:   "browser_asks_server_to_open_document_natively",
data_id:         data_id
});
}




function add_card(payload) {

var ccy = document.getElementById('wrapper').scrollTop
mainMoonApp.cards.push(payload);
setTimeout(function() {
document.getElementById('wrapper').scrollTop = ccy
},100)

}

function update_card(payload) {
//console.log("update_card: " + JSON.stringify(payload,null,2))
for (var i = 0; i < mainMoonApp.cards.length; i++) {
if (mainMoonApp.cards[i].id == payload.id) {
mainMoonApp.cards[i].card.hide_header           = payload.card.hide_header
mainMoonApp.cards[i].card.name                  = payload.card.name
mainMoonApp.cards[i].card.base_component_id     = payload.card.base_component_id
mainMoonApp.cards[i].card.code_id               = payload.card.code_id
mainMoonApp.cards[i].card.display_name          = payload.card.display_name
mainMoonApp.cards[i].card.type                  = payload.card.type
}
}
}


function refresh() {
mainMoonApp.count += 1;
}



function getPosition(el) {
var xPos = 0;
var yPos = 0;

while (el) {
if (el.tagName == "BODY") {
// deal with browser quirks with body/window/document and page scroll
var xScroll = el.scrollLeft || document.documentElement.scrollLeft;
var yScroll = el.scrollTop || document.documentElement.scrollTop;

xPos += (el.offsetLeft - xScroll + el.clientLeft);
yPos += (el.offsetTop - yScroll + el.clientTop);
} else {
// for all other non-BODY elements
xPos += (el.offsetLeft - el.scrollLeft + el.clientLeft);
yPos += (el.offsetTop - el.scrollTop + el.clientTop);
}

el = el.offsetParent;
}
return {
x: xPos,
y: yPos
};
}
async function select_card(id) {
if (mainMoonApp.selected_card == id) {
return;
}
if (mainMoonApp.selected_card != -1) {
if (id != -1) {
document.querySelector('#card_' + mainMoonApp.selected_card).classList.remove("expand");
}
document.querySelector('#card_' + mainMoonApp.selected_card).classList.add('contract');

//alert(document.querySelector('#card_' + id))
}

if (id != -1) {
var elmnt = document.querySelector('#card_' + id);
if (elmnt) {
//elmnt.scrollIntoView({  alignToTop: 'true',
//                        bahaviour: 'smooth'});
//document.getElementById("wrapper").scrollTop = getPosition(document.querySelector('#card_' + id)).y - 200
if (isStaticHtmlPageApp) {
mainMoonApp.selected_card = id;
setTimeout(async function() {
var thisApp = mainMoonApp.cards[id - 1]
//alert("id: " + JSON.stringify(thisApp,null,2))
//alert("thisApp: " + JSON.stringify(thisApp,null,2))
//alert("thisApp.id: " + JSON.stringify(thisApp.id,null,2))
//alert("thisApp.card.base_component_id: " + JSON.stringify(thisApp.card.base_component_id,null,2))
//console.log(JSON.stringify(mainMoonApp.cards[id - 1],null,2))
if (mainMoonApp.cards[id - 1].card.fn) {
setTimeout( mainMoonApp.cards[id - 1].card.fn, 3000)
//alert(1)
}
if (thisApp.card.base_component_id) {
await prepareApp(  thisApp.id,   thisApp.card.base_component_id,   thisApp.card.args  )
}
},200)

} else {
document.querySelector('#card_' + id).classList.remove('contract');
document.querySelector('#card_' + id).classList.add('expand');
setTimeout(function() {
mainMoonApp.selected_card = id;
setTimeout(async function() {
var thisApp = mainMoonApp.cards[id - 1]
//alert("id: " + JSON.stringify(thisApp,null,2))
//alert("thisApp: " + JSON.stringify(thisApp,null,2))
//alert("thisApp.id: " + JSON.stringify(thisApp.id,null,2))
//alert("thisApp.card.base_component_id: " + JSON.stringify(thisApp.card.base_component_id,null,2))
//console.log(JSON.stringify(mainMoonApp.cards[id - 1],null,2))
if (mainMoonApp.cards[id - 1].card.fn) {
setTimeout( mainMoonApp.cards[id - 1].card.fn, 3000)
//alert(1)
}
if (thisApp.card.base_component_id) {
await prepareApp(  thisApp.id,   thisApp.card.base_component_id,   thisApp.card.args  )
}
},200)
},1000)
}


}
}

}

var mainMoonApp = null



//ccc
var defaultCards = [
{
html:
`<div>
</div>
`
}

];


var cachedCode = new Object()
var finderToCachedCodeMapping = new Object()

populateCache()
function populateCache() {




//***ADD_STATIC_CODE
}






var socket=null;
function sendToServerViaWebSocket(msg) {
if (online) {
msg.cookie = getYazzCookie()
socket.send(JSON.stringify(msg));
}
//console.log("Sent over socket: " + JSON.stringify(msg,null,2));
}



var staticAppSocket
async function setupPublicWebSocket()
{
var hostEditorAddress = "https://yazz.com:443"
//hostEditorAddress = "http://192.168.0.63:3000"

//console.log('opening web socketio');
//staticAppSocket = io('http://yazz.com:80');

staticAppSocket = io(hostEditorAddress);

var code_fn = ""
//alert(JSON.stringify(component_cache[base_component_id],null,2)) --> {}
//alert(JSON.stringify(finderToCachedCodeMapping[base_component_id],null,2))
var codeiii = finderToCachedCodeMapping[base_component_id]

var hjhg = await eval(cachedCode[codeiii])
//alert(JSON.stringify(hjhg.value.code,null,2))
code_fn = hjhg.value.code






//console.log('opening web socketio');
staticAppSocket.on('socket_connected',function(data){
//console.log("Connected: " + JSON.stringify(data,null,2));
//alert("Connected 2")

staticAppSocket.send(JSON.stringify(
{
message_type:           "edit_static_app",
host_editor_address:     hostEditorAddress,
sql_data:                sqlitedata,
code_fn:                 code_fn,
base_component_id:       base_component_id,
msg:                    "Hi from client"
}));

});

staticAppSocket.on('edit_static_app_url', function(msg) {
//alert(JSON.stringify(msg,null,2))
window.location.href = msg.url;
//var receivedMessage = eval("(" + msg + ")");
//console.log(" 1- Server recieved message: " + JSON.stringify(receivedMessage));

// if we get the message "server_get_all_queries" from the web browser
//alert("Browser received from server socket: " + JSON.stringify(msg,null,2));
})

}

function setupWebSocket(host, port)
{

//console.log('opening web socketio');
socket = io();
//console.log('opening web socketio');
socket.on('socket_connected',function(data){
online = true
//console.log("Connected: " + JSON.stringify(data,null,2));

setTimeout(function(){
//
// _______
// Browser  --Send me your data--  Server
// _______
//


setInterval(function() {
sendToServerViaWebSocket({
message_type: "browser_asks_server_for_data"
});
}, 5000)
if (!isStaticHtmlPageApp) {
sendToServerViaWebSocket({
message_type: "browser_asks_server_for_apps"
});
}
},3000);
});

socket.on('set_file_upload_uuid',async function(data) {
file_upload_uuid = data.file_upload_uuid
})

socket.on('set_saveCodeToFile',async function(data) {
saveCodeToFile = data.saveCodeToFile
})

socket.on('set_saveCodeToFile_V2',async function(data) {
//debugger
saveCodeToFile = data.saveCodeToFile
var results = await callFunction(
{
driver_name:     "appEditorV2SaveCode",
method_name:     "saveCode"
},
{
base_component_id:      data.base_component_id,
code_id:                data.code_id,
code:                   data.code,
options:                {
sub_components:         Object.keys(dev_app_component_loaded),
save_html:              true,
save_code_to_file:      saveCodeToFile
}
})
})



socket.on('uploaded_app_as_file_from_server',async function(data) {

//console.log("Browser received from server socket: " + JSON.stringify(data,null,2));
if (data.client_file_upload_id == file_upload_uuid) {
//alert("File uploaded: " + JSON.stringify(data.base_component_id,null,2))
globalEventBus.$emit('new-appshare-app-uploaded', data.base_component_id);
}
});



socket.on('client_data_returned_from_server',function(data) {
//console.log("Browser received from server socket: " + JSON.stringify(data,null,2));
});

















// ----------------------------------------------------------------------------------------------
//
//                  Share the container environent variables with the front end
//
// ----------------------------------------------------------------------------------------------
socket.on('env_vars',async function(data) {
//console.log("Browser received from server socket: " + JSON.stringify(data,null,2));

var allEnvVarNames = Object.keys(data.value)
for (var i=0; i< allEnvVarNames.length;i++) {
try
{
let envName = allEnvVarNames[i].replace(/[^a-zA-Z0-9]/g,'_')
//console.log(envName)
var valueEnvVar = data.value[envName]
var cmddd = '($' + envName + " =  String.raw`" +  String.raw`${valueEnvVar}` +"`)"

if (mainMoonApp.is_gui_app) {
console.log(cmddd)
}

eval(cmddd)

} catch (errr) {
console.log(errr)
}
}
pageInitialised = true

if (executeOnPageLoad) {
await executeOnPageLoad()
executeOnPageLoad = null
}
});









// ----------------------------------------------------------------------------------------------
//
//                  Share the container environent variables with the front end
//
// ----------------------------------------------------------------------------------------------
socket.on('network_ip_address_intranet',function(data) {
//console.log("Browser received from server socket: " + JSON.stringify(data,null,2));

networkIntranetIpAddress = data.value
});





// ----------------------------------------------------------------------------------------------
//
//
//
// ----------------------------------------------------------------------------------------------
socket.on('send_is_win',function(data) {
//console.log("Browser received from server socket: " + JSON.stringify(data,null,2));

isWin = data.value
});














socket.on('vf_update_card_app',function(data) {
//alert("Browser received apps from server socket: " + JSON.stringify(data,null,2));
update_card({
id: data.card_id,
card: {
id:                 data.card_id,
name:               data.result.display_name,
base_component_id:  data.result.base_component_id,
code_id:            data.result.id,
display_name:       data.result.display_name,
type:               "app",
hide_header:        (data.result.component_options && data.result.component_options.indexOf("HIDE_HEADER" != -1))?true:false
}});


var rootElement = "app_" + data.card_id

//alert("loadAppIntoElement( " + data.tag_name + "," + rootElement)
loadAppIntoElement( data.tag_name, rootElement)



refresh();
});



socket.on('vf_app_names',function(data) {
//alert("Browser received apps from server socket: " + JSON.stringify(data.results[0],null,2));
if (data) {
if (data.results) {
for (var i = 0 ; i < data.results.length ; i ++ ) {
var nid = nextItem++;
add_card({
id: nid,
card: {
id:                 nid,
name:               data.results[i].display_name,
base_component_id:  data.results[i].base_component_id,
code_id:            data.results[i].id,
display_name:       data.results[i].display_name,
type:               "app",
hide_header:        (data.results[i].component_options && data.results[i].component_options.indexOf("HIDE_HEADER" != -1))?true:false
}});
if (wait_and_select_app) {
if (data.results[i].display_name) {
//alert(wait_and_select_app + ", " + data.results[i].display_name)
if (data.results[i].display_name.toLowerCase() == wait_and_select_app) {
var cardId = nid
//alert(wait_and_select_app + " : " + data.results[i].base_component_id  )
mainMoonApp.show_loader = false
setTimeout(async function() {
await select_card(cardId)
},200)
}
}
}

}
refresh();
}
}

});





var dataIds = new Object()
//
// Server  --DATA ITEM--  Browser
//
socket.on('client_data_item_received_from_server',async function(data) {
//console.log("Update query item: " + JSON.stringify(data,null,2));
//alert(data.query.name)
if (!dataIds[data.data_item.name]) {
var nid = nextItem++;
add_card( { id: nid,
card: {
id:                 nid,
data_id:            data.data_item.id,
name:               data.data_item.name,
load_content:       data.data_item.name,
load_content_name:  data.data_item.name
}});
dataIds[data.data_item.name] = true
refresh();
if (autoScroll) {
//select_card(nid)
}
}
});








socket.on('server_returns_loadUiComponent_to_browser',async function(data) {

//alert("component returned: " + JSON.stringify(data,null,2))
var fn      = queuedResponses[data.seq_num]
var sdf     = eval("(" + data.record + ")")
var args    = eval("(" + data.args + ")")

//console.log("callig 2")
for (var i=0; i< sdf.length; i++) {
checkLibsV2(sdf[i],args)
//alert(JSON.stringify(Object.keys(sdf[i]),null,2))
//console.log("callig 3")

fn(sdf[i])
}
});




socket.on('ws_to_browser_callDriverMethod_results',async function(data) {
//console.log(`socket.on('ws_to_browser_callDriverMethod_results',function(data) {`)

if (data.value) {
if (data.value.is_code_result) {
if (data.value.component_options){
//alert("code: " + JSON.stringify(data.value.component_options,null,2));
}
//alert("code2: " + JSON.stringify(data.value.use_db,null,2));
//alert("data: " + JSON.stringify(data.value.code_id,null,2));
//alert("data: " + JSON.stringify(data.value.base_component_id,null,2));
var useDb = data.value.base_component_id
if (data.value.use_db) {
useDb = data.value.use_db
}


if (data.value.code_id) {

if (data.value.base_component_id && (!finderToCachedCodeMapping[data.value.base_component_id])) {
//alert(""  + data.value.base_component_id + " := " + data.value.code_id )
finderToCachedCodeMapping[data.value.base_component_id] = data.value.code_id
cachedCode[data.value.code_id] = data
}

await checkLibs(data)
}


} else {

var callbackFn = queuedResponses[data.seq_num]
callbackFn(data.value)
queuedResponses[data.seq_num] = null
}
}
});

}

function getNetworkHostName() {
let networkHostName = location.hostname
if (networkHostName == "127.0.0.1") {
networkHostName = networkIntranetIpAddress
}
if (networkHostName == "0.0.0.0") {
networkHostName = networkIntranetIpAddress
}
return networkHostName
}


async function scriptTag(src, callback) {

var s = document.createElement('script');
s.type = 'text/' + (src.type || 'javascript');
s.src = src.src || src;
s.async = false;

s.onreadystatechange = s.onload = async function () {

var state = s.readyState;

if (!callback.done && (!state || /loaded|complete/.test(state))) {
callback.done = true;
await callback();
}
};

// use body if available. more safe in IE
(document.body || head).appendChild(s);
}

async function checkLibs(data){


if (data.value.libs && data.value.libs.length > 0 ) {
//alert(JSON.stringify(data.value.libs,null,2))
for (var tt = 0; tt < data.value.libs.length ; tt++) {
if (!libLoaded[ data.value.libs[tt].dependency_name ]) {
libLoaded[ data.value.libs[tt].dependency_name ] = true
if ( data.value.libs[tt].dependency_name == "advanced_bundle" ) {

var oldConsole = console.log
console.log = function(){}
if (advancedAlreadyLoaded) {
} else {
advancedAlreadyLoaded = true
/*await scriptTag(
`/js_libs/advanced_js_bundle.js`
,
async function() {
console.log = oldConsole
await callCodeV2(data.value,  callDriverMethodArgs[data.seq_num],  data.seq_num)
})*/
}
}

//
// if the lib is already loaded then just call the code
//
} else {
await callCodeV2(data.value,  callDriverMethodArgs[data.seq_num],  data.seq_num)
}
}
} else {
await callCodeV2(data.value,  callDriverMethodArgs[data.seq_num],  data.seq_num)
}

}


function logVarBefore(codeBlockName, line, varName, varValue) {
if (executionCode[codeBlockName]) {

if (executionTimeline[currentTimelineLogPoint]) {
if (!executionTimeline[currentTimelineLogPoint].vars[varName]) {
executionTimeline[currentTimelineLogPoint].vars[varName] = {}
}
executionTimeline[currentTimelineLogPoint].vars[varName].before = varValue
}

}


}

function logVarAfter(codeBlockName, line, varName, varValue) {
if (executionCode[codeBlockName]) {

if (executionTimeline[currentTimelineLogPoint]) {
if (!executionTimeline[currentTimelineLogPoint].vars[varName]) {
executionTimeline[currentTimelineLogPoint].vars[varName] = {}
}
executionTimeline[currentTimelineLogPoint].vars[varName].after = varValue
}
}
}


function fillInMissingWatchTimelineValues(vName, executionStepNo) {
if (!globalWatchList[vName]) {
globalWatchList[vName] = {
viewer: ""
}
}
if (!globalWatchList[vName][executionStepNo]) {
globalWatchList[vName][executionStepNo] = {}
}

if (executionStepNo == executionTimeline.length) {
return

} else if (!globalWatchList[vName][executionStepNo].isSet) {
if (executionStepNo == 0) {
globalWatchList[vName][executionStepNo].value = null
} else {
globalWatchList[vName][executionStepNo].value = globalWatchList[vName][executionStepNo - 1].value
}
}
fillInMissingWatchTimelineValues(vName, executionStepNo + 1)
}

function addWatchPoint(vName,value) {
globalWatchList[vName][currentTimelineLogPoint] = {}
globalWatchList[vName][currentTimelineLogPoint].value = eval("(" + JSON.stringify(value) + ")")
globalWatchList[vName][currentTimelineLogPoint].isSet = true
if (value){
globalWatchList[vName].type = typeof(value)
globalWatchList[vName].viewer = "text"

if (typeof(value) == "object") {
if (value[0]) {
if (typeof(value[0]) == "number") {
globalWatchList[vName].type = "ListOfNumbers"
globalWatchList[vName].viewer = "graph"
}
}
}
}
}




function logExecutionPoint(codeBlockName, line, node) {
//console.log("logExecutionPoint(" + codeBlockName + "," + line)

if (executionCode[codeBlockName]) {
currentTimelineLogPoint = maxTimelineLogPoint ++

var recor = { code_block_name:    codeBlockName,
line:               line,
time:               currentTimelineLogPoint,
node:               node,
vars:               {}
}
executionTimeline.push(recor)

executionTimelineMapTimeToLine[recor.time] = recor
}
}



async function checkLibsV2(componentRecord,args){
//console.log("CheckLibsV2: ")


if (componentRecord.libs && componentRecord.libs.length > 0 ) {
//alert(JSON.stringify(componentRecord.libs,null,2))
for (var tt = 0; tt < componentRecord.libs.length ; tt++) {
if (!libLoaded[ componentRecord.libs[tt].dependency_name ]) {
libLoaded[ componentRecord.libs[tt].dependency_name ] = true
if ( componentRecord.libs[tt].dependency_name == "advanced_bundle" ) {

var oldConsole = console.log
console.log = function(){}
if (advancedAlreadyLoaded) {
} else {
advancedAlreadyLoaded = true
/*await scriptTag(
`/js_libs/advanced_js_bundle.js`
,
async function() {
console.log = oldConsole
await callCodeV2(componentRecord,args)
})*/
}
}

//
// if the lib is already loaded then just call the code
//
} else {
await callCodeV2(componentRecord,args)
}
}
} else {
await callCodeV2(componentRecord,args)
}

}



function getDebugCode(blockName,  trcode2 , args) {
if (!uiDebuggerOn) {
return trcode2
}

var _b = esprima.parse(trcode2,{tolerant: true , loc:true, range: true, attachComment: false})
var line = -1
var varsToAdd = {}
var skipFirstAndLastLine = false
if (isValidObject(args)) {
if (args.skipFirstAndLastLine){
skipFirstAndLastLine=true
}
}

estraverse.traverse(_b, {
enter: function (node, parent) {
//
// add the line numbers
//
if (
(node.type == "ExpressionStatement")
||
(node.type == "VariableDeclaration")
||
(node.type == "AssignmentExpression")
) {
if (parent) {
if ((node.loc.start.line - (skipFirstAndLastLine?1:0)) > line) {
line = node.loc.start.line - (skipFirstAndLastLine?1:0)

if (line > 0) {
var newLine = "logExecutionPoint('" + blockName + "', " + line +",'" + JSON.stringify(node.type) + "');"
var newNode = esprima.parse(newLine)

for (var rr = 0; rr < parent.body.length; rr++){
if (parent.body[rr] == node) {
parent.body.splice(rr, 0, newNode);
break
}
}





//
// vars
//
if (node.type == "VariableDeclaration") {
if (node.declarations[0].init) {
//alert(`var ${node.declarations[0].id.name} = ${node.declarations[0].init.value}`)
var varNameToUse = node.declarations[0].id.name

if (node.kind == "var") {
var newLine = "logVarBefore('" + blockName + "', " + node.loc.start.line +",'" +
varNameToUse + "', " + varNameToUse  + ");"
var newNode = esprima.parse(newLine)
}
varsToAdd[varNameToUse] = {}

var newLineAfter = "logVarAfter('" + blockName + "', " + node.loc.start.line +",'" +
varNameToUse + "'," + varNameToUse  + ");"
var newNodeAfter = esprima.parse(newLineAfter)

var logWatchVarsCode = `for (var _uu=0; _uu<Object.keys(globalWatchList).length; _uu++){try { var _vName = Object.keys(globalWatchList)[_uu];if (isValidObject(_vName)){ addWatchPoint(_vName, eval(_vName) ) }} catch(_err){}}`
var logWatchVarsNode = esprima.parse(logWatchVarsCode)

for (var rr=0; rr<parent.body.length; rr++){
if (parent.body[rr] == node) {
parent.body.splice(rr + 1, 0, logWatchVarsNode);
parent.body.splice(rr + 1, 0, newNodeAfter);
parent.body.splice(rr, 0, newNode);
break;
}
}
}
}



if ((node.type == "ExpressionStatement") && node.expression) {
if (node.expression.type == "CallExpression") {
var logWatchVarsCode = `for (var _uu=0; _uu<Object.keys(globalWatchList).length; _uu++){try { var _vName = Object.keys(globalWatchList)[_uu];if (isValidObject(_vName)){ addWatchPoint(_vName, eval(_vName) ) }} catch(_err){}}`
var logWatchVarsNode = esprima.parse(logWatchVarsCode)

for (var rr=0; rr<parent.body.length; rr++){
if (parent.body[rr] == node) {
if (logWatchVarsNode){
parent.body.splice(rr + 1, 0, logWatchVarsNode);
}
break;   }}}}




if ((node.type == "ExpressionStatement") && node.expression) {
if ((node.expression.type == "AssignmentExpression") &&
(node.expression.operator == "=")) {
var varName = node.expression.left.name
if (!isValidObject(varName)) {
if (node.expression.left.object.type == "ThisExpression") {
varName = "this." + node.expression.left.property.name
} else if (node.expression.left.type == "MemberExpression") {
varName = node.expression.left.object.name
if (node.expression.left.property.type == "Identifier") {
varName += "." + node.expression.left.property.name
}
}
}
varsToAdd[varName] = {}

var newLine = "logVarBefore('" + blockName + "', " + node.loc.start.line +",'" +
varName + "', " + varName  + ");"
var newNode = esprima.parse(newLine)

var newLineAfter = "logVarAfter('" + blockName + "', " + node.loc.start.line +",'" +
varName + "', " + varName  + ");"
var newNodeAfter = esprima.parse(newLineAfter)

var logWatchVarsCode = `for (var _uu=0; _uu<Object.keys(globalWatchList).length; _uu++){try { var _vName = Object.keys(globalWatchList)[_uu];if (isValidObject(_vName)){ addWatchPoint(_vName, eval(_vName) ) }} catch(_err){}}`
var logWatchVarsNode = esprima.parse(logWatchVarsCode)

for (var rr=0; rr<parent.body.length; rr++){
if (parent.body[rr] == node) {
if (logWatchVarsNode){
parent.body.splice(rr + 1, 0, logWatchVarsNode);
}
if (newNodeAfter){
parent.body.splice(rr + 1, 0, newNodeAfter);
}
parent.body.splice(rr, 0, newNode);
break;
}
}

}
}



}
}
}
}






},
leave: function (node, parent) {
},

keys: {
'AwaitExpression': ['argument']
}
});

for ( var fds = 0 ; fds < Object.keys(varsToAdd).length ; fds ++ ) {
var nnn = Object.keys(varsToAdd)[fds]
globalWatchList[nnn]={
viewer: ""
}
}


var debugCode = escodegen.generate(_b, {comment: false})





executionCode[blockName] = {}
executionCode[blockName].debug_code = debugCode
if (skipFirstAndLastLine){
var indexOfFirst = trcode2.indexOf("\n")
if (indexOfFirst != -1) {
trcode2 = trcode2.substring(indexOfFirst + 1)
}

var indexOfLast = trcode2.lastIndexOf("\n")
if (indexOfLast != -1) {
trcode2 = trcode2.substring(0,indexOfLast)
}
}

trcode2 = trcode2.toString().replaceAll("await rxsql[(][^,]*,[^,]*,","sql(")
trcode2 = trcode2.toString().replaceAll("await rxsql1[(][^,]*,[^,]*,","sql1(" )
trcode2 = trcode2.toString().replaceAll("await rxsqlFirstCol[(][^,]*,[^,]*,","sqlFirstCol(" )
trcode2 = trcode2.toString().replaceAll("await rxsqlFirstCol1[(][^,]*,[^,]*,","sqlFirstCol1(" )

executionCode[blockName].code = trcode2
executionCode[blockName].start = startTimelineTop
startTimelineTop += trcode2.length

return debugCode

}




async function callCodeV2(componentRecord,args, seq_no) {

//console.log("Code to run !: ")
if (componentRecord.edit_file_path) {
saveCodeToFile = componentRecord.edit_file_path
}
var callbackFn = null
if (isValidObject(seq_no)) {
callbackFn = queuedResponses[seq_no]
}



try {
var useDb = componentRecord.base_component_id
if (componentRecord.use_db) {
useDb = componentRecord.use_db
}

if (!component_cache[componentRecord.base_component_id]) {
component_cache[componentRecord.base_component_id] = new Object()
}
if (isValidObject(componentRecord.properties)) {
component_cache[componentRecord.base_component_id].code = componentRecord.code
component_cache[componentRecord.base_component_id].properties = eval("(" + componentRecord.properties + ")")
component_cache[componentRecord.base_component_id].code_id = componentRecord.id
//debugger
}


var addP = "'" + componentRecord.code_id + "', '" + useDb + "', "
//alert("data: " + addP);
if (localAppshareApp) {

if (sqlitedata) {
var b = base64ToUint8Array(sqlitedata)
localSqliteDb = new SQL.Database(b);
} else {
var eds = saveHelper.getValueOfCodeString(componentRecord.code, "sqlite",")//sqlite")
if (eds){
for (var te = 1; te < eds.length ; te = te + 2) {
var sqlStatements = eds[te]
//console.log(`${te}`)
for (var te2 = 0; te2 < sqlStatements.length ; te2 ++) {
var sqlStatement = sqlStatements[te2]
//console.log(`   SQL ${te2}: ${sqlStatement}`)
localSql(sqlStatement)
}

}
}
}
//alert(eds.length)
}


var trcode2 = "(" + componentRecord.code + ")"

var component_type = saveHelper.getValueOfCodeString(componentRecord.code, "component_type")
if ((component_type != "SYSTEM") &&
(component_type != "VB"))
{
trcode2 = getDebugCode(componentRecord.base_component_id,  trcode2)
} else if (component_type == "VB") {

console.log("Component to index: " + componentRecord.base_component_id)
indexComponent(  componentRecord.base_component_id  )
}


trcode2 = trcode2.toString().replaceAll("sql[(]","await rxsql(" + addP)
trcode2 = trcode2.toString().replaceAll("sql1[(]","await rxsql1(" + addP)
trcode2 = trcode2.toString().replaceAll("sqlFirstCol[(]","await rxsqlFirstCol(" + addP)
trcode2 = trcode2.toString().replaceAll("sqlFirstCol1[(]","await rxsqlFirstCol1(" + addP)




var kkk = saveHelper.getValueOfCodeString(trcode2.toString(), "keycloak",")//keycloak")
if (kkk) {
//alert(JSON.stringify(kkk,null,2))
if (!kkk.clientId) {
kkk.clientId = kkk.resource
}

//alert(editingAppId)
if (editingAppId && window.location.href && (window.location.href.indexOf("/edit/") == -1)) {
window.location.href = "/edit/" + editingAppId;
} else {
loadKeycloak(
kkk
)
}
}


//Don't run any server code
if ( (componentRecord.base_component_id == base_component_id) && (trcode2.toString().includes("only_run_on_server(true)"))) {

mainMoonApp.console_output  = ""
mainMoonApp.is_gui_app      = false
if (callbackFn) {
callbackFn({})
queuedResponses[seq_no] = null
}
queuedResponses[seq_no]     = null

} else if (trcode2.toString().includes("only_run_on_server(true)")) {

} else if ( (componentRecord.base_component_id == base_component_id) && (!trcode2.toString().includes("Vue."))) {
mainMoonApp.console_output = ""
mainMoonApp.is_gui_app = false

console.log = function() {
if (isValidObject(mainMoonApp.console_output)) {
if (document.getElementById("console_id")) {
document.getElementById("console_id").style.color="black"
}
for (var a=0; a < arguments.length ; a++) {
mainMoonApp.console_output += arguments[a] + " "
}
mainMoonApp.console_output +=
`
`
}
}
//console.log("Code to run: " + trcode2)
var fnfn = eval( trcode2  )

setTimeout(async function() {
if (trcode2.indexOf("async ")  == -1) {
var fnfnRes = fnfn(args)
if (callbackFn) {
callbackFn(fnfnRes)
queuedResponses[seq_no] = null
}

} else {
var fnfnRes = await fnfn(args)
if (callbackFn) {
callbackFn(fnfnRes)
queuedResponses[seq_no] = null
}
}
},100)
} else {
//console.log("Code to run: " + trcode2)
var fnfn = eval( trcode2  )


if (trcode2.indexOf("async ")  == -1) {
var fnfnRes = fnfn(args)
if (callbackFn) {
callbackFn(fnfnRes)
queuedResponses[seq_no] = null
}

} else {
var fnfnRes = await fnfn(args)
if (callbackFn) {
callbackFn(fnfnRes)
queuedResponses[seq_no] = null
}
}
}




} catch (err) {
alert(err)

hideProgressBar()
}
}






/*
creates the following:

linked_properties = {
horiz_scroll_control: {
outgoing: {
me: {
value: {
label_control: {text: true}
}
},
them: {
label_control: {
text: {value: true}
}
}
}

}
,
input_control: {
outgoing: {
me: {
value: {
label_control: {text: true}
}
},
them: {
label_control: {
text: {value: true}
}
}
}
}
,
label_control: {

outgoing: {
me: {
leftX: {
horiz_scroll_control: {value: true}
},
topY: {
horiz_scroll_control: {value: true}
},
text: {
input_control: {value: true}
}
},
them: {
horiz_scroll_control: {
value: {text: true, leftX: true, topY: true}
},
input_control: {
value: {text: true}
},
timer_control: {
counter: {
text: true, leftX: true, topY: true
}
}

}
}
,
incoming: {
me: {
leftX: {
horiz_scroll_control: {value: true}
},
topY: {
horiz_scroll_control: {value: true}
},
text: {
input_control: {value: true},
timer_control: {counter: true}
}

},
them: {
horiz_scroll_control: {
value: {text: true, leftX: true, topY: true}
},
input_control: {
value: {text: true}
},
timer_control: {
counter: {
text: true, leftX: true, topY: true
}
}


}
}

}
}

*/


async function findComponentsImplementing(listOfProperties){
//aaa
let results = await callFunction(
{
driver_name: "findComponentsImplementing",
method_name: "findComponentsImplementing"  }
,{
properties: listOfProperties
})
return results
}

function indexComponent(typeName){
//return
linked_properties[typeName] = {
incoming: {
me: {

},
them: {

}

},
outgoing: {
me: {

},
them: {

}
}
}

if (typeName == "horiz_scroll_control") {
//debugger

}

for (let oneProperty of component_cache[typeName].properties) {
let propertyName = oneProperty.name
if (propertyName) {

//
// match my ACCEPT TYPES with TYPES coming from other components
//
if (oneProperty.accept_types) {
let acceptTypes = Object.keys(oneProperty.accept_types)
for (let acceptType of acceptTypes) {
//console.log("    " + acceptType)
for (let otherComponentName of Object.keys(component_cache)){
if (otherComponentName == "database_control") {
//debugger

}
if (otherComponentName != typeName) {
if (component_cache[otherComponentName]) {
if (component_cache[otherComponentName].properties) {
let otherProperties = component_cache[otherComponentName].properties
for (let otherProperty of otherProperties){
if (otherProperty.types) {
for (let otherPropertyType of Object.keys(otherProperty.types)){
if (otherPropertyType == acceptType) {
//debugger
//console.log("        Found Match for " + acceptType)
if (!linked_properties[typeName].incoming.them[otherComponentName]) {
linked_properties[typeName].incoming.them[otherComponentName]={}
}
if (! linked_properties[typeName].incoming.them[otherComponentName][otherProperty.id] ) {
linked_properties[typeName].incoming.them[otherComponentName][otherProperty.id] = {}
}
linked_properties[typeName].incoming.them[otherComponentName][otherProperty.id][oneProperty.id] = true

if (!linked_properties[typeName].incoming.me[oneProperty.id]) {
linked_properties[typeName].incoming.me[oneProperty.id]={}
}
if (!linked_properties[typeName].incoming.me[oneProperty.id][otherComponentName]) {
linked_properties[typeName].incoming.me[oneProperty.id][otherComponentName]={}
}

linked_properties[typeName].incoming.me[oneProperty.id][otherComponentName][otherProperty.id] = true










if (!linked_properties[otherComponentName].outgoing.them[typeName]) {
linked_properties[otherComponentName].outgoing.them[typeName] = {}
}
if (!linked_properties[otherComponentName].outgoing.them[typeName][oneProperty.id]) {
linked_properties[otherComponentName].outgoing.them[typeName][oneProperty.id] = {}
}
if (!linked_properties[otherComponentName].outgoing.them[typeName][oneProperty.id][otherProperty.id]) {
linked_properties[otherComponentName].outgoing.them[typeName][oneProperty.id][otherProperty.id] = true
}



if (!linked_properties[otherComponentName].outgoing.me) {
linked_properties[otherComponentName].outgoing.me = {}
}
if (!linked_properties[otherComponentName].outgoing.me[otherProperty.id]) {
linked_properties[otherComponentName].outgoing.me[otherProperty.id] = {}
}
if (!linked_properties[otherComponentName].outgoing.me[otherProperty.id][typeName]) {
linked_properties[otherComponentName].outgoing.me[otherProperty.id][typeName] = {}
}
if (!linked_properties[otherComponentName].outgoing.me[otherProperty.id][typeName][oneProperty.id]) {
linked_properties[otherComponentName].outgoing.me[otherProperty.id][typeName][oneProperty.id] = true
}



}
}
}
}
}
}

}
}

}
}




//
// match my TYPES with ACCEPT_TYPES to other components
//
if (oneProperty.types) {
let types = Object.keys(oneProperty.types)
for (let myType of types) {
//console.log("    " + myType)
for (let otherComponentName of Object.keys(component_cache)){
if (otherComponentName == "table_control") {
//debugger
}
if (otherComponentName != typeName) {
if (component_cache[otherComponentName]) {
if (component_cache[otherComponentName].properties) {
let otherProperties = component_cache[otherComponentName].properties
for (let otherProperty of otherProperties){
if (otherProperty.accept_types) {
for (let otherPropertyAcceptType of Object.keys(otherProperty.accept_types)){
if (otherPropertyAcceptType == myType) {
//debugger
//console.log("        Found Match for " + myType)
if (!linked_properties[typeName].outgoing.them[otherComponentName]) {
linked_properties[typeName].outgoing.them[otherComponentName]={}
}
if (!linked_properties[typeName].outgoing.them[otherComponentName][otherProperty.id]) {
linked_properties[typeName].outgoing.them[otherComponentName][otherProperty.id] = {}
}
linked_properties[typeName].outgoing.them[otherComponentName][otherProperty.id][oneProperty.id] = true

if (!linked_properties[typeName].outgoing.me) {
linked_properties[typeName].outgoing.me = {}
}
if (!linked_properties[typeName].outgoing.me[oneProperty.id]) {
linked_properties[typeName].outgoing.me[oneProperty.id] = {}
}

if (!linked_properties[typeName].outgoing.me[oneProperty.id][otherComponentName]) {
linked_properties[typeName].outgoing.me[oneProperty.id][otherComponentName] = {}
}
linked_properties[typeName].outgoing.me[oneProperty.id][otherComponentName][otherProperty.id] = true




if (!linked_properties[otherComponentName].incoming.them[typeName]) {
linked_properties[otherComponentName].incoming.them[typeName]={}
}
if (!linked_properties[otherComponentName].incoming.them[typeName][oneProperty.id]) {
linked_properties[otherComponentName].incoming.them[typeName][oneProperty.id]={}
}
if (!linked_properties[otherComponentName].incoming.them[typeName][oneProperty.id][otherProperty.id]) {
linked_properties[otherComponentName].incoming.them[typeName][oneProperty.id][otherProperty.id] = true
}




if (!linked_properties[otherComponentName].incoming.me) {
linked_properties[otherComponentName].incoming.me={}
}
if (!linked_properties[otherComponentName].incoming.me[otherProperty.id]) {
linked_properties[otherComponentName].incoming.me[otherProperty.id]={}
}
if (!linked_properties[otherComponentName].incoming.me[otherProperty.id][typeName]) {
linked_properties[otherComponentName].incoming.me[otherProperty.id][typeName] = {}
}
if (!linked_properties[otherComponentName].incoming.me[otherProperty.id][typeName][oneProperty.id]) {
linked_properties[otherComponentName].incoming.me[otherProperty.id][typeName][oneProperty.id] = true
}


}
}
}
}
}
}

}
}

}
}



}
}

}
var listElm = null
var params = {}

var autoScroll = false;
var autoId = 0;
var nextItem = 1;
var wait_and_select_app = null





function onscrolled() {
if (mousedown) {
autoScroll = false;
//select_card(-1)
//console.log("onscroll")
}
};
var mousedown=false;
function onemousedown() {
//console.log("onmousedown")
mousedown = true
};
function onemouseup() {
//console.log("onmouseup")
mousedown = false
};



function closeCard() {
autoScroll = false
setTimeout(async function(){
await select_card(-1)
},200)
}


function alj(jj) {
alert(JSON.stringify(jj,null,2))
}



function isValidObject(variable){
if ((typeof variable !== 'undefined') && (variable != null)) {
return true
}
return false
}
async function callDriverMethod2(findComponentArgs, args, callbackFn) {
//console.log(`online: ${online}`)
//console.log(`function callDriverMethod2(findComponentArgs, args, callbackFn) {`)
var seqNum = queuedBrowserResponseSeqNum ++;
queuedResponses[seqNum] = callbackFn;
callDriverMethodArgs[seqNum] = args


if (isStaticHtmlPageApp && findComponentArgs.base_component_id && finderToCachedCodeMapping[findComponentArgs.base_component_id]) {
//alert("Reading app from cache: " + findComponentArgs.base_component_id)
var newDataCodeId = finderToCachedCodeMapping[findComponentArgs.base_component_id]
var newData       = cachedCode[newDataCodeId]
newData.seq_num = seqNum
await checkLibs(newData)
} else {
//console.log(`  sendToServerViaWebSocket`)
//debugger
sendToServerViaWebSocket({
message_type: "callDriverMethod",
find_component: findComponentArgs,
args: args,
seqNum: seqNum
});
}
}
async function callDriverMethod(findComponentArgs, args, callbackFn) {
//console.log(`online: ${online}`)
var promise = new Promise(async function(returnfn) {
if (online) {
var gg = await callDriverMethod2(findComponentArgs, args, callbackFn)
returnfn(gg);
} else {
console.log(`callDriverMethod timeout: calling again`)

setTimeout(async function() {
var rr = await callDriverMethod(findComponentArgs, args, callbackFn)
returnfn(rr)
},2000)
}
})
var ret = await promise
return ret
}





//------------------------------------------------------------------------------
//
//                                 loadV2
//
// Dynamically loads a component class into the currently running system.
//
//
//------------------------------------------------------------------------------
async function loadV2( baseComponentIds, args ) {
//
// Always expect a list of "baseComponentIds" which will
// be used to identify the type of the components to load.
// If we receive only a single "baseComponentId" then turn
// it into a list
//
if (!Array.isArray(baseComponentIds)) {
baseComponentIds = [baseComponentIds]
}


//
// For static HTML pages (ie: just HTML , with no Yazz engine)
//
var componentsIdToLoad = []
var loadedStatic = false
if (isStaticHtmlPageApp) {
for (var tt=0; tt < baseComponentIds.length; tt++) {
var componentId = baseComponentIds[tt]
dev_app_component_loaded[componentId] = true
if (isStaticHtmlPageApp && finderToCachedCodeMapping[ componentId ] && (!component_loaded[componentId])) {
//console.log("loadV2: 2")
component_loaded[componentId] = true
//alert("Reading app from cache: " + findComponentArgs.base_component_id)
var newDataCodeId = finderToCachedCodeMapping[ componentId ]
var newData       = cachedCode[ newDataCodeId ]
var properties = saveHelper.getValueOfCodeString(newData.value.code, "properties",")//properties")
if (properties) {
if (isValidObject(newData.value)) {
//alert(properties)
//var propee = eval("(" + properties + ")")
newData.value.properties = JSON.stringify(properties)
}
}

await checkLibsV2(newData.value, args)
loadedStatic = true
}
}
}

//
// For Dynamic HTML pages HTML pages (has access to the Yazz engine)
//
if (!loadedStatic) {
// Find out which components need to be loaded
for (var tt=0; tt < baseComponentIds.length; tt++) {
var componentId = baseComponentIds[tt]
if (!component_loaded[componentId]) {
component_loaded[componentId] = true
componentsIdToLoad.push(componentId)
}
}


var vcount = 0
if (componentsIdToLoad.length > 0) {
var promise = new Promise(returnfn => {
var seqNum = queuedBrowserResponseSeqNum ++;
queuedResponses[seqNum] = function(response) {
returnfn({})
};

if (!online) {
setTimeout(function() {
sendToServerViaWebSocket({
message_type:    "loadUiComponent",
find_components:  {base_component_ids: componentsIdToLoad},
args:             args,
seq_num:          seqNum
});
},2000)
} else {
sendToServerViaWebSocket({
message_type:    "loadUiComponent",
find_components:  {base_component_ids: componentsIdToLoad},
args:             args,
seq_num:          seqNum
});
}

// ****************************************************************************
// the following line was removed as it caused "Edit app" to fail. Why? I don't know
//setTimeout(
//    function() {
//        returnfn({})
//        },200
//    )
// ****************************************************************************

})

var ret = await promise
return ret
}
}


return {}
}





//------------------------------------------------------------------------------
//
//                                 loadV3
//
// Dynamically loads a component class into the currently running system. V3
// has the ability to load components via IPFS as well
//
//
//------------------------------------------------------------------------------

async function loadV3( baseComponentItems, args ) {
//
// Always expect a list of "baseComponentIds" which will
// be used to identify the type of the components to load.
// If we receive only a single "baseComponentId" then turn
// it into a list
//
if (!Array.isArray(baseComponentItems)) {
baseComponentItems = [baseComponentItems]
}


//
// Turn the list of "baseComponentIds" which is historically
// a list of String IDs into a list of tuples, so:
//
// [ "label" , "button" , {ipfs: "1f"} ]
//
// :turns into:
//
// [ {baseComponentId: "label"} , {baseComponentId: "button"} , {ipfs: "1f"} ]
//
let componentsItemsToLoadV3 = []
for (let tt=0; tt < baseComponentItems.length; tt++) {
let componentItem = baseComponentItems[tt]
if (typeof componentItem == 'string') {
componentsItemsToLoadV3.push({baseComponentId: componentItem})
} else {
componentsItemsToLoadV3.push(componentItem)
}
}

//
// For static HTML pages (ie: just HTML , with no Yazz engine)
//
let loadedStatic = false
if (isStaticHtmlPageApp) {
for (let tt=0; tt < componentsItemsToLoadV3.length; tt++) {
let componentId = componentsItemsToLoadV3[tt].baseComponentId
dev_app_component_loaded[componentId] = true
if (isStaticHtmlPageApp && finderToCachedCodeMapping[ componentId ] && (!component_loaded[componentId])) {
//console.log("loadV2: 2")
component_loaded[componentId] = true
//alert("Reading app from cache: " + findComponentArgs.base_component_id)
let newDataCodeId = finderToCachedCodeMapping[ componentId ]
let newData       = cachedCode[ newDataCodeId ]
let properties = saveHelper.getValueOfCodeString(newData.value.code, "properties",")//properties")
if (properties) {
if (isValidObject(newData.value)) {
//alert(properties)
//var propee = eval("(" + properties + ")")
newData.value.properties = JSON.stringify(properties)
}
}

await checkLibsV2(newData.value, args)
loadedStatic = true
}
}
}

//
// For Dynamic HTML pages (which have access to the Yazz engine)
//
let componentsItemsToLoad = []
if (!loadedStatic) {
//
// Find out which components need to be loaded
// in
//
for (let tt=0; tt < componentsItemsToLoadV3.length; tt++) {
let componentId = componentsItemsToLoadV3[tt].baseComponentId
let componentItem = componentsItemsToLoadV3[tt]

if (!component_loaded[componentId]) {
component_loaded[componentId] = true
componentsItemsToLoad.push(componentItem)
}
}


let vcount = 0
if (componentsItemsToLoad.length > 0) {
let promise = new Promise(returnfn => {
let seqNum = queuedBrowserResponseSeqNum ++;
queuedResponses[seqNum] = function(response) {
returnfn({})
};

if (!online) {
setTimeout(function() {
sendToServerViaWebSocket({
message_type:    "loadUiComponentsV2",
find_components:  {items: componentsItemsToLoad},
args:             args,
seq_num:          seqNum
});
},2000)
} else {
sendToServerViaWebSocket({
message_type:    "loadUiComponentsV2",
find_components:  {items: componentsItemsToLoad},
args:             args,
seq_num:          seqNum
});
}

// ****************************************************************************
// the following line was removed as it caused "Edit app" to fail. Why? I don't know
//setTimeout(
//    function() {
returnfn({})
//        },200
//    )
// ****************************************************************************

})

let ret = await promise
return ret
}
}


return {}
}



async function callApp(findComponentArgs, args) {
var promise = new Promise(returnfn => {
callDriverMethod( findComponentArgs , args, function(result) {
returnfn(result) })
})

var ret = await promise
if (ret) {
if (ret.value) {
return ret.value
} else if (ret.error) {
throw ret.error
}
}

return ret

}

async function callFunction(findComponentArgs, args) {
return callApp(findComponentArgs, args)
}


function is_app(t) {

}
function uuidv4() {
return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
return v.toString(16);
});
}


function description(d) {

}
function base_component_id(d) {

}
function display_name(d) {

}
function created_timestamp(d) {

}

// this is a server side call but for some reason it gets evaluated
// when open a microservice which contains the "trace" function (Which
// is used for Jaeger OpenTracing)
function trace() {

}


async function rxsql(code_id,base_component_id, sqlcode, params) {
if (localAppshareApp) {
var results = localSql(sqlcode,params)
return results
} else {
var results = await callApp(
{
driver_name:    "systemFunctionAppSql",
method_name:    "sql"
}
,
{
sql:                sqlcode,
params:             params,
code_id:            code_id,
base_component_id:  base_component_id
})


return results
}
}

async function rxsql1(code_id,base_component_id,sqlcode, params) {
var x = await rxsql(code_id,base_component_id,sqlcode, params)
if (x && (x.length > 0)) {
return x[0]
} else {
return null
}
}



async function rxsqlFirstCol(code_id,base_component_id,sqlcode, params) {
var x = await rxsql(code_id,base_component_id,sqlcode, params)
if (x && (x.length > 0)) {
var colName = Object.keys(x[0])[0]
var ff = []
for (var tt=0; tt < x.length; tt++) {
ff.push(x[tt][colName])
}
return ff
} else {
return []
}
}

async function rxsqlFirstCol1(code_id,base_component_id,sqlcode, params) {
var x = await rxsqlFirstCol(code_id,base_component_id,sqlcode, params)
if (x && (x.length > 0)) {
return x[0]
} else {
return null
}
}

var appIntervalTimers = []
function appSetInterval(fnn,interval) {
var xx = setInterval(fnn,interval)
appIntervalTimers.push(xx)
}
function appClearIntervals() {
for(var i = 0; i < appIntervalTimers.length; i++){
clearInterval(appIntervalTimers[i]);
}
appIntervalTimers = []
}

function showProgressBar() {
mainMoonApp.show_loader = true
}
function hideProgressBar() {
mainMoonApp.show_loader = false
}

saveHelper = {

insertCodeString: function(code,st, vall ,optionalEnd) {
var endIndicator = ")"
if (optionalEnd) {
endIndicator = optionalEnd
}
var findd = st + "("
var startIndexOfComment = code.toString().indexOf("/*")
var startIndexOfFn = code.toString().indexOf("{")

if (startIndexOfFn != -1) {
if (startIndexOfComment == -1) {
code = code.toString().substring(0,startIndexOfFn + 1) + "\n/*\n*/\n" +
code.toString().substring(startIndexOfFn + 1)
startIndexOfComment = code.toString().indexOf("/*")
}
code = code.toString().substring(0,startIndexOfComment + 3) +
"" + st + "(" + JSON.stringify(vall,null,2).replace(new RegExp("\\*\\/", 'g'), "*\\/") + endIndicator + "\n" +
code.toString().substring(startIndexOfComment + 3)

}

return code

},






deleteCodeString: function(code,st ,optionalEnd) {
var endIndicator = ")"
if (optionalEnd) {
endIndicator = optionalEnd
}
var findd = st + "("
var codeStart = code.toString().indexOf(findd)
if (codeStart != -1) {
var codeEnd = codeStart + code.toString().substring(codeStart).indexOf(endIndicator)

code = code.toString().substring(0,codeStart) +
code.toString().substring(codeEnd + 1 + endIndicator.length)

return code
}
return code
},



getValueOfCodeString: function(code, st,optionalEnd) {
var endIndicator = ")"
if (optionalEnd) {
endIndicator = optionalEnd
}
var toFind = st + "("
if (code.toString().indexOf(toFind) != -1) {
var codeStart = code.toString().indexOf(toFind) + toFind.length
var codeEnd = codeStart + code.toString().substring(codeStart).indexOf(endIndicator)

code = code.toString().substring(codeStart, codeEnd)
var val = eval( "(" + code.toString() + ")")
return val

}
return null
}
}

function callAjax(url, callback){
var xmlhttp;
// compatible with IE7+, Firefox, Chrome, Opera, Safari
xmlhttp = new XMLHttpRequest();
xmlhttp.onreadystatechange = function(){
if (xmlhttp.readyState == 4 && xmlhttp.status == 200){
callback(xmlhttp.responseText);
}
}
xmlhttp.open("GET", url, true);
xmlhttp.send();
}

function callAjax2(url, options, callback){
var xmlhttp;
//debugger
if (options && options.params) {
url += "?"
let paramArray = Object.entries(options.params)
let ajaxParams = Array.from(paramArray, ([name, value]) => ({ name, value }));
ajaxParams.forEach(
function myFunction(entry, index, ajaxParams) {
//debugger
url += entry.name + "=" + encodeURIComponent(entry.value) + "&";
});
}
console.log("callAjax2 url = " + url)


// compatible with IE7+, Firefox, Chrome, Opera, Safari
xmlhttp = new XMLHttpRequest();
xmlhttp.onreadystatechange = function(){
if (xmlhttp.readyState == 4 && xmlhttp.status == 200){
callback(xmlhttp.responseText);
}
}
xmlhttp.open("GET", url, true);
xmlhttp.send();
}

function callAjaxPost(url, value, callback){
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function(){

if (xhr.readyState == 4 && xhr.status == 200){
callback(xhr.responseText);
}
}
xhr.open("POST", url, true);
xhr.setRequestHeader('Content-Type', 'application/json');
//debugger
let payload = JSON.stringify({
value: value
})
xhr.send(payload);
}

</script>
<script>

var keycloak = null
var keycloakJsonInUse = null
function logoutKeycloak() {
if (keycloak) {
keycloakJsonInUse = null
keycloak.logout()
}
}
var username="";
function compareValues(a, b) {

//if a and b aren't the same type, they can't be equal
if (typeof a !== typeof b) {
return false;
}

if (typeof a === 'object') {
var keysA = Object.keys(a).sort(),
keysB = Object.keys(b).sort();

//if a and b are objects with different no of keys, unequal
if (keysA.length !== keysB.length) {
return false;
}

//if keys aren't all the same, unequal
if (!keysA.every(function(k, i) { return k === keysB[i];})) {
return false;
}

//recurse on the values for each key
return keysA.every(function(key) {
//if we made it here, they have identical keys
return compareValues(a[key], b[key]);
});

//for primitives just use a straight up check
} else {
return a === b;
}
}
function loadKeycloak(keycloakJson) {
if (keycloakJsonInUse) {
//debugger
if (compareValues(keycloakJsonInUse, keycloakJson)) {
return
}
}
var script = document.createElement('script');
script.onload = function () {
keycloak = Keycloak(keycloakJson);
keycloakJsonInUse = JSON.parse(JSON.stringify(keycloakJson))
keycloak.init(
{
onLoad: 'login-required' ,
checkLoginIframe: false
}
).success(function(authenticated) {
//alert(authenticated ? 'authenticated' : 'not authenticated');

if (authenticated) {
console.log("keycloak.subject:" + keycloak.subject)
console.log("Loading profile 1")
keycloak.loadUserProfile(function() {
console.log("Loading profile 2")
username = keycloak.profile.username;
console.log("keycloak username:" + username)
})
}

}).error(function(err) {

console.log('Failed to initialize keycloak: ' + err);
});
};
script.src = keycloakJson["auth-server-url"] + "/js/keycloak.js";
document.head.appendChild(script);
}

/*
loadKeycloak(
{
"realm": "yazz",
"auth-server-url": "http://127.0.0.1:8080/auth",
"ssl-required": "external",
"resource": "yazz",
"clientId": "yazz",
"public-client": true,
"confidential-port": 0,
"enable-cors": true
}
)
*/


console.log("Start debugger")
var thecode = `
(function xx() {
var a=10
if(runLine == 1) {return}
a=a+1
console.log(a)
if(runLine == 2) {return}
a=a+1
console.log(a)
if(runLine == 3) {return}
a=a+1
console.log(a)

})()
`
fullCode = async function(cc) {
eval(cc)
}

var runLine=2;
async function runn() {
fullCode(thecode)
}
runn()
//var rt=esprima.parse(thecode,{tolerant: true , loc:true, range: true, attachComment: false})
//console.log(JSON.stringify(rt,null,2))

let globalStartTimer = new Date().getTime()
let globalEndTimer = new Date().getTime()
let globalTimerCounter = 0
function resetTimer(messageToStart) {
console.log("Starting timer for: " + messageToStart)
globalStartTimer = new Date().getTime()
globalTimerCounter = 0
}

function showTimer(optionalMessage) {
globalEndTimer = new Date().getTime()
globalTimerCounter ++
let theTimerText = optionalMessage
if (!theTimerText) {
theTimerText = "" + globalTimerCounter
}
console.log("    Elapsed time in milliseconds: " + theTimerText + " : "+ (globalEndTimer - globalStartTimer))
}

function getUrlParam(paramName) {

var pairs = document.URL.split('?')
.pop()
.split('&');

for (var i = 0, p; i < pairs.length; i++) {
p = pairs[i].split('=');
if (p[0] == paramName) {
return p[1];
}
}

return null;
}




function msToTime(duration, options) {
if (!duration) {
return ""
}
let ret = new Date(duration).toUTCString()

let ret2 = ""

let currentTime = new Date().getTime()

let timeDiffSecs = (currentTime - duration) / 1000
let timeDiffMins = timeDiffSecs / 60
let timeDiffHours = timeDiffMins / 60
let timeDiffDays = timeDiffHours / 24
if (timeDiffSecs < 60) {
ret2 = ret2 + "a few seconds ago"
} else if (timeDiffMins < 10) {
ret2 = ret2 + "a few minutes ago"
} else if (timeDiffMins < 30) {
ret2 = ret2 + "less than half an hour ago"
} else if (timeDiffMins < 60) {
ret2 = ret2 + "under an hour ago"
} else if (timeDiffHours < 10) {
ret2 = ret2 + "a few hours ago"
} else if (timeDiffDays < 2) {
ret2 = ret2 + "yesterday"
} else if (timeDiffDays < 10) {
ret2 = ret2 + "a few days ago"
}

if (options && options.timeOnly) {
} else if (options && options.shortOnly) {
ret = ret2
} else {
ret =  ret2 +  " (" + ret + ")"
}

return ret
}

function capitalizeFirstLetter(string) {
return string.charAt(0).toUpperCase() + string.slice(1);
}


function timeDiffLater(time1, time2) {
//debugger
if (!time1) {
return ""
}
if (!time2) {
return ""
}
let duration = time2 - time1
let ret2 = ""

let timeDiffSecs = duration / 1000
let timeDiffMins = timeDiffSecs / 60
let timeDiffHours = timeDiffMins / 60
let timeDiffDays = timeDiffHours / 24
if (duration < 100) {
ret2 = ret2 + "a few milliseconds"
} else if (duration < 600) {
ret2 = ret2 + "half a second"
} else if (duration < 1000) {
ret2 = ret2 + "under a second"
} else if (duration < 1400) {
ret2 = ret2 + "about a second"
} else if (timeDiffSecs < 60) {
ret2 = ret2 + "a few seconds"
} else if (timeDiffMins < 10) {
ret2 = ret2 + "a few minutes"
} else if (timeDiffMins < 60) {
ret2 = ret2 + "little under an half an hour"
} else if (timeDiffMins < 60) {
ret2 = ret2 + "little under an hour"
} else if (timeDiffHours < 10) {
ret2 = ret2 + "a few hours"
} else if (timeDiffDays < 10) {
ret2 = ret2 + "a few days"
}


let ret = "after " + ret2

return ret
}


async function getFromYazzReturnJson(urlToget, urlParams) {
let openfileurl = "http" + (($HOSTPORT == 443) ? "s" : "") + "://" + $HOST + urlToget + "?" +
new URLSearchParams(urlParams)

let promise = new Promise(async function (returnfn) {
fetch(openfileurl, {
method: 'get',
credentials: "include"
})
.then((response) => response.json())
.then(async function (responseJson) {
returnfn(responseJson)
})
.catch(err => {
//error block
returnfn()
})
})
retval = await promise
return retval
}




function getCookie(name) {
const value = `; ${document.cookie}`;
const parts = value.split(`; ${name}=`);
if (parts.length === 2) return parts.pop().split(';').shift();
}

function getYazzCookie() {
return getCookie("yazz")
}
</script>
</body>
</html>
